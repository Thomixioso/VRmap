<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR 2D Satelitn√≠ Mapa - Three.js</title>
    
    <!-- Leaflet pro 2D mapu -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- html2canvas pro DOM -> Canvas konverzi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #vrCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Hidden mapy container pro VR texturu */
        #hiddenMapContainer {
            position: absolute;
            left: -3000px;
            top: -3000px;
            width: 1200px;
            height: 800px;
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            overflow: hidden;
            border-radius: 12px;
        }

        #hiddenMapContainer #map {
            width: 75%;
            height: 100%;
            float: left;
        }

        #hiddenMapContainer .vr-controls {
            width: 25%;
            height: 100%;
            float: right;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #hiddenMapContainer .control-group {
            margin-bottom: 12px;
        }

        #hiddenMapContainer .control-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 11px;
            color: #e0e0e0;
            font-weight: 500;
        }

        #hiddenMapContainer .control-group input[type="checkbox"] {
            margin-right: 6px;
            transform: scale(1.0);
        }

        #hiddenMapContainer .control-group select,
        #hiddenMapContainer .control-group input[type="range"],
        #hiddenMapContainer .control-group input[type="color"],
        #hiddenMapContainer .control-group input[type="number"],
        #hiddenMapContainer .control-group input[type="text"] {
            width: 100%;
            padding: 4px 6px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 10px;
            margin-bottom: 4px;
        }

        #hiddenMapContainer .control-group input[type="range"] {
            height: 5px;
            padding: 0;
        }

        #hiddenMapContainer .control-group input[type="color"] {
            height: 20px;
            padding: 0;
        }

        #hiddenMapContainer button {
            width: 100%;
            padding: 6px 8px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        #hiddenMapContainer button:hover {
            background: linear-gradient(135deg, #357abd, #2c5aa0);
        }

        #hiddenMapContainer button.secondary {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        #hiddenMapContainer h3 {
            color: #4a90e2;
            margin-bottom: 8px;
            font-size: 12px;
        }

        #hiddenMapContainer .info-text {
            font-size: 9px;
            line-height: 1.3;
            color: #ccc;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            border-radius: 3px;
            margin-top: 8px;
        }

        /* UI Overlay pro VR informace */
        .vr-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
        }

        .vr-ui h3 {
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .vr-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #4a90e2;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            z-index: 1001;
        }

        .vr-toggle:hover {
            background: #357abd;
        }

        /* Leaflet styling pro VR */
        #hiddenMapContainer .leaflet-control-zoom,
        #hiddenMapContainer .leaflet-control-attribution {
            font-size: 9px !important;
        }

        #hiddenMapContainer .leaflet-popup-content {
            color: #333 !important;
            font-size: 10px !important;
        }

        #hiddenMapContainer .leaflet-popup-content-wrapper {
            border-radius: 4px !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="vrCanvas"></canvas>
        
        <div class="vr-ui">
            <h3>üåç VR 2D Mapa</h3>
            <p>Kliknƒõte na mapu ve VR prostoru pro GPS sou≈ôadnice.</p>
            <p><strong>Ovl√°d√°n√≠:</strong></p>
            <p>‚Ä¢ My≈° = ot√°ƒçen√≠ kamery<br>
            ‚Ä¢ WASD = pohyb<br>
            ‚Ä¢ Klik na mapu = GPS<br>
            ‚Ä¢ Scroll = zoom</p>
            <div id="gpsDisplay" style="margin-top: 10px; padding: 8px; background: rgba(74, 144, 226, 0.2); border-radius: 4px;">
                <strong>GPS:</strong> <span id="gpsCoords">Kliknƒõte na mapu</span>
            </div>
        </div>
        
        <button class="vr-toggle" onclick="toggleVR()">Vstoupit do VR</button>
    </div>
    
    <!-- Hidden container pro VR texturu -->
    <div id="hiddenMapContainer">
        <div id="map"></div>
        <div class="vr-controls">
            <h3>üåç VR Mapa</h3>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="countries" checked> Hranice st√°t≈Ø
                </label>
                <label for="borderColor">Barva hranic:</label>
                <input type="color" id="borderColor" value="#ffffff">
            </div>
            
            <div class="control-group">
                <label for="overlayLayer">Overlay:</label>
                <select id="overlayLayer">
                    <option value="none">≈Ω√°dn√°</option>
                    <option value="topo" selected>üó∫Ô∏è Topo</option>
                    <option value="streets">üèôÔ∏è Ulice</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="overlayOpacity">Mix: <span id="opacityValue">70%</span></label>
                <input type="range" id="overlayOpacity" min="0" max="100" value="70">
            </div>
            
            <div class="control-group">
                <h3>üìç Marker</h3>
                <input type="number" id="markerLat" step="0.0001" placeholder="≈†√≠≈ôka">
                <input type="number" id="markerLng" step="0.0001" placeholder="D√©lka">
                <input type="text" id="markerText" placeholder="N√°zev">
                <button onclick="addMarker()">P≈ôidat</button>
                <button onclick="clearMarkers()" class="secondary">Smazat</button>
            </div>
            
            <div class="control-group">
                <label for="baseBrightness">Jas: <span id="baseBrightnessValue">100%</span></label>
                <input type="range" id="baseBrightness" min="50" max="150" value="100">
                
                <label for="baseContrast">Kontrast: <span id="baseContrastValue">100%</span></label>
                <input type="range" id="baseContrast" min="50" max="150" value="100">
            </div>
            
            <div class="info-text">
                <strong>VR Ovl√°d√°n√≠:</strong><br>
                ‚Ä¢ VR Controller = pointer<br>
                ‚Ä¢ Trigger = klik<br>
                ‚Ä¢ Grip = drag<br><br>
                <strong>GPS:</strong> <span id="gpsInfo">Kliknƒõte na mapu</span>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Spou≈°t√≠m VR 2D mapu s Three.js...');
        
        // Glob√°ln√≠ promƒõnn√©
        let scene, camera, renderer, vrMapPlane;
        let vrMap = null;
        let markersGroup = null;
        let markerCount = 0;
        let baseLayer = null;
        let mapTexture = null;
        let isVRMode = false;

        // Three.js inicializace
        function initThreeJS() {
            // Sc√©na
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);

            // Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);

            // Renderer
            const canvas = document.getElementById('vrCanvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Osvƒõtlen√≠
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            // Ovl√°d√°n√≠ my≈°√≠
            setupControls();

            console.log('‚úÖ Three.js inicializov√°no');
        }

        // Kontroly my≈°i pro kameru
        function setupControls() {
            let mouseX = 0, mouseY = 0;
            let mouseXOnMouseDown = 0, mouseYOnMouseDown = 0;
            let targetRotationX = 0, targetRotationY = 0;
            let targetRotationOnMouseDownX = 0, targetRotationOnMouseDownY = 0;
            let isMouseDown = false;

            document.addEventListener('mousedown', (event) => {
                event.preventDefault();
                isMouseDown = true;
                mouseXOnMouseDown = event.clientX - window.innerWidth / 2;
                mouseYOnMouseDown = event.clientY - window.innerHeight / 2;
                targetRotationOnMouseDownX = targetRotationX;
                targetRotationOnMouseDownY = targetRotationY;
            });

            document.addEventListener('mouseup', (event) => {
                event.preventDefault();
                isMouseDown = false;
            });

            document.addEventListener('mousemove', (event) => {
                mouseX = event.clientX - window.innerWidth / 2;
                mouseY = event.clientY - window.innerHeight / 2;

                if (isMouseDown) {
                    targetRotationY = targetRotationOnMouseDownY + (mouseX - mouseXOnMouseDown) * 0.02;
                    targetRotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, 
                        targetRotationOnMouseDownX + (mouseY - mouseYOnMouseDown) * 0.02));
                }
            });

            // WASD pohyb
            const keys = {};
            document.addEventListener('keydown', (event) => keys[event.code] = true);
            document.addEventListener('keyup', (event) => keys[event.code] = false);

            function updateCamera() {
                // Rotace kamery
                camera.rotation.x += (targetRotationX - camera.rotation.x) * 0.1;
                camera.rotation.y += (targetRotationY - camera.rotation.y) * 0.1;

                // Pohyb WASD
                const speed = 0.1;
                if (keys['KeyW']) camera.position.z -= speed;
                if (keys['KeyS']) camera.position.z += speed;
                if (keys['KeyA']) camera.position.x -= speed;
                if (keys['KeyD']) camera.position.x += speed;
                if (keys['KeyQ']) camera.position.y += speed;
                if (keys['KeyE']) camera.position.y -= speed;

                requestAnimationFrame(updateCamera);
            }
            updateCamera();
        }

        // Inicializace Leaflet mapy
        function initializeLeafletMap() {
            console.log('üó∫Ô∏è Inicializuji Leaflet mapu...');
            
            vrMap = L.map('map', {
                center: [49.75, 15.5], // St≈ôed ƒåR
                zoom: 4,
                minZoom: 3,
                maxZoom: 8,
                zoomControl: true,
                attributionControl: true,
                worldCopyJump: true
            });

            // Markery
            markersGroup = L.layerGroup().addTo(vrMap);

            // Podkladov√° mapa - OpenStreetMap
            baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                minZoom: 3,
                maxZoom: 8,
                className: 'base-layer-filtered'
            });
            baseLayer.addTo(vrMap);

            // Event listeners pro mapu
            vrMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                // Update UI
                document.getElementById('gpsInfo').textContent = `${lat}, ${lng}`;
                document.getElementById('gpsCoords').textContent = `${lat}, ${lng}`;
                document.getElementById('markerLat').value = lat;
                document.getElementById('markerLng').value = lng;
                
                console.log(`üìç GPS: ${lat}, ${lng}`);
            });

            // Vzorov√© markery
            const sampleMarkers = [
                {lat: 50.0755, lng: 14.4378, text: "Praha"},
                {lat: 49.1951, lng: 16.6068, text: "Brno"},
                {lat: 49.7384, lng: 13.3736, text: "Plze≈à"}
            ];

            sampleMarkers.forEach(point => {
                const marker = L.marker([point.lat, point.lng]).addTo(markersGroup);
                marker.bindPopup(`
                    <div style="color: #333; font-family: Arial, sans-serif;">
                        <strong style="color: #4a90e2;">${point.text}</strong><br>
                        <small>GPS: ${point.lat}, ${point.lng}</small>
                    </div>
                `);
                markerCount++;
            });

            console.log('‚úÖ Leaflet mapa inicializov√°na');
            
            // Spustit aktualizaci textury
            setTimeout(updateMapTexture, 2000);
        }

        // Aktualizace textury mapy
        async function updateMapTexture() {
            try {
                const mapContainer = document.getElementById('hiddenMapContainer');
                
                // html2canvas konverze
                const canvas = await html2canvas(mapContainer, {
                    width: 1200,
                    height: 800,
                    scale: 1,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#1a1a1a'
                });

                // Vytvo≈ôen√≠ Three.js textury
                if (mapTexture) mapTexture.dispose();
                mapTexture = new THREE.CanvasTexture(canvas);
                mapTexture.needsUpdate = true;

                // Aplikace na plane
                if (!vrMapPlane) {
                    const geometry = new THREE.PlaneGeometry(8, 6);
                    const material = new THREE.MeshBasicMaterial({ 
                        map: mapTexture,
                        transparent: true
                    });
                    
                    vrMapPlane = new THREE.Mesh(geometry, material);
                    vrMapPlane.position.set(0, 0, 0);
                    scene.add(vrMapPlane);

                    // Raycaster pro klik√°n√≠
                    setupRaycasting();
                } else {
                    vrMapPlane.material.map = mapTexture;
                    vrMapPlane.material.needsUpdate = true;
                }

                console.log('‚úÖ Mapa textura aktualizov√°na');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi aktualizaci textury:', error);
            }
        }

        // Raycasting pro interakci s mapou
        function setupRaycasting() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            renderer.domElement.addEventListener('click', (event) => {
                // P≈ôevod sou≈ôadnic my≈°i
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(vrMapPlane);

                if (intersects.length > 0) {
                    const intersect = intersects[0];
                    const uv = intersect.uv;
                    
                    // P≈ôevod UV sou≈ôadnic na sou≈ôadnice mapy
                    simulateMapClick(uv.x, 1 - uv.y);
                }
            });
        }

        // Simulace kliknut√≠ na mapu
        function simulateMapClick(uvX, uvY) {
            const mapElement = document.getElementById('map');
            const rect = mapElement.getBoundingClientRect();
            
            const x = uvX * rect.width;
            const y = uvY * rect.height;
            
            // Vytvo≈ôen√≠ syntetick√©ho click eventu
            const clickEvent = new MouseEvent('click', {
                clientX: rect.left + x,
                clientY: rect.top + y,
                bubbles: true
            });
            
            mapElement.dispatchEvent(clickEvent);
        }

        // Funkce pro markery
        window.addMarker = function() {
            const lat = parseFloat(document.getElementById('markerLat').value);
            const lng = parseFloat(document.getElementById('markerLng').value);
            const text = document.getElementById('markerText').value || `Marker ${++markerCount}`;
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Zadejte platn√© GPS sou≈ôadnice!');
                return;
            }
            
            const marker = L.marker([lat, lng]).addTo(markersGroup);
            marker.bindPopup(`
                <div style="color: #333; font-family: Arial, sans-serif;">
                    <strong style="color: #4a90e2;">${text}</strong><br>
                    <small>GPS: ${lat.toFixed(4)}, ${lng.toFixed(4)}</small>
                </div>
            `);
            
            document.getElementById('markerLat').value = '';
            document.getElementById('markerLng').value = '';
            document.getElementById('markerText').value = '';
            
            vrMap.setView([lat, lng], Math.max(vrMap.getZoom(), 6));
            
            // Aktualizace textury
            setTimeout(updateMapTexture, 500);
        };

        window.clearMarkers = function() {
            const count = markersGroup.getLayers().length;
            markersGroup.clearLayers();
            markerCount = 0;
            console.log(`üóëÔ∏è Smaz√°no ${count} marker≈Ø`);
            
            // Aktualizace textury
            setTimeout(updateMapTexture, 500);
        };

        // VR toggle
        window.toggleVR = function() {
            if (!isVRMode) {
                // Vstup do VR (simulace)
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.position.set(0, 1.6, 3);
                isVRMode = true;
                document.querySelector('.vr-toggle').textContent = 'Opustit VR';
                console.log('ü•Ω VR re≈æim aktivov√°n');
            } else {
                // V√Ωstup z VR
                camera.position.set(0, 2, 5);
                isVRMode = false;
                document.querySelector('.vr-toggle').textContent = 'Vstoupit do VR';
                console.log('üñ•Ô∏è Desktop re≈æim aktivov√°n');
            }
        };

        // Event listenery pro ovl√°d√°n√≠
        document.getElementById('overlayOpacity').addEventListener('input', function() {
            document.getElementById('opacityValue').textContent = `${this.value}%`;
            setTimeout(updateMapTexture, 200);
        });

        document.getElementById('baseBrightness').addEventListener('input', function() {
            document.getElementById('baseBrightnessValue').textContent = `${this.value}%`;
            applyBaseFilters();
        });

        document.getElementById('baseContrast').addEventListener('input', function() {
            document.getElementById('baseContrastValue').textContent = `${this.value}%`;
            applyBaseFilters();
        });

        function applyBaseFilters() {
            const brightness = document.getElementById('baseBrightness').value;
            const contrast = document.getElementById('baseContrast').value;
            
            const filterValue = `brightness(${brightness}%) contrast(${contrast}%)`;
            
            const baseContainer = baseLayer.getContainer();
            if (baseContainer) {
                baseContainer.style.filter = filterValue;
                setTimeout(updateMapTexture, 200);
            }
        }

        // Render loop
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Resize handler
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // Inicializace
        function init() {
            console.log('üöÄ Inicializuji VR mapu...');
            initThreeJS();
            initializeLeafletMap();
            animate();
            console.log('‚úÖ VR mapa p≈ôipravena!');
        }

        // Spu≈°tƒõn√≠ po naƒçten√≠ str√°nky
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
