<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR ≈Ωiv√° Mapa - Funkƒçn√≠ verze</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 8px;
            max-width: 350px;
        }
        
        #vrButton {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 8px;
            color: white;
            min-width: 200px;
        }
        
        .back-button {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 101;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-50%) translateY(-2px);
        }
        
        canvas {
            display: block;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        
        button:hover {
            background: #357abd;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Zpƒõt na v√Ωbƒõr</a>
    
    <div id="info">
        <h3>üåç VR ≈Ωiv√° Mapa</h3>
        <p><strong>Desktop:</strong></p>
        <ul style="font-size: 12px; margin: 5px 0; padding-left: 15px;">
            <li>WASD = posun mapy</li>
            <li>Q/E = zoom</li>
            <li>Klik = p≈ôidat marker</li>
        </ul>
        <p><strong>VR:</strong></p>
        <ul style="font-size: 12px; margin: 5px 0; padding-left: 15px;">
            <li>Trigger = plynul√Ω drag mapy</li>
            <li>Lev√Ω joystick = pohyb ve VR prostoru</li>
            <li>Prav√Ω joystick Y = zoom in/out</li>
            <li>Prav√Ω joystick X = rotace mapy</li>
        </ul>
        <div id="coords">GPS: 50.075, 14.438</div>
        <div id="zoomInfo">Zoom: 10</div>
        <div id="status">Inicializuji...</div>
    </div>
    
    <div id="controls">
        <h4>üéÆ Ovl√°d√°n√≠</h4>
        <div>
            <button onclick="jumpTo(50.075, 14.438)">üèõÔ∏è Praha</button>
            <button onclick="jumpTo(51.507, -0.128)">üá¨üáß Lond√Ωn</button>
        </div>
        <div>
            <button onclick="jumpTo(40.713, -74.006)">üóΩ NYC</button>
            <button onclick="jumpTo(35.676, 139.650)">üóæ Tokio</button>
        </div>
        <div>
            <button onclick="clearMarkers()">üóëÔ∏è Sma≈æ markery</button>
        </div>
    </div>
    
    <div class="loading" id="loading">üöÄ Naƒç√≠t√°m VR mapu...</div>
    <div id="vrButton"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // === GLOB√ÅLN√ç PROMƒöNN√â ===
        let scene, camera, renderer, mapGroup, userGroup;
        let controller1, controller2;
        let raycaster, mouse = new THREE.Vector2();
        let markers = [];
        
        // === MAPA STAV ===
        let mapCenter = { lat: 50.075, lng: 14.438 };
        let mapZoom = 10;
        let mapPlane;
        
        // === VR STAV ===
        let isDragging = false;
        let dragStartPosition = null;
        let dragStartMapCenter = null;
        let dragController = null;
        let mapOffset = { x: 0, y: 0 };
        
        // === VR BUTTON HACK ===
        function createSimpleVRButton(renderer) {
            const button = document.createElement('button');
            button.style.position = 'absolute';
            button.style.bottom = '20px';
            button.style.padding = '12px 20px';
            button.style.border = 'none';
            button.style.borderRadius = '6px';
            button.style.background = '#4a90e2';
            button.style.color = 'white';
            button.style.cursor = 'pointer';
            button.style.fontSize = '14px';
            button.textContent = 'Enter VR';
            
            if (navigator.xr) {
                button.onclick = async () => {
                    if (renderer.xr.isPresenting) {
                        renderer.xr.getSession().end();
                    } else {
                        try {
                            console.log('ü•Ω Po≈æ√°d√°m o VR session...');
                            
                            // Zkus r≈Øzn√© reference spaces s fallbackem
                            const sessionInit = {
                                requiredFeatures: [],
                                optionalFeatures: ['local-floor', 'bounded-floor']
                            };
                            
                            const session = await navigator.xr.requestSession('immersive-vr', sessionInit);
                            
                            console.log('‚úÖ VR session vytvo≈ôena');
                            
                            // Zkus naj√≠t nejlep≈°√≠ reference space
                            let referenceSpace;
                            try {
                                referenceSpace = await session.requestReferenceSpace('local-floor');
                                console.log('‚úÖ Pou≈æ√≠v√°m local-floor reference space');
                            } catch (e) {
                                console.log('‚ö†Ô∏è local-floor nepodporov√°n, zkou≈°√≠m local...');
                                try {
                                    referenceSpace = await session.requestReferenceSpace('local');
                                    console.log('‚úÖ Pou≈æ√≠v√°m local reference space');
                                } catch (e2) {
                                    console.log('‚ö†Ô∏è local nepodporov√°n, pou≈æ√≠v√°m viewer...');
                                    referenceSpace = await session.requestReferenceSpace('viewer');
                                    console.log('‚úÖ Pou≈æ√≠v√°m viewer reference space');
                                }
                            }
                            
                            renderer.xr.setSession(session);
                            updateStatus('‚úÖ VR aktivn√≠');
                            
                        } catch (error) {
                            console.error('‚ùå VR session failed:', error);
                            updateStatus('‚ùå VR nepodporov√°no nebo zam√≠tnuto');
                        }
                    }
                };
            } else {
                button.textContent = 'VR Nedostupn√©';
                button.disabled = true;
                button.style.background = '#666';
            }
            
            return button;
        }
        
        // === INICIALIZACE ===
        function init() {
            console.log('üöÄ Inicializuji jednoduchou VR mapu bez import≈Ø...');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // User group pro VR locomotion
            userGroup = new THREE.Group();
            scene.add(userGroup);
            console.log('‚úÖ userGroup vytvo≈ôena:', userGroup);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 80);
            camera.lookAt(0, 0, 0);
            userGroup.add(camera);
            console.log('‚úÖ Camera vytvo≈ôena');
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            console.log('‚úÖ Renderer vytvo≈ôen');
            
            // Simple VR Button
            document.getElementById('vrButton').appendChild(createSimpleVRButton(renderer));
            
            // WebXR session event monitoring
            renderer.xr.addEventListener('sessionstart', () => {
                console.log('ü•Ω WebXR session started');
                updateStatus('ü•Ω VR session aktivn√≠');
            });
            
            renderer.xr.addEventListener('sessionend', () => {
                console.log('ü•Ω WebXR session ended');
                updateStatus('ü•Ω VR session ukonƒçena');
            });
            
            setupLighting();
            createSimpleMap();
            setupVRControllers();
            setupDesktopControls();
            
            // Animation loop
            renderer.setAnimationLoop(animate);
            
            document.getElementById('loading').style.display = 'none';
            updateStatus('‚úÖ Jednoduch√° mapa p≈ôipravena');
        }
        
        // === OSVƒöTLEN√ç ===
        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
            sunLight.position.set(50, 100, 50);
            scene.add(sunLight);
        }
        
        // === JEDNODUCH√Å MAPA ===
        function createSimpleMap() {
            mapGroup = new THREE.Group();
            scene.add(mapGroup);
            
            // Grid podklad (vertik√°ln√≠)
            const gridHelper = new THREE.GridHelper(100, 20, 0x444444, 0x444444);
            gridHelper.rotation.x = Math.PI / 2;
            gridHelper.position.z = -1;
            mapGroup.add(gridHelper);
            
            // Hlavn√≠ mapa plane (vertik√°lnƒõ)
            const geometry = new THREE.PlaneGeometry(50, 50);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x90EE90,
                transparent: true,
                opacity: 0.8
            });
            
            mapPlane = new THREE.Mesh(geometry, material);
            mapPlane.position.z = 0;
            mapPlane.name = 'mapPlane';
            mapGroup.add(mapPlane);
            
            loadCenterTile();
        }
        
        function loadCenterTile() {
            const zoom = Math.floor(mapZoom);
            const tileX = Math.floor((mapCenter.lng + 180) / 360 * Math.pow(2, zoom));
            const tileY = Math.floor((1 - Math.log(Math.tan(mapCenter.lat * Math.PI / 180) + 1 / Math.cos(mapCenter.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
            
            // ArcGIS satelitn√≠ mapa (nejspolehlivƒõj≈°√≠)
            const tileUrl = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${tileY}/${tileX}`;
            
            updateStatus(`üì° Naƒç√≠t√°m satelitn√≠ tile: ${zoom}/${tileX}/${tileY}`);
            console.log('üõ∞Ô∏è Tile URL:', tileUrl);
            
            const loader = new THREE.TextureLoader();
            loader.setCrossOrigin('anonymous');
            
            loader.load(
                tileUrl,
                (texture) => {
                    mapPlane.material.map = texture;
                    mapPlane.material.needsUpdate = true;
                    updateStatus(`‚úÖ Satelitn√≠ mapa naƒçtena: ${mapCenter.lat.toFixed(3)}, ${mapCenter.lng.toFixed(3)}`);
                    console.log('‚úÖ Satelitn√≠ tile √∫spƒõ≈°nƒõ naƒçten!');
                },
                (progress) => {
                    console.log('üì° Loading progress:', (progress.loaded / progress.total * 100).toFixed(1) + '%');
                },
                (error) => {
                    console.warn('‚ùå Satelitn√≠ tile selhal, zkou≈°√≠m OpenStreetMap...');
                    
                    // Fallback na OpenStreetMap
                    const osmUrl = `https://tile.openstreetmap.org/${zoom}/${tileX}/${tileY}.png`;
                    loader.load(
                        osmUrl,
                        (texture) => {
                            mapPlane.material.map = texture;
                            mapPlane.material.needsUpdate = true;
                            updateStatus(`‚úÖ OSM mapa naƒçtena: ${mapCenter.lat.toFixed(3)}, ${mapCenter.lng.toFixed(3)}`);
                            console.log('‚úÖ OSM fallback √∫spƒõ≈°n√Ω!');
                        },
                        undefined,
                        (error2) => {
                            console.error('‚ùå V≈°echny tile servery selhaly:', error2);
                            updateStatus('‚ùå Nepoda≈ôilo se naƒç√≠st ≈æ√°dnou realnou mapu');
                        }
                    );
                }
            );
        }
        
        // === VR OVLADAƒåE (JEDNODUCH√ù) ===
        function setupVRControllers() {
            console.log('üéÆ Nastavuji jednoduch√© VR ovladaƒçe...');
            
            if (!userGroup) {
                console.error('‚ùå userGroup is still undefined!');
                return;
            }
            
            raycaster = new THREE.Raycaster();
            
            // Controller 1 (prav√Ω)
            controller1 = renderer.xr.getController(0);
            if (controller1) {
                controller1.addEventListener('selectstart', () => onControllerSelect(0, true));
                controller1.addEventListener('selectend', () => onControllerSelect(0, false));
                userGroup.add(controller1);
                
                // Laser
                const geometry = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(0, 0, -1)
                ]);
                const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0xff0000 }));
                line.scale.z = 15;
                controller1.add(line);
                
                console.log('‚úÖ Controller 1 setup');
            }
            
            // Controller 2 (lev√Ω)
            controller2 = renderer.xr.getController(1);
            if (controller2) {
                controller2.addEventListener('selectstart', () => onControllerSelect(1, true));
                controller2.addEventListener('selectend', () => onControllerSelect(1, false));
                userGroup.add(controller2);
                
                // Laser
                const geometry = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(0, 0, -1)
                ]);
                const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                line.scale.z = 15;
                controller2.add(line);
                
                console.log('‚úÖ Controller 2 setup');
            }
            
            console.log('‚úÖ VR Controllers setup dokonƒçen');
        }
        
        // === VR EVENTY ===
        function onControllerSelect(controllerIndex, pressed) {
            console.log(`Controller ${controllerIndex} trigger: ${pressed}`);
            
            const controller = controllerIndex === 0 ? controller1 : controller2;
            if (!controller) return;
            
            if (pressed) {
                // Zaƒç√°tek drag
                isDragging = true;
                dragController = controller;
                dragStartPosition = controller.position.clone();
                dragStartMapCenter = { lat: mapCenter.lat, lng: mapCenter.lng };
                mapOffset = { x: 0, y: 0 };
                
                console.log('üéØ Zaƒç√°tek plynul√©ho drag');
                updateStatus('üéØ Drag mapa');
                
            } else {
                // Konec drag
                if (isDragging) {
                    // P≈ôevod offsetu na GPS
                    const dragToGPS = 0.01;
                    mapCenter.lng -= mapOffset.x * dragToGPS;
                    mapCenter.lat += mapOffset.y * dragToGPS;
                    
                    // Clamp coordinates
                    mapCenter.lat = Math.max(-85, Math.min(85, mapCenter.lat));
                    mapCenter.lng = Math.max(-180, Math.min(180, mapCenter.lng));
                    
                    // Reset pozice
                    mapGroup.position.x = 0;
                    mapGroup.position.y = 0;
                    mapOffset = { x: 0, y: 0 };
                    
                    isDragging = false;
                    dragController = null;
                    dragStartPosition = null;
                    dragStartMapCenter = null;
                    
                    console.log('üéØ Konec drag - naƒç√≠t√°m nov√Ω tile');
                    loadCenterTile();
                }
            }
        }
        
        // === VR INPUT ===
        function updateVRInput() {
            if (!renderer.xr.isPresenting) return;
            
            const session = renderer.xr.getSession();
            if (!session || !session.inputSources) return;
            
            // Plynul√Ω drag
            if (isDragging && dragController && dragStartPosition && dragStartMapCenter) {
                const currentPosition = dragController.position.clone();
                const deltaPosition = currentPosition.sub(dragStartPosition);
                
                const dragSensitivity = 30;
                mapOffset.x = deltaPosition.x * dragSensitivity;
                mapOffset.y = deltaPosition.y * dragSensitivity;
                
                mapGroup.position.x = mapOffset.x;
                mapGroup.position.y = mapOffset.y;
            }
            
            // Joysticky
            for (let i = 0; i < session.inputSources.length; i++) {
                const inputSource = session.inputSources[i];
                if (!inputSource || !inputSource.gamepad) continue;
                
                const gamepad = inputSource.gamepad;
                
                if (gamepad.axes && gamepad.axes.length >= 4) {
                    const leftX = gamepad.axes[0];
                    const leftY = gamepad.axes[1];
                    const rightX = gamepad.axes[2];
                    const rightY = gamepad.axes[3];
                    
                    // Lev√Ω joystick = Locomotion
                    if (Math.abs(leftX) > 0.1 || Math.abs(leftY) > 0.1) {
                        const moveSpeed = 0.5;
                        userGroup.position.x += leftX * moveSpeed;
                        userGroup.position.z += leftY * moveSpeed;
                        console.log(`üö∂ Locomotion: ${leftX.toFixed(2)}, ${leftY.toFixed(2)}`);
                    }
                    
                    // Prav√Ω joystick Y = Zoom
                    if (Math.abs(rightY) > 0.1) {
                        const zoomSpeed = 0.08;
                        mapZoom += rightY * zoomSpeed;
                        mapZoom = Math.max(1, Math.min(18, mapZoom));
                        
                        if (Math.random() < 0.1) {
                            loadCenterTile();
                        }
                    }
                    
                    // Prav√Ω joystick X = Rotace mapy
                    if (Math.abs(rightX) > 0.1) {
                        const rotSpeed = 0.02;
                        mapGroup.rotation.z += rightX * rotSpeed;
                    }
                }
            }
        }
        
        // === DESKTOP OVL√ÅD√ÅN√ç ===
        function setupDesktopControls() {
            const keys = {};
            
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            function updateDesktopMovement() {
                const moveSpeed = 0.01;
                
                if (keys['w']) {
                    mapCenter.lat += moveSpeed;
                    loadCenterTile();
                }
                if (keys['s']) {
                    mapCenter.lat -= moveSpeed;
                    loadCenterTile();
                }
                if (keys['a']) {
                    mapCenter.lng -= moveSpeed;
                    loadCenterTile();
                }
                if (keys['d']) {
                    mapCenter.lng += moveSpeed;
                    loadCenterTile();
                }
                if (keys['q'] && mapZoom < 18) {
                    mapZoom += 0.1;
                    loadCenterTile();
                }
                if (keys['e'] && mapZoom > 1) {
                    mapZoom -= 0.1;
                    loadCenterTile();
                }
                
                mapCenter.lat = Math.max(-85, Math.min(85, mapCenter.lat));
                mapCenter.lng = Math.max(-180, Math.min(180, mapCenter.lng));
                
                requestAnimationFrame(updateDesktopMovement);
            }
            updateDesktopMovement();
            
            // Mouse click
            renderer.domElement.addEventListener('click', onMapClick);
        }
        
        function onMapClick(event) {
            if (!raycaster) return;
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects([mapPlane]);
            
            if (intersects.length > 0) {
                const point = intersects[0].point;
                const gps = worldToGPS(point);
                addMarker(gps.lat, gps.lng, `Desktop Marker ${markers.length + 1}`);
                updateGPSDisplay(gps.lat, gps.lng);
                updateStatus(`üìç Desktop marker: ${gps.lat.toFixed(4)}, ${gps.lng.toFixed(4)}`);
            }
        }
        
        // === MARKERY ===
        function addMarker(lat, lng, label, color = 0xff0000) {
            const worldPos = gpsToWorld(lat, lng);
            
            const geometry = new THREE.ConeGeometry(1, 3, 8);
            const material = new THREE.MeshBasicMaterial({ color: color });
            const marker = new THREE.Mesh(geometry, material);
            
            marker.position.set(worldPos.x, 1.5, worldPos.z);
            marker.userData = { label, lat, lng };
            marker.name = 'marker';
            
            mapGroup.add(marker);
            markers.push(marker);
            
            console.log(`üìç Marker p≈ôid√°n: ${label} na ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        }
        
        // === KOORDIN√ÅTY ===
        function gpsToWorld(lat, lng) {
            const scale = 50 / 180;
            const x = lng * scale;
            const z = -lat * scale;
            return { x, z };
        }
        
        function worldToGPS(worldPos) {
            const scale = 180 / 50;
            const lng = worldPos.x * scale;
            const lat = -worldPos.z * scale;
            return { lat, lng };
        }
        
        // === UTILITY FUNKCE ===
        function jumpTo(lat, lng) {
            mapCenter.lat = lat;
            mapCenter.lng = lng;
            loadCenterTile();
            updateStatus(`‚úàÔ∏è Skok na: ${lat.toFixed(3)}, ${lng.toFixed(3)}`);
        }
        
        function clearMarkers() {
            markers.forEach(marker => mapGroup.remove(marker));
            markers = [];
            updateStatus('üóëÔ∏è Markery smaz√°ny');
        }
        
        function updateGPSDisplay(lat = mapCenter.lat, lng = mapCenter.lng) {
            document.getElementById('coords').textContent = `GPS: ${lat.toFixed(3)}, ${lng.toFixed(3)}`;
        }
        
        function updateZoomDisplay() {
            document.getElementById('zoomInfo').textContent = `Zoom: ${mapZoom.toFixed(1)}`;
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }
        
        // === ANIMATION LOOP ===
        function animate() {
            updateVRInput();
            
            // Animace marker≈Ø
            markers.forEach((marker, i) => {
                marker.rotation.y += 0.02;
                marker.position.y = 1.5 + Math.sin(Date.now() * 0.003 + i) * 0.2;
            });
            
            updateGPSDisplay();
            updateZoomDisplay();
            
            renderer.render(scene, camera);
        }
        
        // === RESIZE ===
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // === GLOB√ÅLN√ç FUNKCE ===
        window.jumpTo = jumpTo;
        window.clearMarkers = clearMarkers;
        
        // === START ===
        init();
        console.log('üó∫Ô∏è Jednoduch√° VR mapa p≈ôipravena bez import≈Ø!');
        
    </script>
</body>
</html>
