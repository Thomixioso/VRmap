<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Mapa</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Babylon.js -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/WebXR/babylon.webxr.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        #vrCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: #000;
            display: none;
        }
        
        .vr-button {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            padding: 12px 24px;
            background: linear-gradient(45deg, #007cff, #0051cc);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 124, 255, 0.3);
        }
        
        .vr-button:hover {
            transform: translateY(-2px);
        }
        
        .vr-hidden {
            display: none !important;
        }
        
        .map-controls {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .control-button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            margin: 5px 0;
            background: #007cff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-button:hover {
            background: #0056cc;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- 2D ovl√°dac√≠ panel -->
    <div class="map-controls">
        <button class="control-button" onclick="map.zoomIn()">üîç Zoom In</button>
        <button class="control-button" onclick="map.zoomOut()">üîç Zoom Out</button>
        <button class="control-button" onclick="toggleSatellite()">üõ∞Ô∏è Satellite</button>
        <button class="control-button" onclick="addMarker()">üìç Add Marker</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Z√°kladn√≠ mapa
        let map, satelliteLayer, streetLayer;
        let isVRMode = false;


        // Inicializace mapy
        function initMap() {
            map = L.map('map').setView([50.0755, 14.4378], 10); // Praha
            
            // Z√°kladn√≠ vrstvy
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });
        }

        // Mapov√© funkce
        function toggleSatellite() {
            if (map.hasLayer(satelliteLayer)) {
                map.removeLayer(satelliteLayer);
                map.addLayer(streetLayer);
            } else {
                map.removeLayer(streetLayer);
                map.addLayer(satelliteLayer);
            }
            updateVRMap();
        }

        function addMarker() {
            const center = map.getCenter();
            L.marker([center.lat, center.lng])
                .addTo(map)
                .bindPopup(`Marker at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`)
                .openPopup();
            updateVRMap();
        }

        // VR System
        class VRMapHandler {
            constructor() {
                this.vrScene = null;
                this.vrEngine = null;
                this.vrCanvas = null;
                this.mapTexture = null;
                this.mapPlane = null;
                this.init();
            }

            init() {
                this.createVRButton();
            }

            createVRButton() {
                const vrButton = document.createElement('button');
                vrButton.className = 'vr-button';
                vrButton.innerHTML = 'ü•Ω Enter VR';
                vrButton.onclick = () => this.toggleVR();
                document.body.appendChild(vrButton);
                this.vrButton = vrButton;
            }

            async toggleVR() {
                if (!isVRMode) {
                    await this.enterVR();
                } else {
                    this.exitVR();
                }
            }

            async enterVR() {
                try {
                    // Vytvo≈ôen√≠ VR canvas
                    this.vrCanvas = document.createElement('canvas');
                    this.vrCanvas.id = 'vrCanvas';
                    this.vrCanvas.style.display = 'block';
                    document.body.appendChild(this.vrCanvas);

                    // Babylon.js engine a sc√©na
                    this.vrEngine = new BABYLON.Engine(this.vrCanvas, true);
                    this.vrScene = new BABYLON.Scene(this.vrEngine);

                    // Kamera
                    const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 2, -5), this.vrScene);
                    camera.attachToCanvas(this.vrCanvas, true);

                    // Osvƒõtlen√≠
                    new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), this.vrScene);

                    // Podlaha
                    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, this.vrScene);
                    const groundMat = new BABYLON.StandardMaterial("groundMat", this.vrScene);
                    groundMat.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.3);
                    ground.material = groundMat;

                    // P≈ôevod mapy na VR
                    await this.createVRMap();

                    // VR ovl√°d√°n√≠
                    this.setupVRControls();

                    // WebXR
                    const xr = await this.vrScene.createDefaultXRExperienceAsync({


                      floorMeshes: [ground],
                        optionalFeatures: ["hand-tracking"]
                    });
                    this.xrExperience = xr;

                    // Spustit render loop
                    this.vrEngine.runRenderLoop(() => {
                        this.vrScene.render();
                    });

                    // Resize p≈ôi zmƒõnƒõ velikosti okna
                    window.addEventListener("resize", () => {
                        this.vrEngine.resize();
                    });

                    // Skryt√≠ 2D mapy
                    document.getElementById('map').classList.add('vr-hidden');
                    // Uk√°zat VR tlaƒç√≠tko pro ukonƒçen√≠ VR
                    this.vrButton.innerHTML = 'üö™ Exit VR';
                    isVRMode = true;

                } catch (err) {
                    alert('Nepoda≈ôilo se spustit VR: ' + err);
                }
            }

            async createVRMap() {
                // Poƒçkat na naƒçten√≠ mapy
                await new Promise(resolve => {
                    if (map._loaded) {
                        resolve();
                    } else {
                        map.whenReady(resolve);
                    }
                });

                // Vytvo≈ôit snapshot mapy
                const canvasMap = await html2canvas(document.getElementById('map'));
                const dataUrl = canvasMap.toDataURL();

                // Vytvo≈ôit texturu v Babylon.js
                this.mapTexture = new BABYLON.DynamicTexture("mapTexture", { width: canvasMap.width, height: canvasMap.height }, this.vrScene);
                const ctx = this.mapTexture.getContext();
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    this.mapTexture.update();
                };
                img.src = dataUrl;

                // Vytvo≈ôit rovinu s mapou
                this.mapPlane = BABYLON.MeshBuilder.CreatePlane("mapPlane", { width: 6, height: 4 }, this.vrScene);
                const mat = new BABYLON.StandardMaterial("mapMat", this.vrScene);
                mat.diffuseTexture = this.mapTexture;
                this.mapPlane.material = mat;
                this.mapPlane.position = new BABYLON.Vector3(0, 2, 2);
            }

            setupVRControls() {
                // P≈ôidat jednoduch√© ovl√°d√°n√≠
                this.vrScene.onPointerObservable.add((pointerInfo) => {
                    if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
                        // P≈ôidat marker na aktu√°ln√≠ pozici
                        this.placeMarker();
                    }
                });
            }

            placeMarker() {
                // Vytvo≈ôit marker ve VR
                const sphere = BABYLON.MeshBuilder.CreateSphere("marker", { diameter: 0.2 }, this.vrScene);
                sphere.position = new BABYLON.Vector3(0, 2, 2);
                const mat = new BABYLON.StandardMaterial("markerMat", this.vrScene);
                mat.diffuseColor = new BABYLON.Color3(1, 0, 0);
                sphere.material = mat;
            }

            async updateVRMap() {
                // Aktualizace textury mapy
                const canvasMap = await html2canvas(document.getElementById('map'));
                const dataUrl = canvasMap.toDataURL();

                const ctx = this.mapTexture.getContext();
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.drawImage(img, 0, 0);
                    this.mapTexture.update();
                };
                img.src = dataUrl;
            }

            async toggleVR() {
                if (!isVRMode) {
                    await this.enterVR();
                } else {
                    this.exitVR();
                }
            }

            exitVR() {
                try {
                    // Ukonƒçit XR
                    if (this.xrExperience) {
                        this.xrExperience.baseExperience.exitXRAsync();
                    }
                    // Zru≈°it rendery a sc√©ny
                    if (this.vrEngine) {
                        this.vrEngine.dispose();
                        this.vrEngine = null;
                    }
                    if (this.vrCanvas) {
                        this.vrCanvas.remove();
                        this.vrCanvas = null;
                    }
                    // Obnovit 2D mapu
                    document.getElementById('map').classList.remove('vr-hidden');
                    this.vrButton.innerHTML = 'ü•Ω Enter VR';
                    isVRMode = false;
                } catch (err) {
                    alert('Chyba p≈ôi ukonƒçen√≠ VR: ' + err);
                }
            }
        }

        // Inicializace
        window.onload = () => {
            initMap();
            const vrHandler = new VRMapHandler();

            // P≈ôidat tlaƒç√≠tko pro VR
            const btn = document.createElement('button');
            btn.className = 'vr-button';
            btn.innerHTML = 'ü•Ω Enter VR';
            btn.onclick = () => vrHandler.toggleVR();
            document.body.appendChild(btn);
        }
    </script>
</body>
</html>



















                                    




        
