<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Mapa</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Babylon.js -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/WebXR/babylon.webxr.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        #vrCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: #000;
            display: none;
        }
        
        .vr-button {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            padding: 12px 24px;
            background: linear-gradient(45deg, #007cff, #0051cc);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 124, 255, 0.3);
        }
        
        .vr-button:hover {
            transform: translateY(-2px);
        }
        
        .vr-hidden {
            display: none !important;
        }
        
        .map-controls {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .control-button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            margin: 5px 0;
            background: #007cff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-button:hover {
            background: #0056cc;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- 2D ovl√°dac√≠ panel -->
    <div class="map-controls">
        <button class="control-button" onclick="map.zoomIn()">üîç Zoom In</button>
        <button class="control-button" onclick="map.zoomOut()">üîç Zoom Out</button>
        <button class="control-button" onclick="toggleSatellite()">üõ∞Ô∏è Satellite</button>
        <button class="control-button" onclick="addMarker()">üìç Add Marker</button>
    </div>



    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Z√°kladn√≠ mapa
        let map, satelliteLayer, streetLayer;
        let isVRMode = false;
        let vrHandler = null;

        // Inicializace mapy
        function initMap() {
            map = L.map('map').setView([50.0755, 14.4378], 10); // Praha
            
            // Z√°kladn√≠ vrstvy
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });
        }

        // Mapov√© funkce
        function toggleSatellite() {
            if (map.hasLayer(satelliteLayer)) {
                map.removeLayer(satelliteLayer);
                map.addLayer(streetLayer);
            } else {
                map.removeLayer(streetLayer);
                map.addLayer(satelliteLayer);
            }
            updateVRMap();
        }

        function addMarker() {
            const center = map.getCenter();
            L.marker([center.lat, center.lng])
                .addTo(map)
                .bindPopup(`Marker at ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`)
                .openPopup();
            updateVRMap();
        }

        function updateVRMap() {
            if (vrHandler && isVRMode) {
                vrHandler.updateVRMap();
            }
        }

        // VR System
        class VRMapHandler {
            constructor() {
                this.vrScene = null;
                this.vrEngine = null;
                this.vrCanvas = null;
                this.mapTexture = null;
                this.mapPlane = null;
                this.xrExperience = null;
                this.init();
            }

            init() {
                this.createVRButton();
            }

            createVRButton() {
                
                const vrButton = document.createElement('button');
                vrButton.className = 'vr-button';
                
                vrButton.innerHTML = 'ü•Ω Enter VR';
                vrButton.onclick = () => this.toggleVR();
                document.body.appendChild(vrButton);
                this.vrButton = vrButton;
            }

            async toggleVR() {
                if (!isVRMode) {
                    await this.enterVR();
                } else {
                    this.exitVR();
                }
            }










            async enterVR() {
                try {
                    // Vytvo≈ôen√≠ VR canvas
                    this.vrCanvas = document.createElement('canvas');
                    this.vrCanvas.id = 'vrCanvas';
                    this.vrCanvas.style.display = 'block';
                    document.body.appendChild(this.vrCanvas);

                    // Babylon.js engine a sc√©na
                    this.vrEngine = new BABYLON.Engine(this.vrCanvas, true);
                    this.vrScene = new BABYLON.Scene(this.vrEngine);

                    // Kamera
                    const camera = new BABYLON.ArcRotateCamera("camera", 0, 0, 10, BABYLON.Vector3.Zero(), this.vrScene);
                    camera.setPosition(new BABYLON.Vector3(0, 5, -10));
                    this.vrScene.activeCamera = camera;

                    // Osvƒõtlen√≠
                    new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), this.vrScene);

                    // Podlaha
                    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, this.vrScene);
                    const groundMat = new BABYLON.StandardMaterial("groundMat", this.vrScene);
                    groundMat.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.3);
                    ground.material = groundMat;

                    // P≈ôevod mapy na VR
                    await this.createVRMap();

                    // VR ovl√°d√°n√≠
                    this.setupVRControls();

                    // Spustit render loop
                    this.vrEngine.runRenderLoop(() => {
                        this.vrScene.render();
                    });

                    // WebXR - OPRAVENO: Automatick√Ω vstup do VR
                    try {
                        this.xrExperience = await this.vrScene.createDefaultXRExperienceAsync({
                            floorMeshes: [ground],
                            optionalFeatures: ["hand-tracking"]
                        });

                        // KL√çƒåOV√â: Automaticky vstoupit do VR
                        if (this.xrExperience.baseExperience) {
                            await this.xrExperience.baseExperience.enterXRAsync("immersive-vr", "local-floor");
                            console.log("Vstoupeno do VR headsetu");
                        }

                    } catch (xrError) {
                        console.warn("WebXR vstup selhal:", xrError);
                        alert("VR headset nen√≠ p≈ôipojen nebo WebXR nen√≠ podporov√°no");
                    }

                    // Resize handler
                    this.resizeHandler = () => this.vrEngine.resize();
                    window.addEventListener("resize", this.resizeHandler);

                    // Skryt√≠ 2D mapy
                    document.getElementById('map').classList.add('vr-hidden');
                    document.querySelector('.map-controls').classList.add('vr-hidden');
                    
                    // Zmƒõna tlaƒç√≠tka
                    this.vrButton.innerHTML = 'üö™ Exit VR';
                    isVRMode = true;

                    console.log("VR re≈æim √∫spƒõ≈°nƒõ spu≈°tƒõn");

                } catch (err) {
                    console.error("VR chyba:", err);
                    alert('Nepoda≈ôilo se spustit VR: ' + err.message);
                    this.exitVR();
                }
            }

            









            

            async createVRMap() {
                try {
                    // Poƒçkat na naƒçten√≠ mapy
                    await new Promise(resolve => {
                        if (map._loaded) {
                            resolve();
                        } else {
                            map.whenReady(resolve);
                        }
                    });

                    // Kr√°tk√© ƒçek√°n√≠ pro vykreslen√≠
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Vytvo≈ôit snapshot mapy
                    const mapElement = document.getElementById('map');
                    const canvasMap = await html2canvas(mapElement, {
                        useCORS: true,
                        allowTaint: true
                    });

                    // Vytvo≈ôit texturu v Babylon.js
                    const textureSize = {
                        width: Math.min(canvasMap.width, 1024),
                        height: Math.min(canvasMap.height, 1024)
                    };

                    this.mapTexture = new BABYLON.DynamicTexture("mapTexture", textureSize, this.vrScene);
                    const ctx = this.mapTexture.getContext();
                    ctx.drawImage(canvasMap, 0, 0, textureSize.width, textureSize.height);
                    this.mapTexture.update();

                    // Vytvo≈ôit rovinu s mapou
                    this.mapPlane = BABYLON.MeshBuilder.CreatePlane("mapPlane", { 
                        width: 6, 
                        height: 4 
                    }, this.vrScene);
                    
                    const mat = new BABYLON.StandardMaterial("mapMat", this.vrScene);
                    mat.diffuseTexture = this.mapTexture;
                    mat.emissiveTexture = this.mapTexture;
                    mat.emissiveColor = new BABYLON.Color3(0.3, 0.3, 0.3);
                    this.mapPlane.material = mat;
                    this.mapPlane.position = new BABYLON.Vector3(0, 2, 2);
                    this.mapPlane.rotation.x = -Math.PI / 12; // M√≠rn√Ω n√°klon

                    console.log("VR mapa vytvo≈ôena");

                } catch (err) {
                    console.error("Chyba p≈ôi vytv√°≈ôen√≠ VR mapy:", err);
                    throw err;
                }
            }

            setupVRControls() {
                // Jednoduch√© ovl√°d√°n√≠ my≈°√≠/dotykem
                this.vrScene.onPointerObservable.add((pointerInfo) => {
                    if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
                        if (pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh === this.mapPlane) {
                            this.placeVRMarker(pointerInfo.pickInfo.pickedPoint);
                        }
                    }
                });

                // Kl√°vesov√© zkratky
                window.addEventListener('keydown', (event) => {
                    if (!isVRMode) return;
                    
                    switch(event.key) {
                        case 'Escape':
                            this.exitVR();
                            break;
                        case '+':
                        case '=':
                            map.zoomIn();
                            this.updateVRMap();
                            break;
                        case '-':
                            map.zoomOut();
                            this.updateVRMap();
                            break;
                    }
                });
            }

            placeVRMarker(position) {
                // Vytvo≈ôit marker ve VR prostoru
                const sphere = BABYLON.MeshBuilder.CreateSphere("vrMarker", { diameter: 0.1 }, this.vrScene);
                sphere.position = position.clone();
                sphere.position.y += 0.05;
                
                const mat = new BABYLON.StandardMaterial("markerMat", this.vrScene);
                mat.diffuseColor = new BABYLON.Color3(1, 0, 0);
                mat.emissiveColor = new BABYLON.Color3(0.5, 0, 0);
                sphere.material = mat;

                // Animace
                BABYLON.Animation.CreateAndStartAnimation("pulse", sphere, "scaling", 30, 60,
                    new BABYLON.Vector3(1, 1, 1), new BABYLON.Vector3(1.2, 1.2, 1.2), 
                    BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);

                console.log("VR marker um√≠stƒõn na pozici:", position);
            }

            async updateVRMap() {
                if (!this.mapTexture || !isVRMode) return;

                try {
                    const mapElement = document.getElementById('map');
                    const canvasMap = await html2canvas(mapElement, {
                        useCORS: true,
                        allowTaint: true,
                        scale: 0.8 // Ni≈æ≈°√≠ kvalita pro rychlost
                    });

                    const ctx = this.mapTexture.getContext();
                    const textureSize = { width: ctx.canvas.width, height: ctx.canvas.height };
                    
                    ctx.clearRect(0, 0, textureSize.width, textureSize.height);
                    ctx.drawImage(canvasMap, 0, 0, textureSize.width, textureSize.height);
                    this.mapTexture.update();

                    console.log("VR mapa aktualizov√°na");

                } catch (err) {
                    console.warn("Nepoda≈ôilo se aktualizovat VR mapu:", err);
                }
            }

            exitVR() {
                try {

                    // Ukonƒçit XR session
                    if (this.xrExperience) {
                        this.xrExperience.baseExperience.exitXRAsync();
                        this.xrExperience = null;
                    }
                    
                    // Zastavit render loop
                    if (this.vrEngine) {
                        this.vrEngine.dispose();
                        this.vrEngine = null;
                    }

                    // Vyƒçistit sc√©nu
                    if (this.vrScene) {
                        this.vrScene.dispose();
                        this.vrScene = null;
                    }

                    // Odstranit canvas
                    if (this.vrCanvas) {
                        this.vrCanvas.remove();
                        this.vrCanvas = null;
                    }

                    // Odstranit resize handler
                    if (this.resizeHandler) {
                        window.removeEventListener("resize", this.resizeHandler);
                        this.resizeHandler = null;
                    }

                    // Obnovit 2D mapu
                    document.getElementById('map').classList.remove('vr-hidden');
                    document.querySelector('.map-controls').classList.remove('vr-hidden');
                    
                    // Reset tlaƒç√≠tka
                    this.vrButton.innerHTML = 'ü•Ω Enter VR';
                    isVRMode = false;

                    console.log("VR re≈æim ukonƒçen");

                } catch (err) {
                    console.error('Chyba p≈ôi ukonƒçen√≠ VR:', err);
                    // Force reset
                    isVRMode = false;
                    this.vrButton.innerHTML = 'ü•Ω Enter VR';
                }
            }
        }

        // Inicializace po naƒçten√≠ str√°nky
        window.addEventListener('load', () => {
            console.log("Inicializace aplikace...");
            
            initMap();
            vrHandler = new VRMapHandler();
            
            console.log("Aplikace p≈ôipravena");
        });

        // Cleanup p≈ôi zav≈ôen√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (vrHandler && isVRMode) {
                vrHandler.exitVR();
            }
        });

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Glob√°ln√≠ chyba:', event.error);
            if (isVRMode && vrHandler) {
                alert('Nastala chyba ve VR re≈æimu. Ukonƒçuji VR...');
                vrHandler.exitVR();
            }
        });
    </script>
</body>
</html>

                        
                                                           
                        
