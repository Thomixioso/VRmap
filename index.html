<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Mapa se skuteƒçnou 2D mapou</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .vr-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 350px;
            border: 2px solid #4a90e2;
        }

        .vr-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            font-size: 14px;
        }

        .vr-button:hover {
            background: #357abd;
        }

        .back-link {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 6px;
        }

        /* 2D mapa - mal√° ale viditeln√° pro zachycen√≠ */
        #map2D {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            z-index: 999;
        }

        /* Skryt√Ω canvas pro zachycen√≠ mapy */
        #mapCapture {
            position: absolute;
            top: -2000px;
            left: -2000px;
        }

        #debugLog {
            position: absolute;
            top: 20px;
            right: 450px;
            z-index: 1000;
            background: rgba(0, 50, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #00ff00;
        }

        .map-controls {
            position: absolute;
            bottom: 330px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4a90e2;
        }

        .map-controls button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .crosshair.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="renderer"></canvas>
        <canvas id="mapCapture" width="1024" height="1024"></canvas>
        
        <!-- Viditeln√° 2D mapa pro zachycen√≠ -->
        <div id="map2D"></div>
        
        <div class="map-controls">
            <h4>üó∫Ô∏è Map Control</h4>
            <button onclick="vrMap.zoomIn()">Zoom +</button>
            <button onclick="vrMap.zoomOut()">Zoom -</button>
            <br>
            <button onclick="vrMap.panNorth()">‚¨ÜÔ∏è North</button>
            <button onclick="vrMap.panSouth()">‚¨áÔ∏è South</button>
            <br>
            <button onclick="vrMap.panWest()">‚¨ÖÔ∏è West</button>
            <button onclick="vrMap.panEast()">‚û°Ô∏è East</button>
            <br>
            <button onclick="vrMap.resetMapView()">üéØ Reset</button>
        </div>
        
        <div class="crosshair" id="crosshair"></div>
        
        <div class="vr-ui">
            <h3>ü•Ω VR + 2D Mapa</h3>
            <button id="vrButton" class="vr-button">üé≠ VR Mode</button>
            <button id="resetView" class="vr-button">üéØ Reset View</button>
            <button id="captureMap" class="vr-button">üì∏ Update VR Map</button>
            <button id="testInteraction" class="vr-button">üñ±Ô∏è Test Click</button>
            
            <div id="status">üîÑ Naƒç√≠t√°n√≠ 2D mapy...</div>
        </div>
        
        <div id="debugLog">
            <strong>üìã Debug Log:</strong><br>
            Spou≈°t√≠m...
        </div>
        
        <a href="index.html" class="back-link">‚Üê Zpƒõt</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Debug logger
        function debugLog(message) {
            const debugElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            debugElement.innerHTML += `<br>[${timestamp}] ${message}`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            debugLog(`STATUS: ${message}`);
        }

        class VRMapWithReal2D {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.mapScreen = null;
                this.leafletMap = null;
                this.isVRMode = false;
                
                // Interaction
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                debugLog('üöÄ VR+2D inicializace zaƒç√≠n√°');
                this.init();
            }

            async init() {
                try {
                    this.setupThreeJS();
                    this.createTestObjects();
                    this.createMapScreen();
                    await this.setup2DMap();
                    this.setupInteractions();
                    this.animate();
                    
                    debugLog('‚úÖ Inicializace dokonƒçena');
                    updateStatus('‚úÖ VR s 2D mapou p≈ôipravena');
                } catch (error) {
                    debugLog(`‚ùå Chyba inicializace: ${error.message}`);
                    updateStatus('‚ùå Chyba inicializace');
                }
            }

            setupThreeJS() {
                debugLog('Nastavuji Three.js...');
                
                // Sc√©na
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x001122);

                // Kamera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 1, 4);

                // Renderer
                const canvas = document.getElementById('renderer');
                this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);

                // Osvƒõtlen√≠
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
                directionalLight.position.set(2, 2, 1);
                this.scene.add(directionalLight);

                debugLog('‚úÖ Three.js nastaven');
            }

            createTestObjects() {
                debugLog('Vytv√°≈ô√≠m test objekty...');
                
                // Podlaha
                const floorGeometry = new THREE.PlaneGeometry(10, 10);
                const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.position.y = -1;
                this.scene.add(floor);

                debugLog('‚úÖ Test objekty vytvo≈ôeny');
            }

            createMapScreen() {
                debugLog('Vytv√°≈ô√≠m VR mapovou obrazovku...');
                
                // Mapov√° obrazovka 4x3 metry
                const screenGeometry = new THREE.PlaneGeometry(4, 3);
                
                // Canvas pro zachycen√≠ mapy
                const mapCanvas = document.getElementById('mapCapture');
                const ctx = mapCanvas.getContext('2d');
                
                // Poƒç√°teƒçn√≠ placeholder
                this.drawPlaceholder(ctx);
                
                const screenTexture = new THREE.CanvasTexture(mapCanvas);
                screenTexture.flipY = false;
                
                const screenMaterial = new THREE.MeshLambertMaterial({ 
                    map: screenTexture,
                    transparent: false
                });
                
                this.mapScreen = new THREE.Mesh(screenGeometry, screenMaterial);
                this.mapScreen.position.set(0, 1, 0);
                this.mapScreen.name = 'mapScreen';
                this.scene.add(this.mapScreen);

                // R√°m
                this.createScreenFrame();
                
                debugLog('‚úÖ VR mapov√° obrazovka vytvo≈ôena');
            }

            drawPlaceholder(ctx) {
                // Placeholder dokud se nenaƒçte mapa
                const gradient = ctx.createLinearGradient(0, 0, 1024, 1024);
                gradient.addColorStop(0, '#1e3c72');
                gradient.addColorStop(0.5, '#2a5298');
                gradient.addColorStop(1, '#1e3c72');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1024, 1024);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üó∫Ô∏è Naƒç√≠t√°m 2D mapu...', 512, 512);
                
                if (this.mapScreen && this.mapScreen.material.map) {
                    this.mapScreen.material.map.needsUpdate = true;
                }
            }

            createScreenFrame() {
                const frameThickness = 0.05;
                const frameColor = 0x222222;
                
                // Horn√≠ + doln√≠ + boƒçn√≠ r√°my
                const frames = [
                    { size: [4.1, frameThickness, 0.02], pos: [0, 1 + 1.5 + frameThickness/2, 0] },
                    { size: [4.1, frameThickness, 0.02], pos: [0, 1 - 1.5 - frameThickness/2, 0] },
                    { size: [frameThickness, 3.1, 0.02], pos: [-2 - frameThickness/2, 1, 0] },
                    { size: [frameThickness, 3.1, 0.02], pos: [2 + frameThickness/2, 1, 0] }
                ];

                frames.forEach(frame => {
                    const geometry = new THREE.BoxGeometry(...frame.size);
                    const material = new THREE.MeshLambertMaterial({ color: frameColor });
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...frame.pos);
                    this.scene.add(mesh);
                });
            }

            async setup2DMap() {
                debugLog('Nastavuji Leaflet 2D mapu...');
                
                return new Promise((resolve) => {
                    try {
                        // Inicializace Leaflet mapy
                        this.leafletMap = L.map('map2D', {
                            center: [49.75, 15.5],
                            zoom: 5,
                            minZoom: 3,
                            maxZoom: 8
                        });

                        // Satelitn√≠ vrstva (offline tiles)
                        L.tileLayer('tiles_satellite_labeled/{z}/{x}/{y}.jpg', {
                            attribution: 'Offline Satellite Map',
                            minZoom: 3,
                            maxZoom: 8,
                            maxNativeZoom: 6
                        }).addTo(this.leafletMap);

                        // Hranice st√°t≈Ø (pokud existuj√≠)
                        this.loadCountries();

                        // ƒåek√°n√≠ na naƒçten√≠ tiles
                        setTimeout(() => {
                            this.captureMapToVR();
                            debugLog('‚úÖ 2D mapa p≈ôipravena');
                            updateStatus('‚úÖ 2D mapa naƒçtena');
                            resolve();
                        }, 2000);

                        // Auto-update p≈ôi zmƒõnƒõ mapy
                        this.leafletMap.on('moveend zoomend', () => {
                            setTimeout(() => this.captureMapToVR(), 500);
                        });

                    } catch (error) {
                        debugLog(`‚ùå Chyba 2D mapy: ${error.message}`);
                        resolve(); // Pokraƒçuj i s chybou
                    }
                });
            }

            async loadCountries() {
                try {
                    const response = await fetch('data/countries.geojson');
                    if (response.ok) {
                        const data = await response.json();
                        L.geoJSON(data, {
                            style: {
                                fillColor: 'transparent',
                                weight: 2,
                                opacity: 0.8,
                                color: '#ffffff',
                                fillOpacity: 0
                            }
                        }).addTo(this.leafletMap);
                        debugLog('‚úÖ Hranice st√°t≈Ø naƒçteny');
                    }
                } catch (error) {
                    debugLog('‚ÑπÔ∏è Hranice st√°t≈Ø nejsou dostupn√©');
                }
            }

            captureMapToVR() {
                debugLog('Zachyt√°v√°m 2D mapu do VR...');
                
                if (!this.leafletMap) return;

                try {
                    // Pou≈æit√≠ html2canvas pro zachycen√≠ Leaflet mapy
                    const mapElement = document.getElementById('map2D');
                    
                    html2canvas(mapElement, {
                        width: 1024,
                        height: 1024,
                        scale: 1,
                        useCORS: true,
                        allowTaint: true
                    }).then(canvas => {
                        const ctx = document.getElementById('mapCapture').getContext('2d');
                        ctx.clearRect(0, 0, 1024, 1024);
                        ctx.drawImage(canvas, 0, 0, 1024, 1024);
                        
                        // Update Three.js textury
                        if (this.mapScreen && this.mapScreen.material.map) {
                            this.mapScreen.material.map.needsUpdate = true;
                        }
                        
                        debugLog('‚úÖ Mapa zachycena do VR');
                    }).catch(error => {
                        debugLog(`‚ö†Ô∏è html2canvas probl√©m: ${error.message}`);
                        this.fallbackCapture();
                    });

                } catch (error) {
                    debugLog(`‚ö†Ô∏è Capture error: ${error.message}`);
                    this.fallbackCapture();
                }
            }

            fallbackCapture() {
                // Fallback - informace z Leaflet API
                const ctx = document.getElementById('mapCapture').getContext('2d');
                
                // Z√°klad
                const gradient = ctx.createLinearGradient(0, 0, 1024, 1024);
                gradient.addColorStop(0, '#1e3c72');
                gradient.addColorStop(0.5, '#2a5298');
                gradient.addColorStop(1, '#1e3c72');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1024, 1024);

                if (this.leafletMap) {
                    const center = this.leafletMap.getCenter();
                    const zoom = this.leafletMap.getZoom();
                    
                    // Info box
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(50, 50, 400, 200);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('üó∫Ô∏è Offline Mapa', 70, 90);
                    ctx.fillText(`GPS: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 70, 130);
                    ctx.fillText(`Zoom: ${zoom}`, 70, 170);
                    ctx.fillText(`ƒåas: ${new Date().toLocaleTimeString()}`, 70, 210);
                }

                if (this.mapScreen && this.mapScreen.material.map) {
                    this.mapScreen.material.map.needsUpdate = true;
                }
            }

            setupInteractions() {
                debugLog('Nastavuji interakce...');
                
                // Mouse interakce s VR obrazovkou
                this.renderer.domElement.addEventListener('click', (event) => {
                    this.handleVRScreenClick(event);
                });

                this.renderer.domElement.addEventListener('mousemove', (event) => {
                    this.handleMouseMove(event);
                });

                // Tlaƒç√≠tka
                document.getElementById('vrButton').addEventListener('click', () => {
                    this.toggleVR();
                });

                document.getElementById('resetView').addEventListener('click', () => {
                    this.resetView();
                });

                document.getElementById('captureMap').addEventListener('click', () => {
                    this.captureMapToVR();
                });

                document.getElementById('testInteraction').addEventListener('click', () => {
                    this.testInteraction();
                });

                debugLog('‚úÖ Interakce nastaveny');
            }

            handleVRScreenClick(event) {
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObject(this.mapScreen);

                if (intersects.length > 0 && this.leafletMap) {
                    const uv = intersects[0].uv;
                    this.forwardClickToMap(uv);
                }
            }

            handleMouseMove(event) {
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObject(this.mapScreen);

                const crosshair = document.getElementById('crosshair');
                if (intersects.length > 0) {
                    crosshair.classList.add('active');
                } else {
                    crosshair.classList.remove('active');
                }
            }

            forwardClickToMap(uv) {
                if (!this.leafletMap || !uv) return;
                
                const mapBounds = this.leafletMap.getBounds();
                const lat = mapBounds.getNorth() - (mapBounds.getNorth() - mapBounds.getSouth()) * uv.y;
                const lng = mapBounds.getWest() + (mapBounds.getEast() - mapBounds.getWest()) * uv.x;
                
                this.leafletMap.panTo([lat, lng]);
                
                debugLog(`üñ±Ô∏è VR Click -> GPS: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                updateStatus(`üìç Klik: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            }

            // Map control functions
            zoomIn() { if (this.leafletMap) this.leafletMap.zoomIn(); }
            zoomOut() { if (this.leafletMap) this.leafletMap.zoomOut(); }
            panNorth() { if (this.leafletMap) this.leafletMap.panBy([0, -50]); }
            panSouth() { if (this.leafletMap) this.leafletMap.panBy([0, 50]); }
            panWest() { if (this.leafletMap) this.leafletMap.panBy([-50, 0]); }
            panEast() { if (this.leafletMap) this.leafletMap.panBy([50, 0]); }
            resetMapView() { if (this.leafletMap) this.leafletMap.setView([49.75, 15.5], 5); }

            toggleVR() {
                this.isVRMode = !this.isVRMode;
                
                if (this.isVRMode) {
                    this.camera.position.set(0, 1.6, 2);
                    this.camera.fov = 90;
                    updateStatus('ü•Ω VR m√≥d aktivn√≠');
                } else {
                    this.camera.position.set(0, 1, 4);
                    this.camera.fov = 75;
                    updateStatus('üñ•Ô∏è Desktop m√≥d');
                }
                
                this.camera.updateProjectionMatrix();
            }

            resetView() {
                this.camera.position.set(0, 1, 4);
                this.camera.fov = 75;
                this.camera.updateProjectionMatrix();
                this.resetMapView();
                updateStatus('üéØ Pohled resetov√°n');
            }

            testInteraction() {
                if (this.leafletMap) {
                    this.leafletMap.setView([50.0755, 14.4378], 8); // Praha
                    debugLog('üß™ Test: p≈ôesun na Prahu');
                    updateStatus('üß™ Test: Praha');
                }
            }

            animate() {
                const animateFunction = () => {
                    requestAnimationFrame(animateFunction);
                    
                    this.camera.lookAt(0, 1, 0);
                    this.renderer.render(this.scene, this.camera);
                };
                
                animateFunction();
            }
        }

        // Spu≈°tƒõn√≠
        let vrMap;
        window.addEventListener('load', async () => {
            try {
                vrMap = new VRMapWithReal2D();
                window.vrMap = vrMap; // Pro global p≈ô√≠stup
            } catch (error) {
                debugLog(`üí• Kritick√° chyba: ${error.message}`);
                updateStatus('üí• Kritick√° chyba');
            }
        });

        debugLog('üìÑ Script naƒçten - p≈ôipraven na load event');
    </script>
</body>
</html>
