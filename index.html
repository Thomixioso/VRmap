<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktivn√≠ mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="module" src="https://stereo-img.steren.fr/stereo-img.js"></script>
    
    <!-- Polyfill pro WebXR -->
    <script src='https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js'></script>
    <script>
        window.polyfill = new WebXRPolyfill();
    </script>
    
    <style>
        #map { height: 400px; }
        #detailsContainer { margin-top: 20px; }
        #imageContainer img { max-width: 100%; height: auto; }
        #vrContainer {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 1000;
        }
        #vrContainer.active { display: block; }
        #exitButton {
            position: absolute;
            top: 10px; right: 10px;
            padding: 15px 20px; 
            background: rgba(255,255,255,0.9); 
            color: black; 
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1001;
        }
        #exitButton:hover {
            background: white;
        }
        .controller {
            position: absolute;
            bottom: 20px;
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #leftController { left: 20px; }
        #rightController { right: 20px; }
        #errorMessage { color: red; margin-top: 10px; }
        #vrStatus {
            position: absolute;
            top: 60px; left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .vr-button {
            background: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .vr-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="detailsContainer"></div>
    <div id="imageContainer"></div>
    <div id="vrContainer">
        <button id="exitButton" onclick="exitVR()">‚úï Exit VR</button>
        <div id="vrStatus">VR Mode Active - Use controller buttons or touch to exit</div>
        <div id="leftController" class="controller">Left: Trigger/Grip to exit</div>
        <div id="rightController" class="controller">Right: A/B/X/Y to exit</div>
    </div>
    <div id="errorMessage"></div>

    <script>
        let map = L.map('map').setView([50.0755, 14.4378], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let xrSession = null;
        let currentStereoImg = null;

        // Testovac√≠ data - pou≈æijte va≈°e data.json
        const testData = [
            {
                "name": "Le_Castillet",
                "category": "Castles",
                "lat": 42.70064,
                "lon": 2.89412,
                "txtFile": "Castles/Le_Castillet.txt",
                "image": "Castles/generated/Le_Castillet_generated.jpg"
            },
            {
                "name": "Moulton",
                "category": "Castles", 
                "lat": 52.77328,
                "lon": -0.05583,
                "txtFile": "Castles/Moulton.txt",
                "image": "Castles/generated/Moulton_generated.jpg"
            }
        ];

        // Inicializace mapy s testovac√≠mi daty
        function initializeMap() {
            testData.forEach(location => {
                let marker = L.marker([location.lat, location.lon]).addTo(map);
                marker.bindPopup(location.name);
                marker.on('click', () => showLocationDetails(location));
            });
        }

        // Naƒçten√≠ skuteƒçn√Ωch dat (pokud existuj√≠)
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Nepoda≈ôilo se naƒç√≠st data.json: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // Vyƒçistit testovac√≠ markery
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                
                // P≈ôidat skuteƒçn√° data
                if (Array.isArray(data)) {
                    data.forEach(location => {
                        let marker = L.marker([location.lat, location.lon]).addTo(map);
                        marker.bindPopup(location.name);
                        marker.on('click', () => showLocationDetails(location));
                    });
                } else {
                    throw new Error('Data.json nem√° oƒçek√°vanou strukturu.');
                }
            })
            .catch(error => {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', error);
                console.log('Pou≈æ√≠v√°m testovac√≠ data');
                document.getElementById('errorMessage').innerHTML = '<p>Pou≈æ√≠v√°m testovac√≠ data - data.json nenalezen</p>';
                initializeMap();
            });

        function showLocationDetails(location) {
            let details = document.getElementById('detailsContainer');
            details.innerHTML = `
                <h2>${location.name}</h2>
                <p><strong>Kategorie:</strong> ${location.category}</p>
                <p id="description">Naƒç√≠t√°n√≠ popisu...</p>
            `;

            // Naƒç√≠st popis z TXT souboru
            if (location.txtFile) {
                fetch(location.txtFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Nepoda≈ôilo se naƒç√≠st TXT soubor');
                        }
                        return response.text();
                    })
                    .then(text => {
                        document.getElementById('description').innerHTML = text.replace(/\n/g, '<br>');
                    })
                    .catch(error => {
                        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ TXT:', error);
                        document.getElementById('description').innerHTML = 'Popis nen√≠ k dispozici.';
                    });
            } else {
                document.getElementById('description').innerHTML = 'Popis nen√≠ k dispozici.';
            }

            let imageContainer = document.getElementById('imageContainer');
            imageContainer.innerHTML = '';

            // Zobrazit obr√°zek
            let img = document.createElement('img');
            img.src = location.image;
            img.alt = location.name;
            img.onerror = () => {
                imageContainer.innerHTML = '<p>Chyba p≈ôi naƒç√≠t√°n√≠ obr√°zku.</p>';
            };
            imageContainer.appendChild(img);

            // P≈ôidat VR tlaƒç√≠tko - KL√çƒåOV√â: u≈æivatel mus√≠ p≈ô√≠mo kliknout
            const vrButton = document.createElement('button');
            vrButton.className = 'vr-button';
            vrButton.textContent = 'ü•Ω Enter VR';
            vrButton.onclick = (event) => {
                // Zabr√°nit event bubbling—É
                event.preventDefault();
                event.stopPropagation();
                
                // P≈ô√≠mo spustit VR - mus√≠ b√Ωt p≈ô√≠m√° akce u≈æivatele
                enterVRMode(location.image);
            };
            details.appendChild(vrButton);

            // P≈ôidat informace o VR
            const vrInfo = document.createElement('p');
            vrInfo.innerHTML = '<small>üí° Pro VR pou≈æijte ovladaƒçe nebo dotknƒõte se obrazovky pro ukonƒçen√≠</small>';
            details.appendChild(vrInfo);
        }

        async function enterVRMode(imagePath) {
            console.log('Spou≈°t√≠m VR mode pro:', imagePath);
            
            const vrContainer = document.getElementById('vrContainer');
            
            try {
                // Vyƒçistit p≈ôedchoz√≠ obsah
                const existingStereoImg = vrContainer.querySelector('stereo-img');
                if (existingStereoImg) {
                    existingStereoImg.remove();
                }
                
                // Vytvo≈ôit novou stereo-img komponentu
                currentStereoImg = document.createElement('stereo-img');
                currentStereoImg.src = imagePath;
                currentStereoImg.type = 'left-right'; // Upravte podle va≈°ich obr√°zk≈Ø
                currentStereoImg.angle = '180';
                currentStereoImg.style.width = '100%';
                currentStereoImg.style.height = '100%';
                
                vrContainer.appendChild(currentStereoImg);
                vrContainer.classList.add('active');

                // Poƒçkat na inicializaci stereo-img komponenty
                await new Promise(resolve => setTimeout(resolve, 100));

                // Pokusit se spustit VR session
                if (navigator.xr) {
                    try {
                        console.log('Kontrolujem VR podporu...');
                        const isSupported = await navigator.xr.isSessionSupported('immersive-vr');
                        
                        if (isSupported) {
                            console.log('Spou≈°t√≠m VR session...');
                            xrSession = await navigator.xr.requestSession('immersive-vr');
                            
                            xrSession.addEventListener('end', () => {
                                console.log('VR session ukonƒçena');
                                xrSession = null;
                                exitVR();
                            });
                            
                            console.log('VR session √∫spƒõ≈°nƒõ spu≈°tƒõna');
                        } else {
                            console.log('VR nen√≠ podporov√°no na tomto za≈ô√≠zen√≠');
                        }
                    } catch (error) {
                        console.error('Chyba p≈ôi spou≈°tƒõn√≠ VR session:', error);
                    }
                } else {
                    console.log('WebXR nen√≠ dostupn√©');
                }

            } catch (error) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ VR view:', error);
                exitVR();
            }
        }

        function exitVR() {
            console.log('Ukonƒçuji VR mode');
            
            const vrContainer = document.getElementById('vrContainer');
            vrContainer.classList.remove('active');
            
            // Vyƒçistit stereo-img komponentu
            if (currentStereoImg) {
                currentStereoImg.remove();
                currentStereoImg = null;
            }

            // Ukonƒçit XR session
            if (xrSession) {
                xrSession.end().then(() => {
                    xrSession = null;
                    console.log('XR session ukonƒçena');
                }).catch(err => {
                    console.error('Chyba p≈ôi ukonƒçen√≠ XR session:', err);
                    xrSession = null;
                });
            }
        }

        // Poslouch√°n√≠ kl√°vesov√Ωch zkratek
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                exitVR();
            }
        });

        // Vylep≈°en√° detekce ovladaƒç≈Ø pro Meta Quest 3
        function checkGamepads() {
            const gamepads = navigator.getGamepads();
            
            if (gamepads && vrContainer.classList.contains('active')) {
                for (let i = 0; i < gamepads.length; i++) {
                    const gamepad = gamepads[i];
                    
                    if (gamepad && gamepad.connected) {
                        // Meta Quest 3 ovladaƒçe - detekce r≈Øzn√Ωch tlaƒç√≠tek
                        let shouldExit = false;
                        
                        // Trigger tlaƒç√≠tka (index 0 a 1)
                        if (gamepad.buttons[0] && gamepad.buttons[0].pressed) {
                            shouldExit = true;
                        }
                        if (gamepad.buttons[1] && gamepad.buttons[1].pressed) {
                            shouldExit = true;
                        }
                        
                        // Grip tlaƒç√≠tka (index 2 a 3) 
                        if (gamepad.buttons[2] && gamepad.buttons[2].pressed) {
                            shouldExit = true;
                        }
                        if (gamepad.buttons[3] && gamepad.buttons[3].pressed) {
                            shouldExit = true;
                        }
                        
                        // A, B, X, Y tlaƒç√≠tka (obvykle index 4, 5, 6, 7)
                        for (let btnIndex = 4; btnIndex < Math.min(gamepad.buttons.length, 8); btnIndex++) {
                            if (gamepad.buttons[btnIndex] && gamepad.buttons[btnIndex].pressed) {
                                shouldExit = true;
                                break;
                            }
                        }
                        
                        // Thumbstick press (obvykle index 8, 9)
                        if (gamepad.buttons[8] && gamepad.buttons[8].pressed) {
                            shouldExit = true;
                        }
                        if (gamepad.buttons[9] && gamepad.buttons[9].pressed) {
                            shouldExit = true;
                        }
                        
                        // Menu tlaƒç√≠tko (obvykle index 10 nebo 11)
                        if (gamepad.buttons[10] && gamepad.buttons[10].pressed) {
                            shouldExit = true;
                        }
                        if (gamepad.buttons[11] && gamepad.buttons[11].pressed) {
                            shouldExit = true;
                        }
                        
                        // Detekce pohybu thumbstick
                        if (gamepad.axes && gamepad.axes.length >= 4) {
                            // Lev√Ω thumbstick (axes 0, 1) a prav√Ω thumbstick (axes 2, 3)
                            const leftStickX = Math.abs(gamepad.axes[0] || 0);
                            const leftStickY = Math.abs(gamepad.axes[1] || 0);
                            const rightStickX = Math.abs(gamepad.axes[2] || 0);
                            const rightStickY = Math.abs(gamepad.axes[3] || 0);
                            
                            // Pokud je thumbstick posunut v√≠ce ne≈æ 70% v jak√©mkoli smƒõru
                            if (leftStickX > 0.7 || leftStickY > 0.7 || rightStickX > 0.7 || rightStickY > 0.7) {
                                shouldExit = true;
                            }
                        }
                        
                        if (shouldExit) {
                            console.log('Gamepad tlaƒç√≠tko stisknuto - ukonƒçuji VR');
                            exitVR();
                            return;
                        }
                    }
                }
            }
            
            // Pou≈æ√≠t requestAnimationFrame pro lep≈°√≠ v√Ωkon
            requestAnimationFrame(checkGamepads);
        }

        // Spustit kontrolu gamepad≈Ø
        checkGamepads();

        // Touch events pro mobiln√≠ za≈ô√≠zen√≠
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', (e) => {
            if (vrContainer.classList.contains('active')) {
                touchStartTime = Date.now();
            }
        });
        
        document.addEventListener('touchend', (e) => {
            if (vrContainer.classList.contains('active')) {
                const touchDuration = Date.now() - touchStartTime;
                // Dlouh√Ω dotek (v√≠ce ne≈æ 500ms) ukonƒç√≠ VR
                if (touchDuration > 500) {
                    console.log('Dlouh√Ω dotek - ukonƒçuji VR');
                    exitVR();
                }
            }
        });

        // Debug informace
        console.log('VR mapa inicializov√°na');
        console.log('WebXR dostupn√©:', !!navigator.xr);
        
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                console.log('VR session podporov√°na:', supported);
            });
        }
    </script>
</body>
</html>
