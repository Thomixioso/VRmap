<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktivn√≠ mapa s VR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        /* Mapa p≈ôes cel√Ω obraz */
        #map { 
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* Layer control styling */
        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Progress bar pro naƒç√≠t√°n√≠ VR */
        #loadingProgress {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2500;
            text-align: center;
            min-width: 300px;
        }
        
        #loadingProgress.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007cba, #00a8e6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .progress-percent {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Popup ok√©nko nad markerem */
        #detailsPopup {
            display: none;
            position: fixed;
            width: 250px;
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            pointer-events: auto;
        }
        
        #detailsPopup.active {
            display: block;
        }
        
        #closePopup {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        #closePopup:hover {
            background: #cc0000;
        }
        
        #detailsPopup h3 {
            margin: 0 20px 10px 0;
            font-size: 16px;
        }
        
        #detailsPopup p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        /* VR Container - fullscreen overlay */
        #vrContainer {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: #000;
            z-index: 2000;
        }
        
        #vrContainer.active { 
            display: block; 
        }
        
        /* VR Viewer styles */
        #vrViewer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #vrViewer canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #vr-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 25px;
            z-index: 100;
        }
        
        #vr-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        #vr-status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        #exitVRButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: black;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        .enter-vr-btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 15px 25px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
        }
        
        .enter-vr-btn:hover {
            background: #005a87;
        }
        
        #errorMessage { 
            color: red; 
            margin-top: 10px; 
        }
        
        /* Responsive popup */
        @media (max-width: 768px) {
            #detailsPopup {
                top: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                max-height: 50vh;
            }
        }
    </style>
    </head>
<body>
    <!-- Mapa p≈ôes cel√Ω obraz -->
    <div id="map"></div>
    
    <!-- Progress bar pro naƒç√≠t√°n√≠ VR -->
    <div id="loadingProgress">
        <div class="progress-text">Naƒç√≠t√°n√≠ VR obr√°zku...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-percent" id="progressPercent">0%</div>
    </div>
    
    <!-- Mal√© popup ok√©nko pro detaily m√≠sta -->
    <div id="detailsPopup">
        <button id="closePopup" onclick="closeDetailsPopup()">&times;</button>
        <div id="popupContent"></div>
    </div>
    
    <!-- VR Container s va≈°√≠m funkƒçn√≠m VR viewerem -->
    <div id="vrContainer">
        <button id="exitVRButton" onclick="exitVR()">Exit VR</button>
        <div id="vrViewer">
            <div id="vr-status">Naƒç√≠t√°n√≠...</div>
            <button id="vr-button" style="display: none;">Enter VR</button>
        </div>
    </div>
    
    <div id="errorMessage"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js",
            "three/": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // Leaflet mapa s r≈Øzn√Ωmi layery - p≈ôes cel√Ω obraz
        let map = L.map('map').setView([50.0755, 14.4378], 6);
        
        // R≈Øzn√© tile layery
        let osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });
        
        let satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri'
        });
        
        let topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap'
        });
        
        let cartoDarkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CartoDB'
        });
        
        let cartoLightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CartoDB'
        });
        
        // Hybrid layer (satelitn√≠ + popisky)
        let hybridGroup = L.layerGroup([
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}')
        ]);
        
        // P≈ôidat v√Ωchoz√≠ layer
        osmLayer.addTo(map);
        
        // Definice layer≈Ø pro control
        let baseLayers = {
            "üó∫Ô∏è Standardn√≠": osmLayer,
            "üõ∞Ô∏è Satelitn√≠": satelliteLayer,
            "üèîÔ∏è Topografick√°": topoLayer,
            "üåì Tmav√Ω re≈æim": cartoDarkLayer,
            "‚òÄÔ∏è Svƒõtl√Ω re≈æim": cartoLightLayer,
            "üõ∞Ô∏è Hybrid (sat + popisky)": hybridGroup
        };
        
        // P≈ôidat layer control
        L.control.layers(baseLayers).addTo(map);

        // VR Viewer promƒõnn√©
        let scene, camera, renderer;
        let leftSphere, rightSphere;
        let vrButton;
        let currentImagePath = '';
        let lastMapView = null; // Ulo≈æit posledn√≠ pozici mapy

        // Data m√≠st
        const locations = [
            {
                "name": "Le_Castillet",
                "category": "Castles",
                "lat": 42.70064,
                "lon": 2.89412,
                "txtFile": "Castles/Le_Castillet.txt",
                "image": "Castles/generated/Le_Castillet_generated.jpg"
            },
            {
                "name": "Moulton",
                "category": "Castles",
                "lat": 52.77328,
                "lon": -0.05583,
                "txtFile": "Castles/Moulton.txt",
                "image": "Castles/generated/Moulton_generated.jpg"
            },
            {
                "name": "Old_Hall_Camp",
                "category": "Castles",
                "lat": 52.49951,
                "lon": -3.17018,
                "txtFile": "Castles/Old_Hall_Camp.txt",
                "image": "Castles/generated/Old_Hall_Camp_generated.jpg"
            },
            {
                "name": "Stockbury_Castle",
                "category": "Castles",
                "lat": 51.32391,
                "lon": 0.6476,
                "txtFile": "Castles/Stockbury_Castle.txt",
                "image": "Castles/generated/Stockbury_Castle_generated.jpg"
            },
            {
                "name": "Cristo_Redentore",
                "category": "Historical_sites",
                "lat": 42.8633,
                "lon": 13.57593,
                "txtFile": "Historical_sites/Cristo_Redentore.txt",
                "image": "Historical_sites/generated/Cristo_Redentore_generated.jpg"
            },
            {
                "name": "Heimkehrerdenkmal",
                "category": "Historical_sites",
                "lat": 51.41575,
                "lon": 9.90878,
                "txtFile": "Historical_sites/Heimkehrerdenkmal.txt",
                "image": "Historical_sites/generated/Heimkehrerdenkmal_generated.jpg"
            },
            {
                "name": "Henry_Wadsworth_Longfellow_Statue",
                "category": "Historical_sites",
                "lat": 38.90594,
                "lon": -77.04109,
                "txtFile": "Historical_sites/Henry_Wadsworth_Longfellow_Statue.txt",
                "image": "Historical_sites/generated/Henry_Wadsworth_Longfellow_Statue_generated.jpg"
            },
            {
                "name": "Homenagem_a_D._Miguel",
                "category": "Historical_sites",
                "lat": 41.09725,
                "lon": -7.80658,
                "txtFile": "Historical_sites/Homenagem_a_D._Miguel.txt",
                "image": "Historical_sites/generated/Homenagem_a_D._Miguel_generated.jpg"
            },
            {
                "name": "Monumento_al_Ahogado_(Los_Dedos)",
                "category": "Historical_sites",
                "lat": -34.95783,
                "lon": -54.93722,
                "txtFile": "Historical_sites/Monumento_al_Ahogado_(Los_Dedos).txt",
                "image": "Historical_sites/generated/Monumento_al_Ahogado_(Los_Dedos)_generated.jpg"
            },
            {
                "name": "Walhalla",
                "category": "Historical_sites",
                "lat": 49.03126,
                "lon": 12.22409,
                "txtFile": "Historical_sites/Walhalla.txt",
                "image": "Historical_sites/generated/Walhalla_generated.jpg"
            },
            {
                "name": "Brookwood_Park",
                "category": "Parks",
                "lat": 30.66547,
                "lon": -88.23667,
                "txtFile": "Parks/Brookwood_Park.txt",
                "image": "Parks/generated/Brookwood_Park_generated.jpg"
            },
            {
                "name": "Dorandoran-gongwon",
                "category": "Parks",
                "lat": 37.39807,
                "lon": 126.63758,
                "txtFile": "Parks/Dorandoran-gongwon.txt",
                "image": "Parks/generated/Dorandoran-gongwon_generated.jpg"
            },
            {
                "name": "Garden_Grove_Park",
                "category": "Parks",
                "lat": 33.76252,
                "lon": -117.96645,
                "txtFile": "Parks/Garden_Grove_Park.txt",
                "image": "Parks/generated/Garden_Grove_Park_generated.jpg"
            },
            {
                "name": "Lake_George_Battlefield_Park",
                "category": "Parks",
                "lat": 43.41646,
                "lon": -73.70845,
                "txtFile": "Parks/Lake_George_Battlefield_Park.txt",
                "image": "Parks/generated/Lake_George_Battlefield_Park_generated.jpg"
            },
            {
                "name": "Parc_James-Palmer",
                "category": "Parks",
                "lat": 45.36338,
                "lon": -73.71699,
                "txtFile": "Parks/Parc_James-Palmer.txt",
                "image": "Parks/generated/Parc_James-Palmer_generated.jpg"
            }
        ];

        // P≈ôidat markery na mapu
        locations.forEach(location => {
            let marker = L.marker([location.lat, location.lon]).addTo(map);
            marker.bindPopup(location.name);
            marker.on('click', (e) => showLocationDetails(location, e));
        });

        function updateStatus(message) {
            document.getElementById('vr-status').textContent = message;
        }

        function showLocationDetails(location, event) {
            const popup = document.getElementById('detailsPopup');
            const content = document.getElementById('popupContent');
            
            // Z√≠skat pozici markeru na obrazovce
            const markerLatLng = event.target.getLatLng();
            const markerPoint = map.latLngToContainerPoint(markerLatLng);
            
            content.innerHTML = `
                <h3>${location.name}</h3>
                <p><strong>Kategorie:</strong> ${location.category}</p>
                <p id="description">Naƒç√≠t√°n√≠ popisu...</p>
                <button class="enter-vr-btn" id="enterVRBtn">Enter VR</button>
            `;
            
            // Um√≠stit popup nad marker
            popup.style.left = (markerPoint.x - 125) + 'px'; // Centrovat nad markerem
            popup.style.top = (markerPoint.y - 180) + 'px';  // Nad markerem
            
            // P≈ôidat event listener pro VR tlaƒç√≠tko - p≈ô√≠m√Ω vstup do VR
            document.getElementById('enterVRBtn').addEventListener('click', () => {
                openVRViewDirect(location.image);
            });
            
            popup.classList.add('active');

            // Naƒç√≠st popis z TXT souboru
            fetch(location.txtFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Nepoda≈ôilo se naƒç√≠st TXT soubor: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(text => {
                    document.getElementById('description').innerHTML = text.replace(/\n/g, '<br>');
                })
                .catch(error => {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ TXT:', error);
                    document.getElementById('description').innerHTML = 'Chyba: Nepoda≈ôilo se naƒç√≠st popis z TXT souboru.';
                });
        }

        function closeDetailsPopup() {
            const popup = document.getElementById('detailsPopup');
            popup.classList.remove('active');
        }

        function openVRViewDirect(imagePath) {
            // Ulo≈æit aktu√°ln√≠ pozici mapy
            lastMapView = {
                center: map.getCenter(),
                zoom: map.getZoom()
            };
            
            // Zav≈ô√≠t popup
            closeDetailsPopup();
            
            // Zobrazit progress bar
            showLoadingProgress();
            
            currentImagePath = imagePath;
            const vrContainer = document.getElementById('vrContainer');
            vrContainer.classList.add('active');
            
            // Inicializovat VR viewer a automaticky spustit VR
            initVRViewerAndStart();
        }
        
        function showLoadingProgress() {
            const progressDiv = document.getElementById('loadingProgress');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            progressDiv.classList.add('active');
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
        }
        
        function updateLoadingProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
        }
        
        function hideLoadingProgress() {
            const progressDiv = document.getElementById('loadingProgress');
            progressDiv.classList.remove('active');
        }

        function initVRViewerAndStart() {
            updateStatus('Inicializace...');
            
            // Sc√©na
            scene = new THREE.Scene();
            
            // Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0);
            
            // Renderer s WebXR - zkus√≠me local m√≠sto viewer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local'); // Local pro head tracking
            
            document.getElementById('vrViewer').appendChild(renderer.domElement);
            
            // Naƒçten√≠ stereo obr√°zku a automatick√© spu≈°tƒõn√≠ VR
            loadStereoImageAndStartVR();
            
            // Mouse/touch kontrol pro non-VR
            setupControls();
            
            // Render loop
            renderer.setAnimationLoop(render);
        }

        function loadStereoImageAndStartVR() {
            updateStatus('Naƒç√≠t√°n√≠ obr√°zku...');
            updateLoadingProgress(5); // Zaƒçneme s 5%
            
            const loader = new THREE.TextureLoader();
            
            // Pou≈æ√≠t XMLHttpRequest pro lep≈°√≠ tracking progressu
            const xhr = new XMLHttpRequest();
            xhr.open('GET', currentImagePath, true);
            xhr.responseType = 'blob';
            
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 85); // 85% pro download
                    updateLoadingProgress(Math.max(5, percent));
                    updateStatus(`Stahov√°n√≠... ${percent}%`);
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    updateLoadingProgress(90);
                    updateStatus('Zpracov√°n√≠ obr√°zku...');
                    
                    // Vytvo≈ôit URL z blob a naƒç√≠st jako texturu
                    const blob = xhr.response;
                    const imageUrl = URL.createObjectURL(blob);
                    
                    loader.load(
                        imageUrl,
                        (texture) => {
                            updateLoadingProgress(95);
                            updateStatus('Vytv√°≈ôen√≠ VR sc√©ny...');
                            
                            createStereoSpheres(texture);
                            
                            updateLoadingProgress(100);
                            updateStatus('Spou≈°t√≠m VR...');
                            
                            // Poƒçkat na kompletn√≠ inicializaci p≈ôed spu≈°tƒõn√≠m VR
                            setTimeout(() => {
                                hideLoadingProgress();
                                startVRAutomatically();
                            }, 800); // Del≈°√≠ pauza pro stabilitu
                            
                            // Vyƒçistit blob URL
                            URL.revokeObjectURL(imageUrl);
                        },
                        undefined,
                        (error) => {
                            console.error('Texture load error:', error);
                            updateStatus('Chyba p≈ôi zpracov√°n√≠ textury');
                            hideLoadingProgress();
                        }
                    );
                } else {
                    throw new Error('HTTP Error: ' + xhr.status);
                }
            };
            
            xhr.onerror = function() {
                console.error('Network error during image download');
                updateStatus('Chyba p≈ôi stahov√°n√≠ obr√°zku');
                hideLoadingProgress();
            };
            
            xhr.ontimeout = function() {
                console.error('Download timeout');
                updateStatus('Timeout p≈ôi stahov√°n√≠ - zkuste to znovu');
                hideLoadingProgress();
            };
            
            xhr.timeout = 30000; // 30 sekund timeout
            xhr.send();
        }

        async function startVRAutomatically() {
            if (!navigator.xr) {
                updateStatus('WebXR nen√≠ podporov√°n');
                return;
            }
            
            try {
                updateStatus('Spou≈°t√≠m VR...');
                
                // Zkus√≠me local reference space pro head tracking
                renderer.xr.setReferenceSpaceType('local');
                
                // Po≈æ√°dat o VR session s local jako optional feature
                const session = await navigator.xr.requestSession('immersive-vr', {
                    optionalFeatures: ['local']
                });
                
                await renderer.xr.setSession(session);
                
                // Nastaven√≠ kamer pro ka≈æd√© oko
                setupEyeLayers();
                
                // P≈ôidat controller exit s p≈ô√≠m√Ωm n√°vratem na mapu
                session.addEventListener('selectstart', () => {
                    session.end();
                    exitVR(); // P≈ô√≠m√Ω n√°vrat na mapu
                });
                
                updateStatus('VR aktivn√≠');
                
                session.addEventListener('end', () => {
                    updateStatus('VR ukonƒçeno');
                    exitVR(); // P≈ô√≠m√Ω n√°vrat na mapu i p≈ôi jin√©m ukonƒçen√≠
                });
                
            } catch (error) {
                console.error('VR Error - zkou≈°√≠m fallback na viewer:', error);
                
                // Fallback na viewer pokud local sel≈æe
                try {
                    updateStatus('Fallback na viewer...');
                    renderer.xr.setReferenceSpaceType('viewer');
                    
                    const session = await navigator.xr.requestSession('immersive-vr');
                    await renderer.xr.setSession(session);
                    
                    setupEyeLayers();
                    
                    // P≈ôidar controller exit s p≈ô√≠m√Ωm n√°vratem na mapu
                    session.addEventListener('selectstart', () => {
                        session.end();
                        exitVR(); // P≈ô√≠m√Ω n√°vrat na mapu
                    });
                    
                    updateStatus('VR aktivn√≠ (viewer mode)');
                    
                    session.addEventListener('end', () => {
                        updateStatus('VR ukonƒçeno');
                        exitVR(); // P≈ô√≠m√Ω n√°vrat na mapu
                    });
                    
                } catch (fallbackError) {
                    console.error('Fallback tak√© selhal:', fallbackError);
                    updateStatus('VR nedostupn√©');
                }
            }
        }

        function exitVR() {
            const vrContainer = document.getElementById('vrContainer');
            vrContainer.classList.remove('active');
            
            // Skr√Ωt progress bar pro p≈ô√≠pad ≈æe se zobrazuje
            hideLoadingProgress();
            
            // Vyƒçistit VR viewer
            if (renderer) {
                renderer.dispose();
                renderer = null;
            }
            if (scene) {
                scene.clear();
                scene = null;
            }
            
            // Vyƒçistit DOM
            const vrViewer = document.getElementById('vrViewer');
            const canvas = vrViewer.querySelector('canvas');
            if (canvas) {
                canvas.remove();
            }
            
            // Vr√°tit se na stejnou pozici mapy
            if (lastMapView) {
                map.setView(lastMapView.center, lastMapView.zoom);
            }
        }

        // V√Å≈† FUNKƒåN√ç VR VIEWER K√ìD
        function initVRViewer() {
            updateStatus('Inicializace...');
            
            // Sc√©na
            scene = new THREE.Scene();
            
            // Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0);
            
            // Renderer s WebXR - zkus√≠me local m√≠sto viewer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local'); // Local pro head tracking
            
            document.getElementById('vrViewer').appendChild(renderer.domElement);
            
            // VR Button
            setupVRButton();
            
            // Naƒçten√≠ stereo obr√°zku
            loadStereoImage();
            
            // Mouse/touch kontrol pro non-VR
            setupControls();
            
            // Render loop
            renderer.setAnimationLoop(render);
        }

        function setupVRButton() {
            vrButton = document.getElementById('vr-button');
            
            if (!navigator.xr) {
                updateStatus('WebXR nen√≠ podporov√°n');
                return;
            }
            
            navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                if (supported) {
                    vrButton.style.display = 'block';
                    vrButton.textContent = 'Enter VR';
                    vrButton.onclick = startVR;
                } else {
                    updateStatus('VR nen√≠ podporov√°no');
                }
            }).catch(() => {
                updateStatus('Chyba p≈ôi kontrole VR podpory');
            });
        }

        async function startVR() {
            try {
                updateStatus('Spou≈°t√≠m VR session...');
                console.log('Requesting VR session...');
                
                // Zkus√≠me local reference space pro head tracking
                renderer.xr.setReferenceSpaceType('local');
                console.log('Reference space type nastaven na local');
                
                // Po≈æ√°dat o VR session s local jako optional feature
                const session = await navigator.xr.requestSession('immersive-vr', {
                    optionalFeatures: ['local']
                });
                console.log('VR session vytvo≈ôen:', session);
                
                updateStatus('Nastavuji renderer...');
                console.log('Setting XR session on renderer...');
                
                await renderer.xr.setSession(session);
                console.log('Renderer XR session nastaven');
                
                // Nastaven√≠ kamer pro ka≈æd√© oko
                setupEyeLayers();
                console.log('Eye layers nastaveny');
                
                // POUZE p≈ôidat controller exit
                session.addEventListener('selectstart', () => {
                    session.end();
                });
                
                vrButton.style.display = 'none';
                updateStatus('VR aktivn√≠');
                
                session.addEventListener('end', () => {
                    vrButton.style.display = 'block';
                    updateStatus('VR ukonƒçeno');
                    console.log('VR session ukonƒçen');
                });
                
            } catch (error) {
                console.error('VR Error - zkou≈°√≠m fallback na viewer:', error);
                
                // Fallback na viewer pokud local sel≈æe
                try {
                    updateStatus('Fallback na viewer...');
                    renderer.xr.setReferenceSpaceType('viewer');
                    
                    const session = await navigator.xr.requestSession('immersive-vr');
                    await renderer.xr.setSession(session);
                    
                    setupEyeLayers();
                    
                    // POUZE p≈ôidat controller exit i pro fallback
                    session.addEventListener('selectstart', () => {
                        session.end();
                    });
                    
                    vrButton.style.display = 'none';
                    updateStatus('VR aktivn√≠ (viewer mode)');
                    
                    session.addEventListener('end', () => {
                        vrButton.style.display = 'block';
                        updateStatus('VR ukonƒçeno');
                    });
                    
                } catch (fallbackError) {
                    console.error('Fallback tak√© selhal:', fallbackError);
                    updateStatus('VR nedostupn√©');
                }
            }
        }

        function setupEyeLayers() {
            // Konfigurace vrstev pro stereo zobrazen√≠
            camera.layers.enableAll();
            
            if (leftSphere) leftSphere.layers.set(1);
            if (rightSphere) rightSphere.layers.set(2);
        }

        function loadStereoImage() {
            updateStatus('Naƒç√≠t√°n√≠ obr√°zku...');
            
            const loader = new THREE.TextureLoader();
            loader.load(
                currentImagePath,
                (texture) => {
                    updateStatus('Zpracov√°n√≠ stereo obr√°zku...');
                    createStereoSpheres(texture);
                },
                (progress) => {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    updateStatus(`Naƒç√≠t√°n√≠... ${percent}%`);
                },
                (error) => {
                    console.error('Load error:', error);
                    updateStatus('Chyba p≈ôi naƒç√≠t√°n√≠: ' + currentImagePath);
                }
            );
        }

        function createStereoSpheres(originalTexture) {
            // Rozdƒõlen√≠ side-by-side obr√°zku
            const leftTexture = splitTexture(originalTexture, 'left');
            const rightTexture = splitTexture(originalTexture, 'right');
            
            // Geometrie pro 180¬∞ zobrazen√≠
            const geometry = new THREE.SphereGeometry(
                500,  // radius
                60,   // widthSegments
                40,   // heightSegments
                0,    // phiStart (zaƒç√°tek horizont√°lnƒõ)
                Math.PI, // phiLength (180¬∞)
                0,    // thetaStart
                Math.PI  // thetaLength
            );
            
            // Invertovat pro vnit≈ôn√≠ zobrazen√≠
            geometry.scale(-1, 1, 1);
            
            // Materi√°ly
            const leftMaterial = new THREE.MeshBasicMaterial({
                map: leftTexture,
                side: THREE.FrontSide
            });
            
            const rightMaterial = new THREE.MeshBasicMaterial({
                map: rightTexture,
                side: THREE.FrontSide
            });
            
            // Vytvo≈ôen√≠ sf√©r
            leftSphere = new THREE.Mesh(geometry.clone(), leftMaterial);
            rightSphere = new THREE.Mesh(geometry.clone(), rightMaterial);
            
            // Otoƒçen√≠ sf√©r tak, aby obr√°zek byl p≈ôed n√°mi
            leftSphere.rotation.y = Math.PI;
            rightSphere.rotation.y = Math.PI;
            
            // Nastaven√≠ vrstev pro stereo zobrazen√≠
            leftSphere.layers.set(1);  // Lev√© oko
            rightSphere.layers.set(2); // Prav√© oko
            
            scene.add(leftSphere);
            scene.add(rightSphere);
            
            updateStatus('Stereo obr√°zek naƒçten - kliknƒõte Enter VR');
        }

        function splitTexture(originalTexture, eye) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = originalTexture.image;
            
            // Rozmƒõry pro ka≈æd√© oko (polovina ≈°√≠≈ôky)
            const halfWidth = img.width / 2;
            const height = img.height;
            
            canvas.width = halfWidth;
            canvas.height = height;
            
            // Pozice pro v√Ω≈ôez (left: 0-halfWidth, right: halfWidth-fullWidth)
            const sourceX = eye === 'left' ? 0 : halfWidth;
            
            // Vykreslen√≠ poloviny obr√°zku
            ctx.drawImage(img, sourceX, 0, halfWidth, height, 0, 0, halfWidth, height);
            
            // Vytvo≈ôen√≠ textury z canvas
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.ClampToEdgeWrapping;
            texture.wrapT = THREE.ClampToEdgeWrapping;
            texture.minFilter = THREE.LinearFilter;
            texture.generateMipmaps = false;
            
            return texture;
        }

        function setupControls() {
            let isPointerDown = false;
            let pointerX = 0, pointerY = 0;
            let rotationX = 0, rotationY = 0;
            
            const canvas = renderer.domElement;
            
            // Mouse ud√°losti
            canvas.addEventListener('mousedown', (e) => {
                isPointerDown = true;
                pointerX = e.clientX;
                pointerY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isPointerDown) return;
                
                const deltaX = e.clientX - pointerX;
                const deltaY = e.clientY - pointerY;
                
                rotationY += deltaX * 0.005;
                rotationX += deltaY * 0.005;
                
                // Omezen√≠ vertik√°ln√≠ rotace
                rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotationX));
                
                camera.rotation.x = rotationX;
                camera.rotation.y = rotationY;
                
                pointerX = e.clientX;
                pointerY = e.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                isPointerDown = false;
            });
            
            // Touch ud√°losti
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isPointerDown = true;
                    pointerX = e.touches[0].clientX;
                    pointerY = e.touches[0].clientY;
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isPointerDown) {
                    const deltaX = e.touches[0].clientX - pointerX;
                    const deltaY = e.touches[0].clientY - pointerY;
                    
                    rotationY += deltaX * 0.005;
                    rotationX += deltaY * 0.005;
                    
                    rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotationX));
                    
                    camera.rotation.x = rotationX;
                    camera.rotation.y = rotationY;
                    
                    pointerX = e.touches[0].clientX;
                    pointerY = e.touches[0].clientY;
                }
                e.preventDefault();
            });
            
            canvas.addEventListener('touchend', () => {
                isPointerDown = false;
            });
        }

        function render() {
            renderer.render(scene, camera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Escape key listener
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') exitVR();
        });

        // Make functions global for onclick
        window.exitVR = exitVR;
        window.closeDetailsPopup = closeDetailsPopup;
        window.openVRViewDirect = openVRViewDirect;
    </script>
</body>
</html>
