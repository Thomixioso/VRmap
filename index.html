<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktivní mapa s VR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        /* Mapa přes celý obraz */
        #map { 
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* Malé popup okénko pro detaily */
        #detailsPopup {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow-y: auto;
        }
        
        #detailsPopup.active {
            display: block;
        }
        
        #closePopup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        #closePopup:hover {
            background: #cc0000;
        }
        
        .popup-image {
            width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        /* VR Container - fullscreen overlay */
        #vrContainer {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: #000;
            z-index: 2000;
        }
        
        #vrContainer.active { 
            display: block; 
        }
        
        /* VR Viewer styles */
        #vrViewer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #vrViewer canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #vr-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 25px;
            z-index: 100;
        }
        
        #vr-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        #vr-status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        #exitVRButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: black;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        .enter-vr-btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 15px 25px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
        }
        
        .enter-vr-btn:hover {
            background: #005a87;
        }
        
        #errorMessage { 
            color: red; 
            margin-top: 10px; 
        }
        
        /* Responsive popup */
        @media (max-width: 768px) {
            #detailsPopup {
                top: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                max-height: 50vh;
            }
        }
    </style>
    </head>
<body>
    <!-- Mapa přes celý obraz -->
    <div id="map"></div>
    
    <!-- Malé popup okénko pro detaily místa -->
    <div id="detailsPopup">
        <button id="closePopup" onclick="closeDetailsPopup()">&times;</button>
        <div id="popupContent"></div>
    </div>
    
    <!-- VR Container s vaším funkčním VR viewerem -->
    <div id="vrContainer">
        <button id="exitVRButton" onclick="exitVR()">Exit VR</button>
        <div id="vrViewer">
            <div id="vr-status">Načítání...</div>
            <button id="vr-button" style="display: none;">Enter VR</button>
        </div>
    </div>
    
    <div id="errorMessage"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js",
            "three/": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // Leaflet mapa - přes celý obraz
        let map = L.map('map').setView([50.0755, 14.4378], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // VR Viewer proměnné
        let scene, camera, renderer;
        let leftSphere, rightSphere;
        let vrButton;
        let currentImagePath = '';
        let lastMapView = null; // Uložit poslední pozici mapy

        // Data míst
        const locations = [
            {
                "name": "Le_Castillet",
                "category": "Castles",
                "lat": 42.70064,
                "lon": 2.89412,
                "txtFile": "Castles/Le_Castillet.txt",
                "image": "Castles/generated/Le_Castillet_generated.jpg"
            },
            {
                "name": "Moulton",
                "category": "Castles",
                "lat": 52.77328,
                "lon": -0.05583,
                "txtFile": "Castles/Moulton.txt",
                "image": "Castles/generated/Moulton_generated.jpg"
            },
            {
                "name": "Old_Hall_Camp",
                "category": "Castles",
                "lat": 52.49951,
                "lon": -3.17018,
                "txtFile": "Castles/Old_Hall_Camp.txt",
                "image": "Castles/generated/Old_Hall_Camp_generated.jpg"
            },
            {
                "name": "Stockbury_Castle",
                "category": "Castles",
                "lat": 51.32391,
                "lon": 0.6476,
                "txtFile": "Castles/Stockbury_Castle.txt",
                "image": "Castles/generated/Stockbury_Castle_generated.jpg"
            },
            {
                "name": "Cristo_Redentore",
                "category": "Historical_sites",
                "lat": 42.8633,
                "lon": 13.57593,
                "txtFile": "Historical_sites/Cristo_Redentore.txt",
                "image": "Historical_sites/generated/Cristo_Redentore_generated.jpg"
            },
            {
                "name": "Heimkehrerdenkmal",
                "category": "Historical_sites",
                "lat": 51.41575,
                "lon": 9.90878,
                "txtFile": "Historical_sites/Heimkehrerdenkmal.txt",
                "image": "Historical_sites/generated/Heimkehrerdenkmal_generated.jpg"
            },
            {
                "name": "Henry_Wadsworth_Longfellow_Statue",
                "category": "Historical_sites",
                "lat": 38.90594,
                "lon": -77.04109,
                "txtFile": "Historical_sites/Henry_Wadsworth_Longfellow_Statue.txt",
                "image": "Historical_sites/generated/Henry_Wadsworth_Longfellow_Statue_generated.jpg"
            },
            {
                "name": "Homenagem_a_D._Miguel",
                "category": "Historical_sites",
                "lat": 41.09725,
                "lon": -7.80658,
                "txtFile": "Historical_sites/Homenagem_a_D._Miguel.txt",
                "image": "Historical_sites/generated/Homenagem_a_D._Miguel_generated.jpg"
            },
            {
                "name": "Monumento_al_Ahogado_(Los_Dedos)",
                "category": "Historical_sites",
                "lat": -34.95783,
                "lon": -54.93722,
                "txtFile": "Historical_sites/Monumento_al_Ahogado_(Los_Dedos).txt",
                "image": "Historical_sites/generated/Monumento_al_Ahogado_(Los_Dedos)_generated.jpg"
            },
            {
                "name": "Walhalla",
                "category": "Historical_sites",
                "lat": 49.03126,
                "lon": 12.22409,
                "txtFile": "Historical_sites/Walhalla.txt",
                "image": "Historical_sites/generated/Walhalla_generated.jpg"
            },
            {
                "name": "Brookwood_Park",
                "category": "Parks",
                "lat": 30.66547,
                "lon": -88.23667,
                "txtFile": "Parks/Brookwood_Park.txt",
                "image": "Parks/generated/Brookwood_Park_generated.jpg"
            },
            {
                "name": "Dorandoran-gongwon",
                "category": "Parks",
                "lat": 37.39807,
                "lon": 126.63758,
                "txtFile": "Parks/Dorandoran-gongwon.txt",
                "image": "Parks/generated/Dorandoran-gongwon_generated.jpg"
            },
            {
                "name": "Garden_Grove_Park",
                "category": "Parks",
                "lat": 33.76252,
                "lon": -117.96645,
                "txtFile": "Parks/Garden_Grove_Park.txt",
                "image": "Parks/generated/Garden_Grove_Park_generated.jpg"
            },
            {
                "name": "Lake_George_Battlefield_Park",
                "category": "Parks",
                "lat": 43.41646,
                "lon": -73.70845,
                "txtFile": "Parks/Lake_George_Battlefield_Park.txt",
                "image": "Parks/generated/Lake_George_Battlefield_Park_generated.jpg"
            },
            {
                "name": "Parc_James-Palmer",
                "category": "Parks",
                "lat": 45.36338,
                "lon": -73.71699,
                "txtFile": "Parks/Parc_James-Palmer.txt",
                "image": "Parks/generated/Parc_James-Palmer_generated.jpg"
            }
        ];

        // Přidat markery na mapu
        locations.forEach(location => {
            let marker = L.marker([location.lat, location.lon]).addTo(map);
            marker.bindPopup(location.name);
            marker.on('click', () => showLocationDetails(location));
        });

        function updateStatus(message) {
            document.getElementById('vr-status').textContent = message;
        }

        function showLocationDetails(location) {
            const popup = document.getElementById('detailsPopup');
            const content = document.getElementById('popupContent');
            
            content.innerHTML = `
                <h3>${location.name}</h3>
                <p><strong>Kategorie:</strong> ${location.category}</p>
                <img src="${location.image}" alt="${location.name}" class="popup-image" onerror="this.style.display='none'">
                <p id="description">Načítání popisu...</p>
                <button class="enter-vr-btn" id="enterVRBtn">Enter VR</button>
            `;
            
            // Přidat event listener pro VR tlačítko
            document.getElementById('enterVRBtn').addEventListener('click', () => {
                openVRView(location.image);
            });
            
            popup.classList.add('active');

            // Načíst popis z TXT souboru
            fetch(location.txtFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Nepodařilo se načíst TXT soubor: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(text => {
                    document.getElementById('description').innerHTML = text.replace(/\n/g, '<br>');
                })
                .catch(error => {
                    console.error('Chyba při načítání TXT:', error);
                    document.getElementById('description').innerHTML = 'Chyba: Nepodařilo se načíst popis z TXT souboru.';
                });
        }

        function closeDetailsPopup() {
            const popup = document.getElementById('detailsPopup');
            popup.classList.remove('active');
        }

        function openVRView(imagePath) {
            // Uložit aktuální pozici mapy
            lastMapView = {
                center: map.getCenter(),
                zoom: map.getZoom()
            };
            
            // Zavřít popup
            closeDetailsPopup();
            
            currentImagePath = imagePath;
            const vrContainer = document.getElementById('vrContainer');
            vrContainer.classList.add('active');
            
            // Inicializovat VR viewer s novým obrázkem
            initVRViewer();
        }

        function exitVR() {
            const vrContainer = document.getElementById('vrContainer');
            vrContainer.classList.remove('active');
            
            // Vyčistit VR viewer
            if (renderer) {
                renderer.dispose();
                renderer = null;
            }
            if (scene) {
                scene.clear();
                scene = null;
            }
            
            // Vyčistit DOM
            const vrViewer = document.getElementById('vrViewer');
            const canvas = vrViewer.querySelector('canvas');
            if (canvas) {
                canvas.remove();
            }
            
            // Vrátit se na stejnou pozici mapy
            if (lastMapView) {
                map.setView(lastMapView.center, lastMapView.zoom);
            }
        }

        // VÁŠ FUNKČNÍ VR VIEWER KÓD
        function initVRViewer() {
            updateStatus('Inicializace...');
            
            // Scéna
            scene = new THREE.Scene();
            
            // Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0);
            
            // Renderer s WebXR - zkusíme local místo viewer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local'); // Local pro head tracking
            
            document.getElementById('vrViewer').appendChild(renderer.domElement);
            
            // VR Button
            setupVRButton();
            
            // Načtení stereo obrázku
            loadStereoImage();
            
            // Mouse/touch kontrol pro non-VR
            setupControls();
            
            // Render loop
            renderer.setAnimationLoop(render);
        }

        function setupVRButton() {
            vrButton = document.getElementById('vr-button');
            
            if (!navigator.xr) {
                updateStatus('WebXR není podporován');
                return;
            }
            
            navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                if (supported) {
                    vrButton.style.display = 'block';
                    vrButton.textContent = 'Enter VR';
                    vrButton.onclick = startVR;
                } else {
                    updateStatus('VR není podporováno');
                }
            }).catch(() => {
                updateStatus('Chyba při kontrole VR podpory');
            });
        }

        async function startVR() {
            try {
                updateStatus('Spouštím VR session...');
                console.log('Requesting VR session...');
                
                // Zkusíme local reference space pro head tracking
                renderer.xr.setReferenceSpaceType('local');
                console.log('Reference space type nastaven na local');
                
                // Požádat o VR session s local jako optional feature
                const session = await navigator.xr.requestSession('immersive-vr', {
                    optionalFeatures: ['local']
                });
                console.log('VR session vytvořen:', session);
                
                updateStatus('Nastavuji renderer...');
                console.log('Setting XR session on renderer...');
                
                await renderer.xr.setSession(session);
                console.log('Renderer XR session nastaven');
                
                // Nastavení kamer pro každé oko
                setupEyeLayers();
                console.log('Eye layers nastaveny');
                
                // POUZE přidat controller exit
                session.addEventListener('selectstart', () => {
                    session.end();
                });
                
                vrButton.style.display = 'none';
                updateStatus('VR aktivní');
                
                session.addEventListener('end', () => {
                    vrButton.style.display = 'block';
                    updateStatus('VR ukončeno');
                    console.log('VR session ukončen');
                });
                
            } catch (error) {
                console.error('VR Error - zkouším fallback na viewer:', error);
                
                // Fallback na viewer pokud local selže
                try {
                    updateStatus('Fallback na viewer...');
                    renderer.xr.setReferenceSpaceType('viewer');
                    
                    const session = await navigator.xr.requestSession('immersive-vr');
                    await renderer.xr.setSession(session);
                    
                    setupEyeLayers();
                    
                    // POUZE přidat controller exit i pro fallback
                    session.addEventListener('selectstart', () => {
                        session.end();
                    });
                    
                    vrButton.style.display = 'none';
                    updateStatus('VR aktivní (viewer mode)');
                    
                    session.addEventListener('end', () => {
                        vrButton.style.display = 'block';
                        updateStatus('VR ukončeno');
                    });
                    
                } catch (fallbackError) {
                    console.error('Fallback také selhal:', fallbackError);
                    updateStatus('VR nedostupné');
                }
            }
        }

        function setupEyeLayers() {
            // Konfigurace vrstev pro stereo zobrazení
            camera.layers.enableAll();
            
            if (leftSphere) leftSphere.layers.set(1);
            if (rightSphere) rightSphere.layers.set(2);
        }

        function loadStereoImage() {
            updateStatus('Načítání obrázku...');
            
            const loader = new THREE.TextureLoader();
            loader.load(
                currentImagePath,
                (texture) => {
                    updateStatus('Zpracování stereo obrázku...');
                    createStereoSpheres(texture);
                },
                (progress) => {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    updateStatus(`Načítání... ${percent}%`);
                },
                (error) => {
                    console.error('Load error:', error);
                    updateStatus('Chyba při načítání: ' + currentImagePath);
                }
            );
        }

        function createStereoSpheres(originalTexture) {
            // Rozdělení side-by-side obrázku
            const leftTexture = splitTexture(originalTexture, 'left');
            const rightTexture = splitTexture(originalTexture, 'right');
            
            // Geometrie pro 180° zobrazení
            const geometry = new THREE.SphereGeometry(
                500,  // radius
                60,   // widthSegments
                40,   // heightSegments
                0,    // phiStart (začátek horizontálně)
                Math.PI, // phiLength (180°)
                0,    // thetaStart
                Math.PI  // thetaLength
            );
            
            // Invertovat pro vnitřní zobrazení
            geometry.scale(-1, 1, 1);
            
            // Materiály
            const leftMaterial = new THREE.MeshBasicMaterial({
                map: leftTexture,
                side: THREE.FrontSide
            });
            
            const rightMaterial = new THREE.MeshBasicMaterial({
                map: rightTexture,
                side: THREE.FrontSide
            });
            
            // Vytvoření sfér
            leftSphere = new THREE.Mesh(geometry.clone(), leftMaterial);
            rightSphere = new THREE.Mesh(geometry.clone(), rightMaterial);
            
            // Otočení sfér tak, aby obrázek byl před námi
            leftSphere.rotation.y = Math.PI;
            rightSphere.rotation.y = Math.PI;
            
            // Nastavení vrstev pro stereo zobrazení
            leftSphere.layers.set(1);  // Levé oko
            rightSphere.layers.set(2); // Pravé oko
            
            scene.add(leftSphere);
            scene.add(rightSphere);
            
            updateStatus('Stereo obrázek načten - klikněte Enter VR');
        }

        function splitTexture(originalTexture, eye) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = originalTexture.image;
            
            // Rozměry pro každé oko (polovina šířky)
            const halfWidth = img.width / 2;
            const height = img.height;
            
            canvas.width = halfWidth;
            canvas.height = height;
            
            // Pozice pro výřez (left: 0-halfWidth, right: halfWidth-fullWidth)
            const sourceX = eye === 'left' ? 0 : halfWidth;
            
            // Vykreslení poloviny obrázku
            ctx.drawImage(img, sourceX, 0, halfWidth, height, 0, 0, halfWidth, height);
            
            // Vytvoření textury z canvas
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.ClampToEdgeWrapping;
            texture.wrapT = THREE.ClampToEdgeWrapping;
            texture.minFilter = THREE.LinearFilter;
            texture.generateMipmaps = false;
            
            return texture;
        }

        function setupControls() {
            let isPointerDown = false;
            let pointerX = 0, pointerY = 0;
            let rotationX = 0, rotationY = 0;
            
            const canvas = renderer.domElement;
            
            // Mouse události
            canvas.addEventListener('mousedown', (e) => {
                isPointerDown = true;
                pointerX = e.clientX;
                pointerY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isPointerDown) return;
                
                const deltaX = e.clientX - pointerX;
                const deltaY = e.clientY - pointerY;
                
                rotationY += deltaX * 0.005;
                rotationX += deltaY * 0.005;
                
                // Omezení vertikální rotace
                rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotationX));
                
                camera.rotation.x = rotationX;
                camera.rotation.y = rotationY;
                
                pointerX = e.clientX;
                pointerY = e.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                isPointerDown = false;
            });
            
            // Touch události
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isPointerDown = true;
                    pointerX = e.touches[0].clientX;
                    pointerY = e.touches[0].clientY;
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isPointerDown) {
                    const deltaX = e.touches[0].clientX - pointerX;
                    const deltaY = e.touches[0].clientY - pointerY;
                    
                    rotationY += deltaX * 0.005;
                    rotationX += deltaY * 0.005;
                    
                    rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, rotationX));
                    
                    camera.rotation.x = rotationX;
                    camera.rotation.y = rotationY;
                    
                    pointerX = e.touches[0].clientX;
                    pointerY = e.touches[0].clientY;
                }
                e.preventDefault();
            });
            
            canvas.addEventListener('touchend', () => {
                isPointerDown = false;
            });
        }

        function render() {
            renderer.render(scene, camera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Escape key listener
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') exitVR();
        });

        // Make functions global for onclick
        window.exitVR = exitVR;
        window.openVRView = openVRView;
        window.closeDetailsPopup = closeDetailsPopup;
    </script>
</body>
</html>
