<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Satelitn√≠ Mapa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Import stereo-img knihovny -->
    <script type="module" src="https://stereo-img.steren.fr/stereo-img.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .control-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .control-group select {
            width: 100%;
            padding: 8px 12px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 6px;


            font-size: 14px;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #007cba;
            box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin: 8px 0;
        }
        
        .control-group input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .markers-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .marker-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: background 0.3s ease;
        }
        
        .marker-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .marker-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            border-radius: 50%;
        }
        
        .castle-marker { background-color: #8B4513; }
        .historical-marker { background-color: #DAA520; }
        .park-marker { background-color: #228B22; }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #67e8f9;


        }
        
        .stat-label {
            color: #a0a0a0;
            font-size: 12px;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .back-button:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* VR Modal */
        .vr-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
        }
        
        .vr-modal-content {
            position: relative;
            margin: 2% auto;
            width: 90%;
            height: 90%;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .vr-close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: #fff;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .vr-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        /* Stereo img styling */
        stereo-img {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 15px;
        }
        
        .vr-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 30px;
            color: white;
            z-index: 2001;
        }
        
        .vr-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .vr-description {
            font-size: 16px;
            line-height: 1.5;
            opacity: 0.9;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .controls, .markers-panel {
                position: fixed;
                width: 90%;
                max-width: none;
                left: 5%;
                right: 5%;
                max-height: 50vh;
            }
            
            .controls {
                top: auto;
                bottom: 80px;
                right: 5%;
            }
            
            .markers-panel {
                top: 70px;

            }
            
            .info-panel {
                bottom: 10px;
                left: 5%;
                right: 5%;
                transform: none;
                width: 90%;
            }
            
            .stats {
                gap: 10px;
                font-size: 12px;
            }
            
            .back-button {
                top: 10px;
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .vr-modal-content {
                margin: 5% auto;
                width: 95%;
                height: 85%;
            }
            
            .vr-close {
                right: 10px;
                top: 10px;
                width: 40px;
                height: 40px;
                font-size: 25px;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <button class="back-button" onclick="goBack()">‚Üê Zpƒõt</button>
    
    <div class="controls">
        <h3 style="margin-bottom: 15px; color: #67e8f9;">Ovl√°d√°n√≠ mapy</h3>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="showSatellite" checked> Satelitn√≠ zobrazen√≠
            </label>
        </div>
        
        <div class="control-group">
            <label for="mapStyle">Styl mapy:</label>
            <select id="mapStyle">
                <option value="satellite">Satelitn√≠</option>
                <option value="streets">Ulice</option>
                <option value="hybrid">Hybridn√≠</option>
                <option value="terrain">Ter√©n</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="opacity">Pr≈Øhlednost vrstvy:</label>
            <input type="range" id="opacity" min="0" max="1" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label for="markerColor">Barva marker≈Ø:</label>
            <input type="color" id="markerColor" value="#ff6b6b">
        </div>
        
        <button class="btn" onclick="resetView()">Resetovat pohled</button>
        <button class="btn" onclick="toggleFullscreen()">Cel√° obrazovka</button>
        <button class="btn" onclick="exportMap()">Exportovat mapu</button>
    </div>
    
    <div class="markers-panel">
        <h3 style="margin-bottom: 15px; color: #67e8f9;">Znaƒçky na mapƒõ</h3>
        
        <div class="control-group">
            <button class="btn" onclick="addMarker()">+ P≈ôidat znaƒçku</button>
        </div>
        
        <div class="marker-item">
            <div class="marker-icon castle-marker"></div>
            <div>
                <div style="font-weight: bold;">Pra≈æsk√Ω hrad</div>
                <div style="font-size: 12px; color: #a0a0a0;">Historick√Ω hrad</div>
            </div>
        </div>
        
        <div class="marker-item">


            <div class="marker-icon historical-marker"></div>
            <div>
                <div style="font-weight: bold;">Karl≈Øv most</div>
                <div style="font-size: 12px; color: #a0a0a0;">Historick√° pam√°tka</div>
            </div>
        </div>
        
        <div class="marker-item">
            <div class="marker-icon park-marker"></div>
            <div>
                <div style="font-weight: bold;">Pet≈ô√≠n</div>
                <div style="font-size: 12px; color: #a0a0a0;">Park</div>
            </div>
        </div>
        
        <div class="marker-item">
            <div class="marker-icon castle-marker"></div>
            <div>
                <div style="font-weight: bold;">Karl≈°tejn</div>
                <div style="font-size: 12px; color: #a0a0a0;">Gotick√Ω hrad</div>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">12</div>
                <div class="stat-label">Znaƒçek</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">5</div>
                <div class="stat-label">Hrad≈Ø</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">3</div>
                <div class="stat-label">Park≈Ø</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">4</div>
                <div class="stat-label">Pam√°tek</div>
            </div>
        </div>
    </div>
    
    <!-- VR Modal -->
    <div id="vrModal" class="vr-modal">
        <div class="vr-modal-content">
            <span class="vr-close">&times;</span>
            <!-- Stereo obr√°zek komponenta -->
            <stereo-img src="./Castles/generated/Le_Castillet_generated.jpg"></stereo-img>
            <div class="vr-overlay">
                <div class="vr-title">Le Castillet</div>
                <div class="vr-description">
                    Historick√° pevnost v Perpignanu, Francie. Tato gotick√° br√°na z 14. stolet√≠ 
                    slou≈æila jako vstupn√≠ bod do mƒõsta a pozdƒõji jako vƒõzen√≠. Dnes je domovem 
                    Casa Pairal, muzea katal√°nsk√© kultury.
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Inicializace mapy
        let map = L.map('map').setView([50.0755, 14.4378], 10);
        
        // P≈ôid√°n√≠ satelitn√≠ vrstvy
        let satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);
        
        // P≈ôid√°n√≠ uliƒçn√≠ch map
        let streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });
        


        // Ovl√°d√°n√≠ vrstev
        let baseMaps = {
            "Satelitn√≠": satelliteLayer,
            "Ulice": streetLayer
        };
        
        // P≈ôid√°n√≠ kontroly vrstev
        L.control.layers(baseMaps).addTo(map);
        
        // P≈ôid√°n√≠ marker≈Ø
        let markers = [];
        
        // Pra≈æsk√Ω hrad
        let praguecastle = L.marker([50.0909, 14.4014]).addTo(map);
        praguecastle.bindPopup('<b>Pra≈æsk√Ω hrad</b><br>Historick√© s√≠dlo ƒçesk√Ωch kr√°l≈Ø<br><button onclick="openVR()">Zobrazit VR</button>');
        markers.push(praguecastle);
        
        // Karl≈Øv most
        let charlesbridge = L.marker([50.0865, 14.4114]).addTo(map);
        charlesbridge.bindPopup('<b>Karl≈Øv most</b><br>Historick√Ω most p≈ôes Vltavu<br><button onclick="openVR()">Zobrazit VR</button>');
        markers.push(charlesbridge);
        
        // Pet≈ô√≠n
        let petrin = L.marker([50.0836, 14.3949]).addTo(map);
        petrin.bindPopup('<b>Pet≈ô√≠n</b><br>Park s rozhlednou<br><button onclick="openVR()">Zobrazit VR</button>');
        markers.push(petrin);
        
        // Karl≈°tejn
        let karlstejn = L.marker([49.9395, 14.1880]).addTo(map);
        karlstejn.bindPopup('<b>Karl≈°tejn</b><br>Gotick√Ω hrad<br><button onclick="openVR()">Zobrazit VR</button>');
        markers.push(karlstejn);
        
        // Funkce pro ovl√°d√°n√≠
        function goBack() {
            alert('N√°vrat na p≈ôedchoz√≠ str√°nku');
            // window.history.back();
        }
        
        function resetView() {
            map.setView([50.0755, 14.4378], 10);
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function exportMap() {
            alert('Export mapy - funkce bude implementov√°na');
        }
        
        function addMarker() {
            let lat = prompt('Zadejte zemƒõpisnou ≈°√≠≈ôku:');
            let lng = prompt('Zadejte zemƒõpisnou d√©lku:');
            let name = prompt('Zadejte n√°zev znaƒçky:');
            
            if (lat && lng && name) {
                let newMarker = L.marker([parseFloat(lat), parseFloat(lng)]).addTo(map);
                newMarker.bindPopup(`<b>${name}</b><br>U≈æivatelsk√° znaƒçka<br><button onclick="openVR()">Zobrazit VR</button>`);
                markers.push(newMarker);
            }
        }
        
        // VR Modal funkce
        function openVR() {
            document.getElementById('vrModal').style.display = 'block';
        }
        
        // Zav≈ôen√≠ VR modalu
        document.querySelector('.vr-close').onclick = function() {
            document.getElementById('vrModal').style.display = 'none';
        }
        
        // Zav≈ôen√≠ p≈ôi kliknut√≠ mimo modal
        window.onclick = function(event) {
            let modal = document.getElementById('vrModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ovl√°d√°n√≠ styl≈Ø mapy
        document.getElementById('mapStyle').addEventListener('change', function() {
            let style = this.value;
            map.eachLayer(function(layer) {
 

                if (layer._url) {
                    map.removeLayer(layer);
                }
            });
            
            switch(style) {
                case 'satellite':
                    satelliteLayer.addTo(map);
                    break;
                case 'streets':
                    streetLayer.addTo(map);
                    break;
                case 'hybrid':
                    satelliteLayer.addTo(map);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors',
                        opacity: 0.5
                    }).addTo(map);
                    break;
                case 'terrain':
                    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenTopoMap contributors'
                    }).addTo(map);
                    break;
            }
        });
        
        // Ovl√°d√°n√≠ pr≈Øhlednosti
        document.getElementById('opacity').addEventListener('input', function() {
            let opacity = this.value;
            map.eachLayer(function(layer) {
                if (layer._url) {
                    layer.setOpacity(opacity);
                }
            });
        });
        
        // Ovl√°d√°n√≠ barvy marker≈Ø
        document.getElementById('markerColor').addEventListener('change', function() {
            let color = this.value;
            // Zde by byla implementace zmƒõny barvy marker≈Ø
            console.log('Zmƒõna barvy marker≈Ø na: ' + color);
        });
        
        // Ovl√°d√°n√≠ satelitn√≠ho zobrazen√≠
        document.getElementById('showSatellite').addEventListener('change', function() {
            if (this.checked) {
                if (!map.hasLayer(satelliteLayer)) {
                    satelliteLayer.addTo(map);
                }
            } else {
                if (map.hasLayer(satelliteLayer)) {
                    map.removeLayer(satelliteLayer);
                }
                if (!map.hasLayer(streetLayer)) {
                    streetLayer.addTo(map);
                }
            }
        });
        
        // Kl√°vesov√© zkratky
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'Escape':
                    document.getElementById('vrModal').style.display = 'none';
                    break;
                case 'f':
                case 'F':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleFullscreen();
                    }
                    break;
                case 'r':
                case 'R':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        resetView();
                    }
                    break;
            }
        });
        
        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Mapa inicializov√°na');
            
            // P≈ôid√°n√≠ click event pro otev≈ôen√≠ VR
            map.on('click', function(e) {
                console.log('Kliknuto na sou≈ôadnice: ' + e.latlng);
            });
            
            // Aktualizace statistik
            updateStats();
        });
        
        // Funkce pro aktulizaci statistik
        function updateStats() {
            let castleCount = 0;
            let parkCount = 0;
            let historicalCount = 0;
            let totalMarkers = markers.length;
            
            // Zde by byla logika pro poƒç√≠t√°n√≠ r≈Øzn√Ωch typ≈Ø marker≈Ø
            // Pro demo pou≈æ√≠v√°me statick√© hodnoty
            
            document.querySelector('.stat-item:nth-child(1) .stat-number').textContent = totalMarkers;
            document.querySelector('.stat-item:nth-child(2) .stat-number').textContent = '2';
            document.querySelector('.stat-item:nth-child(3) .stat-number').textContent = '1';

            document.querySelector('.stat-item:nth-child(4) .stat-number').textContent = '1';
        }
        
        // Geolokace u≈æivatele
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let userLat = position.coords.latitude;
                    let userLng = position.coords.longitude;
                    
                    let userMarker = L.marker([userLat, userLng]).addTo(map);
                    userMarker.bindPopup('<b>Va≈°e poloha</b><br>Aktu√°ln√≠ pozice');
                    
                    map.setView([userLat, userLng], 15);
                }, function(error) {
                    console.log('Chyba p≈ôi z√≠sk√°v√°n√≠ polohy: ' + error.message);
                    alert('Nepoda≈ôilo se z√≠skat va≈°i polohu');
                });
            } else {
                alert('Geolokace nen√≠ podporov√°na t√≠mto prohl√≠≈æeƒçem');
            }
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro geolokaci
        L.Control.Locate = L.Control.extend({
            onAdd: function(map) {
                let btn = L.DomUtil.create('button', 'locate-btn');
                btn.innerHTML = 'üìç';
                btn.style.cssText = 'background: #fff; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 30px; height: 30px; cursor: pointer; font-size: 16px;';
                btn.title = 'Naj√≠t moji polohu';
                
                btn.onclick = function(e) {
                    L.DomEvent.stopPropagation(e);
                    getUserLocation();
                };
                
                return btn;
            },
            
            onRemove: function(map) {
                // Nic nedƒõlat
            }
        });
        
        L.control.locate = function(opts) {
            return new L.Control.Locate(opts);
        }
        
        // P≈ôid√°n√≠ ovl√°dac√≠ho prvku pro geolokaci
        L.control.locate({ position: 'bottomright' }).addTo(map);
        
        // Mƒõ≈ôen√≠ vzd√°lenosti
        let measureMode = false;
        let measureMarkers = [];
        let measureLine = null;
        
        function toggleMeasure() {
            measureMode = !measureMode;
            if (measureMode) {
                map.getContainer().style.cursor = 'crosshair';
                alert('Kliknƒõte na dva body pro zmƒõ≈ôen√≠ vzd√°lenosti');
            } else {
                map.getContainer().style.cursor = '';
                clearMeasure();
            }
        }
        
        function clearMeasure() {
            measureMarkers.forEach(marker => map.removeLayer(marker));
            if (measureLine) map.removeLayer(measureLine);
            measureMarkers = [];
            measureLine = null;
        }
        
        // Event listener pro mƒõ≈ôen√≠
        map.on('click', function(e) {
            if (measureMode && measureMarkers.length < 2) {
                let marker = L.marker(e.latlng).addTo(map);
                measureMarkers.push(marker);
                
                if (measureMarkers.length === 2) {
                    let latlngs = measureMarkers.map(marker => marker.getLatLng());
                    measureLine = L.polyline(latlngs, {color: 'red', weight: 3}).addTo(map);
                    
                    let distance = measureMarkers[0].getLatLng().distanceTo(measureMarkers[1].getLatLng());
                    let distanceKm = (distance / 1000).toFixed(2);
                    
                    alert(`Vzd√°lenost: ${distanceKm} km`);
                    measureMode = false;
                    map.getContainer().style.cursor = '';
                }

            }
        });
        
        // Export do r≈Øzn√Ωch form√°t≈Ø
        function exportToGeoJSON() {
            let geojson = {
                "type": "FeatureCollection",
                "features": []
            };
            
            markers.forEach(function(marker) {
                let feature = {
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [marker.getLatLng().lng, marker.getLatLng().lat]
                    },
                    "properties": {
                        "name": "Marker",
                        "description": "Exported marker"
                    }
                };
                geojson.features.push(feature);
            });
            
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson, null, 2));
            let downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "mapa-markery.geojson");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // P≈ôid√°n√≠ dal≈°√≠ch ovl√°dac√≠ch tlaƒç√≠tek
        function createCustomControls() {
            // Tlaƒç√≠tko pro mƒõ≈ôen√≠
            L.Control.Measure = L.Control.extend({
                onAdd: function(map) {
                    let btn = L.DomUtil.create('button', 'measure-btn');
                    btn.innerHTML = 'üìè';
                    btn.style.cssText = 'background: #fff; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 30px; height: 30px; cursor: pointer; font-size: 16px; margin-bottom: 5px;';
                    btn.title = 'Mƒõ≈ôit vzd√°lenost';
                    
                    btn.onclick = function(e) {
                        L.DomEvent.stopPropagation(e);
                        toggleMeasure();
                    };
                    
                    return btn;
                },
                onRemove: function(map) {}
            });
            
            // Tlaƒç√≠tko pro export
            L.Control.Export = L.Control.extend({
                onAdd: function(map) {
                    let btn = L.DomUtil.create('button', 'export-btn');
                    btn.innerHTML = 'üíæ';
                    btn.style.cssText = 'background: #fff; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 30px; height: 30px; cursor: pointer; font-size: 16px;';
                    btn.title = 'Export do GeoJSON';
                    
                    btn.onclick = function(e) {
                        L.DomEvent.stopPropagation(e);
                        exportToGeoJSON();
                    };
                    
                    return btn;
                },
                onRemove: function(map) {}
            });
            
            // P≈ôid√°n√≠ ovl√°dac√≠ch prvk≈Ø
            new L.Control.Measure({ position: 'bottomright' }).addTo(map);
            new L.Control.Export({ position: 'bottomright' }).addTo(map);
        }
        
        // Inicializace vlastn√≠ch ovl√°dac√≠ch prvk≈Ø
        createCustomControls();
        
        // Funkce pro naƒç√≠t√°n√≠ dat z extern√≠ch zdroj≈Ø
        async function loadExternalData() {
            try {
                // P≈ô√≠klad naƒç√≠t√°n√≠ GeoJSON dat
                let response = await fetch('data/markers.geojson');
                if (response.ok) {
                    let geojsonData = await response.json();
                    L.geoJSON(geojsonData, {
                        onEachFeature: function (feature, layer) {
                            if (feature.properties && feature.properties.name) {

                                layer.bindPopup(`
                                    <b>${feature.properties.name}</b><br>
                                    ${feature.properties.description || '≈Ω√°dn√Ω popis'}<br>
                                    <button onclick="openVR()">Zobrazit VR</button>
                                `);
                            }
                        }
                    }).addTo(map);
                }
            } catch (error) {
                console.log('Nepoda≈ôilo se naƒç√≠st extern√≠ data:', error);
            }
        }
        
        // Naƒçten√≠ extern√≠ch dat p≈ôi inicializaci
        loadExternalData();
        
        // Funkce pro search/vyhled√°v√°n√≠
        function searchLocation() {
            let query = prompt('Zadejte n√°zev m√≠sta k vyhled√°n√≠:');
            if (query) {
                // Pou≈æit√≠ Nominatim API pro geocoding
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            let lat = parseFloat(data[0].lat);
                            let lon = parseFloat(data[0].lon);
                            let name = data[0].display_name;
                            
                            map.setView([lat, lon], 15);
                            
                            let searchMarker = L.marker([lat, lon]).addTo(map);
                            searchMarker.bindPopup(`<b>Vyhledan√© m√≠sto</b><br>${name}<br><button onclick="openVR()">Zobrazit VR</button>`);
                            
                            // P≈ôid√°n√≠ do pole marker≈Ø
                            markers.push(searchMarker);
                            updateStats();
                        } else {
                            alert('M√≠sto nebylo nalezeno');
                        }
                    })
                    .catch(error => {
                        console.error('Chyba p≈ôi vyhled√°v√°n√≠:', error);
                        alert('Chyba p≈ôi vyhled√°v√°n√≠ m√≠sta');
                    });
            }
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro vyhled√°v√°n√≠ do controls
        let searchButton = document.createElement('button');
        searchButton.className = 'btn';
        searchButton.textContent = 'üîç Vyhledat m√≠sto';
        searchButton.onclick = searchLocation;
        document.querySelector('.controls').appendChild(searchButton);
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro mƒõ≈ôen√≠ do controls
        let measureButton = document.createElement('button');
        measureButton.className = 'btn';
        measureButton.textContent = 'üìè Mƒõ≈ôit vzd√°lenost';
        measureButton.onclick = toggleMeasure;
        document.querySelector('.controls').appendChild(measureButton);
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro vyƒçi≈°tƒõn√≠ mƒõ≈ôen√≠
        let clearMeasureButton = document.createElement('button');
        clearMeasureButton.className = 'btn';
        clearMeasureButton.textContent = 'üóëÔ∏è Vyƒçistit mƒõ≈ôen√≠';
        clearMeasureButton.onclick = clearMeasure;
        document.querySelector('.controls').appendChild(clearMeasureButton);
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro geolokaci do controls
        let locationButton = document.createElement('button');
        locationButton.className = 'btn';
        locationButton.textContent = 'üìç M√° poloha';
        locationButton.onclick = getUserLocation;
        document.querySelector('.controls').appendChild(locationButton);
        
        // Drag & Drop funkce pro import soubor≈Ø
        function setupDragDrop() {
            let mapContainer = document.getElementById('map');
            
            mapContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                mapContainer.style.opacity = '0.8';
            });
            
            mapContainer.addEventListener('dragleave', function(e) {

                e.preventDefault();
                e.stopPropagation();
                mapContainer.style.opacity = '1';
            });
            
            mapContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                mapContainer.style.opacity = '1';
                
                let files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileImport(files[0]);
                }
            });
        }
        
        // Funkce pro import soubor≈Ø
        function handleFileImport(file) {
            let reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.geojson') || file.name.endsWith('.json')) {
                        let geojsonData = JSON.parse(e.target.result);
                        L.geoJSON(geojsonData, {
                            onEachFeature: function (feature, layer) {
                                if (feature.properties && feature.properties.name) {
                                    layer.bindPopup(`
                                        <b>${feature.properties.name}</b><br>
                                        ${feature.properties.description || 'Importovan√Ω marker'}<br>
                                        <button onclick="openVR()">Zobrazit VR</button>
                                    `);
                                    markers.push(layer);
                                }
                            }
                        }).addTo(map);
                        
                        updateStats();
                        alert('Soubor byl √∫spƒõ≈°nƒõ importov√°n!');
                    } else {
                        alert('Nepodporovan√Ω form√°t souboru. Podporov√°ny jsou pouze .geojson a .json soubory.');
                    }
                } catch (error) {
                    console.error('Chyba p≈ôi importu souboru:', error);
                    alert('Chyba p≈ôi ƒçten√≠ souboru. Zkontrolujte form√°t.');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Inicializace drag & drop
        setupDragDrop();
        
        // P≈ôid√°n√≠ pokroƒçil√Ωch VR funkc√≠
        function switchVRImage(imagePath) {
            let stereoImg = document.querySelector('stereo-img');
            if (stereoImg) {
                stereoImg.setAttribute('src', imagePath);
            }
        }
        
        // Roz≈°√≠≈ôen√≠ VR modalu o v√≠ce obr√°zk≈Ø
        let vrImages = [
            './Castles/generated/Le_Castillet_generated.jpg',
            './Castles/generated/Prague_Castle_generated.jpg',
            './Castles/generated/Karlstejn_generated.jpg'
        ];
        
        let currentVRIndex = 0;
        
        function nextVRImage() {
            currentVRIndex = (currentVRIndex + 1) % vrImages.length;
            switchVRImage(vrImages[currentVRIndex]);
        }
        
        function prevVRImage() {
            currentVRIndex = (currentVRIndex - 1 + vrImages.length) % vrImages.length;
            switchVRImage(vrImages[currentVRIndex]);
        }
        
        // P≈ôid√°n√≠ navigaƒçn√≠ch tlaƒç√≠tek do VR modalu
        let vrModalContent = document.querySelector('.vr-modal-content');
        
        let prevBtn = document.createElement('button');
        prevBtn.innerHTML = '‚Äπ';
        prevBtn.style.cssText = `
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            transition: all 0.3s ease;
        `;

        prevBtn.onmouseover = function() { this.style.background = 'rgba(255, 255, 255, 0.2)'; };
        prevBtn.onmouseout = function() { this.style.background = 'rgba(0, 0, 0, 0.7)'; };
        prevBtn.onclick = prevVRImage;
        
        let nextBtn = document.createElement('button');
        nextBtn.innerHTML = '‚Ä∫';
        nextBtn.style.cssText = `
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            transition: all 0.3s ease;
        `;
        nextBtn.onmouseover = function() { this.style.background = 'rgba(255, 255, 255, 0.2)'; };
        nextBtn.onmouseout = function() { this.style.background = 'rgba(0, 0, 0, 0.7)'; };
        nextBtn.onclick = nextVRImage;
        
        vrModalContent.appendChild(prevBtn);
        vrModalContent.appendChild(nextBtn);
        
        // P≈ôid√°n√≠ indik√°toru aktu√°ln√≠ho obr√°zku
        let vrIndicator = document.createElement('div');
        vrIndicator.style.cssText = `
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 2002;
            font-size: 14px;
        `;
        vrIndicator.textContent = `1 / ${vrImages.length}`;
        vrModalContent.appendChild(vrIndicator);
        
        // Aktualizace indik√°toru p≈ôi zmƒõnƒõ obr√°zku
        function updateVRIndicator() {
            vrIndicator.textContent = `${currentVRIndex + 1} / ${vrImages.length}`;
        }
        
        // P≈ôepis funkc√≠ pro aktualizaci indik√°toru
        let originalNext = nextVRImage;
        let originalPrev = prevVRImage;
        
        nextVRImage = function() {
            originalNext();
            updateVRIndicator();
        };
        
        prevVRImage = function() {
            originalPrev();
            updateVRIndicator();
        };
        
        // Kl√°vesov√© ovl√°d√°n√≠ VR modalu
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('vrModal').style.display === 'block') {
                switch(event.key) {
                    case 'ArrowLeft':
                        prevVRImage();
                        break;
                    case 'ArrowRight':
                        nextVRImage();
                        break;
                }
            }
        });
        
        // Automatick√© p≈ôep√≠n√°n√≠ VR obr√°zk≈Ø
        let vrAutoplay = false;
        let vrAutoplayInterval;
        
        function toggleVRAutoplay() {
            vrAutoplay = !vrAutoplay;
            if (vrAutoplay) {
                vrAutoplayInterval = setInterval(nextVRImage, 5000);
            } else {
                clearInterval(vrAutoplayInterval);
            }
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro autoplay
        let autoplayBtn = document.createElement('button');
        autoplayBtn.innerHTML = '‚ñ∂';
        autoplayBtn.style.cssText = `
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            font-size: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            transition: all 0.3s ease;
        `;
        autoplayBtn.title = 'Zapnout/vypnout automatick√© p≈ôehr√°v√°n√≠';
        autoplayBtn.onclick = function() {
            toggleVRAutoplay();
            this.innerHTML = vrAutoplay ? '‚è∏' : '‚ñ∂';
            this.style.background = vrAutoplay ? 'rgba(0, 255, 0, 0.7)' : 'rgba(0, 0, 0, 0.7)';
        };
        vrModalContent.appendChild(autoplayBtn);
        
        // Zastaven√≠ autoplay p≈ôi zav≈ôen√≠ modalu
        let originalCloseModal = document.querySelector('.vr-close').onclick;
        document.querySelector('.vr-close').onclick = function() {
            if (vrAutoplay) {
                toggleVRAutoplay();
                autoplayBtn.innerHTML = '‚ñ∂';
                autoplayBtn.style.background = 'rgba(0, 0, 0, 0.7)';
            }
            originalCloseModal();
        };
        
        // Pokroƒçil√© filtry marker≈Ø
        function filterMarkers(type) {
            markers.forEach(marker => {
                let popup = marker.getPopup();
                if (popup) {
                    let content = popup.getContent().toString().toLowerCase();
                    switch(type) {
                        case 'all':
                            marker.addTo(map);
                            break;
                        case 'castles':
                            if (content.includes('hrad') || content.includes('castle')) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                            break;
                        case 'parks':
                            if (content.includes('park')) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                            break;
                        case 'historical':
                            if (content.includes('historick') || content.includes('most') || content.includes('pam√°tka')) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                            break;
                    }
                }
            });
            updateStats();
        }
        
        // P≈ôid√°n√≠ filtr≈Ø do markers panel
        let filtersDiv = document.createElement('div');
        filtersDiv.innerHTML = `
            <div class="control-group">
                <label>Filtry marker≈Ø:</label>
                <select id="markerFilter" onchange="filterMarkers(this.value)">
                    <option value="all">V≈°echny</option>
                    <option value="castles">Hrady</option>
                    <option value="parks">Parky</option>
                    <option value="historical">Historick√©</option>
                </select>
            </div>
        `;
        document.querySelector('.markers-panel').insertBefore(filtersDiv, document.querySelector('.markers-panel').children[2]);
        
        // Pokroƒçil√© nastaven√≠ mapy
        function toggleNightMode() {
            let body = document.body;
            if (body.style.filter === 'invert(1) hue-rotate(180deg)') {
                body.style.filter = '';
                localStorage.setItem('nightMode', 'false');
            } else {
                body.style.filter = 'invert(1) hue-rotate(180deg)';
                localStorage.setItem('nightMode', 'true');
            }
        }
        
        // Naƒçten√≠ ulo≈æen√©ho re≈æimu
        if (localStorage.getItem('nightMode') === 'true') {

            document.body.style.filter = 'invert(1) hue-rotate(180deg)';
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro noƒçn√≠ re≈æim
        let nightModeButton = document.createElement('button');
        nightModeButton.className = 'btn';
        nightModeButton.textContent = 'üåô Noƒçn√≠ re≈æim';
        nightModeButton.onclick = toggleNightMode;
        document.querySelector('.controls').appendChild(nightModeButton);
        
        // Ulo≈æen√≠/naƒçten√≠ pozice mapy
        function saveMapView() {
            let center = map.getCenter();
            let zoom = map.getZoom();
            localStorage.setItem('mapView', JSON.stringify({
                lat: center.lat,
                lng: center.lng,
                zoom: zoom
            }));
            alert('Pohled mapy byl ulo≈æen');
        }
        
        function loadMapView() {
            let savedView = localStorage.getItem('mapView');
            if (savedView) {
                let view = JSON.parse(savedView);
                map.setView([view.lat, view.lng], view.zoom);
            }
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tek pro ukl√°d√°n√≠/naƒç√≠t√°n√≠ pohledu
        let saveViewButton = document.createElement('button');
        saveViewButton.className = 'btn';
        saveViewButton.textContent = 'üíæ Ulo≈æit pohled';
        saveViewButton.onclick = saveMapView;
        document.querySelector('.controls').appendChild(saveViewButton);
        
        let loadViewButton = document.createElement('button');
        loadViewButton.className = 'btn';
        loadViewButton.textContent = 'üìÇ Naƒç√≠st pohled';
        loadViewButton.onclick = loadMapView;
        document.querySelector('.controls').appendChild(loadViewButton);
        
        // Pokroƒçil√© statistiky
        function generateReport() {
            let report = {
                totalMarkers: markers.length,
                mapCenter: map.getCenter(),
                mapZoom: map.getZoom(),
                currentLayer: 'Satelitn√≠',
                timestamp: new Date().toISOString(),
                markerTypes: {
                    castles: 0,
                    parks: 0,
                    historical: 0,
                    other: 0
                }
            };
            
            // Anal√Ωza marker≈Ø
            markers.forEach(marker => {
                let popup = marker.getPopup();
                if (popup) {
                    let content = popup.getContent().toString().toLowerCase();
                    if (content.includes('hrad') || content.includes('castle')) {
                        report.markerTypes.castles++;
                    } else if (content.includes('park')) {
                        report.markerTypes.parks++;
                    } else if (content.includes('historick') || content.includes('most') || content.includes('pam√°tka')) {
                        report.markerTypes.historical++;
                    } else {
                        report.markerTypes.other++;
                    }
                }
            });
            
            // Export reportu
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
            let downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "mapa-report.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // P≈ôid√°n√≠ tlaƒç√≠tka pro generov√°n√≠ reportu
        let reportButton = document.createElement('button');
        reportButton.className = 'btn';
        reportButton.textContent = 'üìä Generovat report';
        reportButton.onclick = generateReport;
        document.querySelector('.controls').appendChild(reportButton);
        
        // Konec skriptu - inicializace dokonƒçena
        console.log('V≈°echny funkce mapy byly inicializov√°ny');


        // Naƒçten√≠ ulo≈æen√©ho pohledu p≈ôi startu
        loadMapView();
        
    </script>
</body>
</html>

        
            
            
        
                
                                    
            
                                   
                    
            
                
                
            
        
