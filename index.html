<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Stereo Test - Insta 360 EVO - Meta Quest 3</title>
    
    <!-- A-Frame - z√°kladn√≠ verze bez extern√≠ch knihoven -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            z-index: 1000;
            font-size: 14px;
        }
        
        .controls {
            margin-top: 10px;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .debug {
            background: rgba(40, 40, 40, 0.9);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        
        /* Zv√Ωraznit VR tlaƒç√≠tko */
        .a-enter-vr {
            background: #28a745 !important;
            border: 3px solid #fff !important;
            font-size: 16px !important;
            padding: 15px !important;
        }
    </style>
</head>
<body>
    <div class="ui-overlay" id="uiOverlay">
        <h3>ü•Ω VR Stereo Test - Insta 360 EVO - Z√°kladn√≠ A-Frame</h3>
        <div class="info">
            <strong>Jednoduch√Ω p≈ô√≠stup:</strong><br>
            Dva canvas elementy pro lev√© a prav√© oko, bez extern√≠ch knihoven
        </div>
        
        <div class="controls">
            <button class="button" onclick="loadVRScene()">üì∑ Naƒç√≠st VR sc√©nu</button>
            <button class="button" onclick="toggleUI()">üëÅÔ∏è Skr√Ωt/Zobrazit UI</button>
            <button class="button" onclick="forceVR()">üöÄ Vynucen√Ω VR vstup</button>
        </div>
        
        <div id="debugOutput" class="debug"></div>
    </div>

    <!-- A-Frame VR sc√©na - z√°kladn√≠ p≈ô√≠stup -->
    <a-scene 
        id="vrScene" 
        embedded 
        style="height: 100vh; width: 100%;"
        vr-mode-ui="enabled: true">
        
        <!-- Assets -->
        <a-assets>
            <img id="stereoImage" src="./Castles/generated/Le_Castillet_generated.jpg">
            <canvas id="leftCanvas" width="512" height="512"></canvas>
            <canvas id="rightCanvas" width="512" height="512"></canvas>
        </a-assets>
        
        <!-- Kamera -->
        <a-camera 
            position="0 1.6 0" 
            look-controls="enabled: true">
        </a-camera>
        
        <!-- Left eye - sphere POUZE s levou polovinou obr√°zku -->
        <a-sphere 
            id="leftEye"
            src="#leftCanvas"
            radius="10"
            phi-start="270" 
            phi-length="180"
            theta-start="30"
            theta-length="120"
            rotation="0 0 0"
            material="side: back">
        </a-sphere>
        
        <!-- Right eye - sphere POUZE s pravou polovinou obr√°zku -->
        <a-sphere 
            id="rightEye"
            src="#rightCanvas" 
            radius="10"
            phi-start="270"
            phi-length="180" 
            theta-start="30"
            theta-length="120"
            rotation="0 0 0"
            material="side: back">
        </a-sphere>
        
        <!-- Z√°kladn√≠ osvƒõtlen√≠ -->
        <a-light type="ambient" color="#ffffff"></a-light>
    </a-scene>

    <script>
        let sceneLoaded = false;
        let uiVisible = true;
        let stereoImage = null;
        
        // Debug funkce
        function debugLog(message, type = 'info') {
            const debugDiv = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            debugDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }
        
        function splitStereoImage() {
            debugLog('üîÑ Rozdƒõluju side-by-side stereo obr√°zek...', 'info');
            
            const img = document.querySelector('#stereoImage');
            const leftCanvas = document.querySelector('#leftCanvas');
            const rightCanvas = document.querySelector('#rightCanvas');
            
            if (!img.complete) {
                debugLog('‚ùå Obr√°zek je≈°tƒõ nen√≠ naƒçten', 'error');
                return false;
            }
            
            const fullWidth = img.naturalWidth;
            const fullHeight = img.naturalHeight;
            const halfWidth = fullWidth / 2; // Ka≈æd√° polovina pro jedno oko
            
            debugLog(`Celkov√© rozmƒõry: ${fullWidth}x${fullHeight}`, 'info');
            debugLog(`Lev√© oko: 0-${halfWidth}, Prav√© oko: ${halfWidth}-${fullWidth}`, 'info');
            
            // Nastavit velikost canvas pro ka≈æd√© oko
            leftCanvas.width = halfWidth;
            leftCanvas.height = fullHeight;
            rightCanvas.width = halfWidth;
            rightCanvas.height = fullHeight;
            
            const leftCtx = leftCanvas.getContext('2d');
            const rightCtx = rightCanvas.getContext('2d');
            
            try {
                // LEV√â OKO: Nakreslit LEVOU polovinu obr√°zku (x: 0 ‚Üí halfWidth)
                leftCtx.drawImage(
                    img,           // source image
                    0, 0,          // source x,y (lev√° polovina)
                    halfWidth, fullHeight,  // source width,height 
                    0, 0,          // dest x,y
                    halfWidth, fullHeight   // dest width,height
                );
                
                // PRAV√â OKO: Nakreslit PRAVOU polovinu obr√°zku (x: halfWidth ‚Üí fullWidth)
                rightCtx.drawImage(
                    img,           // source image  
                    halfWidth, 0,  // source x,y (prav√° polovina)
                    halfWidth, fullHeight,  // source width,height
                    0, 0,          // dest x,y
                    halfWidth, fullHeight   // dest width,height
                );
                
                debugLog('‚úÖ Stereo obr√°zek SPR√ÅVNƒö rozdƒõlen na L/R!', 'success');
                debugLog(`Ka≈æd√© oko: ${halfWidth}x${fullHeight}`, 'info');
                
                // Force update textur v A-Frame
                setTimeout(() => {
                    const leftSphere = document.querySelector('#leftEye');
                    const rightSphere = document.querySelector('#rightEye');
                    
                    // Vynutit reload textur
                    leftSphere.removeAttribute('src');
                    rightSphere.removeAttribute('src');
                    
                    setTimeout(() => {
                        leftSphere.setAttribute('src', '#leftCanvas');
                        rightSphere.setAttribute('src', '#rightCanvas');
                        debugLog('üéØ Textury aktualizov√°ny v A-Frame', 'success');
                    }, 100);
                }, 100);
                
                return true;
            } catch (error) {
                debugLog(`‚ùå Chyba p≈ôi rozdƒõlen√≠: ${error.message}`, 'error');
                return false;
            }
        }
        
        function loadVRScene() {
            debugLog('Naƒç√≠t√°m VR sc√©nu...', 'info');
            
            const scene = document.querySelector('#vrScene');
            const img = document.querySelector('#stereoImage');
            
            debugLog(`Cesta k obr√°zku: ${img.src}`, 'info');
            
            // P≈ôidat posluchaƒçe ud√°lost√≠
            img.addEventListener('load', function() {
                debugLog('‚úÖ Stereo obr√°zek naƒçten √∫spƒõ≈°nƒõ!', 'success');
                debugLog(`Rozmƒõry obr√°zku: ${img.naturalWidth}x${img.naturalHeight}`, 'info');
                
                // Rozdƒõlit na L/R
                if (splitStereoImage()) {
                    sceneLoaded = true;
                    debugLog('üéØ Insta 360 EVO side-by-side zpracov√°no', 'success');
                    
                    // Zd≈Øraznit VR tlaƒç√≠tko
                    setTimeout(() => {
                        const vrButton = document.querySelector('.a-enter-vr');
                        if (vrButton) {
                            vrButton.style.background = '#28a745';
                            vrButton.style.border = '3px solid #fff';
                            vrButton.innerHTML = 'ü•Ω VSTUP DO VR';
                            debugLog('‚úÖ VR tlaƒç√≠tko je p≈ôipraven√©!', 'success');
                        }
                    }, 1000);
                }
            });
            
            img.addEventListener('error', function(e) {
                debugLog('‚ùå CHYBA p≈ôi naƒç√≠t√°n√≠ obr√°zku!', 'error');
                debugLog(`Chyba: ${e.type}`, 'error');
                debugLog('Zkontrolujte cestu: ./Castles/generated/Le_Castillet_generated.jpg', 'error');
            });
            
            // Vynutit naƒçten√≠, pokud u≈æ je cached
            if (img.complete && img.naturalWidth > 0) {
                debugLog('‚úÖ Obr√°zek ji≈æ v cache, zpracov√°v√°m...', 'success');
                img.dispatchEvent(new Event('load'));
            }
            
            // Sledovat A-Frame eventy
            scene.addEventListener('enter-vr', () => {
                debugLog('ü•Ω VSTUP DO VR RE≈ΩIMU!', 'success');
                debugLog('üëÄ Lev√© oko = layer 1, Prav√© oko = layer 2', 'info');
                toggleUI(false);
            });
            
            scene.addEventListener('exit-vr', () => {
                debugLog('üëã V√Ωstup z VR re≈æimu', 'info');
                toggleUI(true);
            });
        }
        
        async function forceVR() {
            debugLog('üöÄ Vynucen√Ω pokus o VR vstup...', 'info');
            
            try {
                if (!navigator.xr) {
                    throw new Error('WebXR nen√≠ dostupn√Ω');
                }
                
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!supported) {
                    throw new Error('Immersive VR nen√≠ podporov√°no');
                }
                
                debugLog('‚úÖ WebXR je funkƒçn√≠, hled√°m VR tlaƒç√≠tko...', 'success');
                
                const vrButton = document.querySelector('.a-enter-vr');
                if (vrButton) {
                    // Zv√Ωraznit p≈ôed kliknut√≠m
                    vrButton.style.background = '#dc3545';
                    vrButton.innerHTML = 'üîÑ SPOU≈†T√çM VR...';
                    
                    setTimeout(() => {
                        vrButton.click();
                        debugLog('üéØ VR tlaƒç√≠tko aktivov√°no!', 'success');
                    }, 500);
                } else {
                    throw new Error('VR tlaƒç√≠tko nenalezeno');
                }
                
            } catch (error) {
                debugLog(`‚ùå VR vstup selhal: ${error.message}`, 'error');
            }
        }
        
        function toggleUI(force = null) {
            const overlay = document.getElementById('uiOverlay');
            if (force !== null) {
                uiVisible = force;
            } else {
                uiVisible = !uiVisible;
            }
            
            overlay.style.display = uiVisible ? 'block' : 'none';
            debugLog(`UI ${uiVisible ? 'zobrazeno' : 'skryto'}`, 'info');
        }
        
        // Inicializace p≈ôi naƒçten√≠
        window.addEventListener('load', () => {
            debugLog('üöÄ Str√°nka naƒçtena', 'success');
            debugLog(`A-Frame verze: ${AFRAME.version}`, 'info');
            debugLog('üîß Z√°kladn√≠ A-Frame p≈ô√≠stup bez extern√≠ch knihoven', 'info');
            
            // Zkontrolovat WebXR
            if (navigator.xr) {
                debugLog('‚úÖ WebXR je dostupn√Ω', 'success');
                navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                    if (supported) {
                        debugLog('‚úÖ Immersive VR je podporov√°no!', 'success');
                    } else {
                        debugLog('‚ùå Immersive VR nen√≠ podporov√°no', 'error');
                    }
                });
            } else {
                debugLog('‚ùå WebXR nen√≠ dostupn√Ω', 'error');
            }
            
            // Auto-naƒçten√≠ sc√©ny
            setTimeout(() => {
                debugLog('üîÑ Auto-naƒç√≠t√°m VR sc√©nu...', 'info');
                loadVRScene();
            }, 2000);
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            debugLog(`GLOB√ÅLN√ç CHYBA: ${event.message}`, 'error');
        });
    </script>
</body>
</html>
