<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stereoskopick√Ω 180¬∞ VR Viewer - Babylon.js</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #renderCanvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        button {
            margin: 5px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
        
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <div id="controls">
        <h3>Stereo 180¬∞ VR Viewer</h3>
        <button onclick="toggleVR()">Spustit VR</button>
        <button onclick="resetCamera()">Reset kamery</button>
        <button onclick="toggleStereoMode()">P≈ôepnout stereo re≈æim</button>
    </div>
    
    <div id="info">
        <div>Ovl√°d√°n√≠: Ta≈æen√≠ my≈°√≠ = rotace</div>
        <div>Koleƒçko my≈°i = zoom</div>
        <div>Pro VR: Kliknƒõte na "Spustit VR"</div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let engine, scene, camera, photoDome;
        let stereoMode = false;
        
        // Inicializace Babylon.js
        function initBabylon() {
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true);
            
            // Vytvo≈ôen√≠ sc√©ny
            scene = new BABYLON.Scene(engine);
            
            // Vytvo≈ôen√≠ kamery
            camera = new BABYLON.FreeCamera('camera', new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControls(canvas, true);
            
            // Nastaven√≠ kamery pro VR
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Vytvo≈ôen√≠ PhotoDome pro 180¬∞ stereo obsah
            createPhotoDome();
            
            // P≈ôid√°n√≠ z√°kladn√≠ho osvƒõtlen√≠
            const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;
            

            // Render loop
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            // Resize handler
            window.addEventListener('resize', () => {
                engine.resize();
            });
        }
        
        // Vytvo≈ôen√≠ PhotoDome pro stereo obsah
        function createPhotoDome() {
            // Nejprve odstran√≠me existuj√≠c√≠ dome, pokud existuje
            if (photoDome) {
                photoDome.dispose();
            }
            
            // P≈ôevedeme obr√°zek na data URL (simulace - v re√°ln√©m pou≈æit√≠ byste mƒõli URL k obr√°zku)
            const imageUrl = getImageDataUrl(); // Tato funkce bude definov√°na n√≠≈æe
            
            // Vytvo≈ôen√≠ PhotoDome s nastaven√≠m pro 180¬∞ stereo
            photoDome = new BABYLON.PhotoDome(
                'photoDome',
                imageUrl,
                {
                    resolution: 64,
                    size: 1000,
                    useDirectMapping: false,
                    faceForward: false,
                    halfDomeMode: true // Pro 180¬∞ re≈æim
                },
                scene
            );
            
            // Nastaven√≠ pro stereoskopick√Ω obsah
            if (stereoMode) {
                setupStereoMode();
            }
        }
        
        // Nastaven√≠ stereoskopick√©ho re≈æimu
        function setupStereoMode() {
            // Babylon.js automaticky rozpozn√° side-by-side form√°t
            // kdy≈æ je sc√©na v XR/VR re≈æimu
            console.log('Stereo re≈æim aktivov√°n');
        }
        
        // Funkce pro z√≠sk√°n√≠ data URL obr√°zku (simulace)
        function getImageDataUrl() {
            // V re√°ln√© aplikaci byste zde mƒõli URL k va≈°emu stereo obr√°zku
            // Pro demo √∫ƒçely vrac√≠me placeholder
            return 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=';
            
            // Pro re√°ln√© pou≈æit√≠:
            // return 'path/to/your/stereo-180-image.jpg';
        }
        
        // VR funkce
        async function toggleVR() {
            try {
                if (scene.activeCamera !== camera) {
                    scene.activeCamera = camera;
                }
                
                // Pokus o spu≈°tƒõn√≠ WebXR
                const xrHelper = await scene.createDefaultXRExperienceAsync({
                    floorMeshes: []
                });
                
                if (xrHelper.baseExperience) {
                    console.log('VR re≈æim spu≈°tƒõn');
                    // V VR re≈æimu se automaticky aktivuje stereo zobrazen√≠
                    stereoMode = true;
                } else {
                    console.log('VR nen√≠ podporov√°no, pou≈æ√≠v√°m fullscreen re≈æim');
                    toggleFullscreen();
                }
                
          

            } catch (error) {
                console.log('VR nen√≠ dostupn√©, pou≈æ√≠v√°m fullscreen re≈æim:', error);
                toggleFullscreen();
            }
        }
        
        // Fullscreen jako fallback pro VR
        function toggleFullscreen() {
            const canvas = document.getElementById('renderCanvas');
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    console.log('Fullscreen nen√≠ podporov√°n:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Reset kamery
        function resetCamera() {
            camera.setTarget(BABYLON.Vector3.Zero());
            camera.position = new BABYLON.Vector3(0, 0, 0);
            camera.rotation = new BABYLON.Vector3(0, 0, 0);
        }
        
        // P≈ôepnut√≠ stereo re≈æimu
        function toggleStereoMode() {
            stereoMode = !stereoMode;
            
            if (stereoMode) {
                // Aktivace stereo re≈æimu
                console.log('Stereo re≈æim zapnut - pro pln√Ω efekt pou≈æijte VR');
                
                // M≈Ø≈æeme p≈ôidat vizu√°ln√≠ indikaci
                document.querySelector('#controls h3').innerHTML = 'Stereo 180¬∞ VR Viewer (STEREO MODE)';
                
                // Pro non-VR stereo zobrazen√≠ (anaglyph nebo side-by-side)
                setupNonVRStereo();
                
            } else {
                console.log('Stereo re≈æim vypnut');
                document.querySelector('#controls h3').innerHTML = 'Stereo 180¬∞ VR Viewer';
                
                // Reset na mono re≈æim
                engine.disableVR();
            }
            
            createPhotoDome();
        }
        
        // Non-VR stereo setup (pro testov√°n√≠ bez VR headsetu)
        function setupNonVRStereo() {
            // Pro testov√°n√≠ bez VR m≈Ø≈æeme pou≈æ√≠t anaglyph efekt
            const postProcess = new BABYLON.AnaglyphPostProcess('anaglyph', 1.0, camera);
        }
        
        // Funkce pro naƒçten√≠ vlastn√≠ho obr√°zku
        function loadCustomImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Aktualizace PhotoDome s nov√Ωm obr√°zkem
                        if (photoDome) {
                            photoDome.dispose();
                        }
                        
                        photoDome = new BABYLON.PhotoDome(
                            'photoDome',
                            e.target.result,
                            {
                                resolution: 64,
                                size: 1000,
                                useDirectMapping: false,
                                faceForward: false,
                                halfDomeMode: true
                            },
                            scene
                        );
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // P≈ôid√°n√≠ dal≈°√≠ch ovl√°dac√≠ch prvk≈Ø
        function addMoreControls() {
            const controls = document.getElementById('controls');
            const loadButton = document.createElement('button');
            loadButton.textContent = 'Naƒç√≠st obr√°zek';
            loadButton.onclick = loadCustomImage;
            controls.appendChild(loadButton);
            
            // P≈ôid√°n√≠ slideru pro FOV
            const fovLabel = document.createElement('div');
            fovLabel.textContent = 'Field of View:';
            fovLabel.style.color = 'white';
            fovLabel.style.marginTop = '10px';
            controls.appendChild(fovLabel);
            
          


            const fovSlider = document.createElement('input');
            fovSlider.type = 'range';
            fovSlider.min = '45';
            fovSlider.max = '120';
            fovSlider.value = '75';
            fovSlider.style.width = '150px';
            fovSlider.oninput = function() {
                if (camera) {
                    camera.fov = parseFloat(this.value) * Math.PI / 180;
                }
            };
            controls.appendChild(fovSlider);
        }
        
        // Kl√°vesov√© zkratky
        function setupKeyboardControls() {
            document.addEventListener('keydown', (event) => {
                switch(event.key) {
                    case 'v':
                    case 'V':
                        toggleVR();
                        break;
                    case 'r':
                    case 'R':
                        resetCamera();
                        break;
                    case 's':
                    case 'S':
                        toggleStereoMode();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            });
        }
        
        // Debugging informace
        function showDebugInfo() {
            setInterval(() => {
                const info = document.getElementById('info');
                if (info && camera) {
                    info.innerHTML = `
                        <div>Ovl√°d√°n√≠: Ta≈æen√≠ my≈°√≠ = rotace</div>
                        <div>Koleƒçko my≈°i = zoom</div>
                        <div>Kl√°vesy: V=VR, R=Reset, S=Stereo, F=Fullscreen</div>
                        <div>FOV: ${(camera.fov * 180 / Math.PI).toFixed(1)}¬∞</div>
                        <div>Position: ${camera.position.x.toFixed(2)}, ${camera.position.y.toFixed(2)}, ${camera.position.z.toFixed(2)}</div>
                        <div>Stereo: ${stereoMode ? 'ON' : 'OFF'}</div>
                    `;
                }
            }, 100);
        }
        
        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            initBabylon();
            addMoreControls();
            setupKeyboardControls();
            showDebugInfo();
            
            // Informace o pou≈æit√≠
            console.log('=== Stereo 180¬∞ VR Viewer ===');
            console.log('Ovl√°d√°n√≠:');
            console.log('- My≈°: Ta≈æen√≠ = rotace, koleƒçko = zoom');
            console.log('- Kl√°vesy: V = VR, R = Reset, S = Stereo, F = Fullscreen');
            console.log('- Pro nejlep≈°√≠ stereo efekt pou≈æijte VR headset');
        });
        
        // Cleanup p≈ôi zav≈ôen√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (engine) {
                engine.dispose();
            }
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Chyba aplikace:', event.error);
        });
        
    </script>
    
    <!-- Dodateƒçn√© styly pro lep≈°√≠ UX -->
    <style>
        /* P≈ôid√°n√≠ animac√≠ pro tlaƒç√≠tka */
        button {
            transition: all 0.3s ease;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Styling pro slider */
        input[type="range"] {
            margin: 5px 0;
        }
        
        /* Loading indik√°tor */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 200;
        }
        
        /* Responzivn√≠ design pro mobily */
        @media (max-width: 768px) {
            #controls {
                top: 5px;
                left: 5px;
                padding: 5px;
                font-size: 12px;
            }
            
            #controls h3 {
                font-size: 14px;
                margin: 0 0 5px 0;
            }
            
            button {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            #info {
                bottom: 5px;
                left: 5px;
                padding: 5px;
                font-size: 10px;
            }
        }
        
        /* Kurzor pro VR re≈æim */
        .vr-cursor {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .vr-mode .vr-cursor {
            opacity: 1;
        }
    </style>
    
    <!-- VR kurzor -->
    <div class="vr-cursor" id="vrCursor"></div>
    
    <script>
        // Pokraƒçov√°n√≠ JavaScript k√≥du
        
        // Funkce pro zobrazen√≠ loading indik√°toru
        function showLoading(message = 'Naƒç√≠t√°n√≠...') {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loadingIndicator';
            loading.textContent = message;
            document.body.appendChild(loading);
        }
        
        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.remove();
            }
        }
        
        // Vylep≈°en√° funkce pro naƒç√≠t√°n√≠ obr√°zku s progress indik√°torem
        function loadCustomImageEnhanced() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    showLoading('Naƒç√≠t√°n√≠ obr√°zku...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Dispose star√©ho PhotoDome
                            if (photoDome) {
                                photoDome.dispose();
                            }
                            
                            // Vytvo≈ôen√≠ nov√©ho PhotoDome
                            photoDome = new BABYLON.PhotoDome(
                                'photoDome',
                                e.target.result,
                                {
                                    resolution: 64,
                                    size: 1000,
                                    useDirectMapping: false,
                                    faceForward: false,
                                    halfDomeMode: true
                                },
                                scene
                            );
                            
                            hideLoading();
                            console.log('Obr√°zek √∫spƒõ≈°nƒõ naƒçten');
                            
                        } catch (error) {
                            hideLoading();
                            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ obr√°zku:', error);
                            alert('Chyba p≈ôi naƒç√≠t√°n√≠ obr√°zku. Zkuste jin√Ω soubor.');
                        }
                    };
                    
                    reader.onerror = function() {
                        hideLoading();
                        alert('Chyba p≈ôi ƒçten√≠ souboru.');
                    };
                    
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

       
        // Detekce VR podpory
        function checkVRSupport() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                    if (supported) {
                        console.log('WebXR VR je podporov√°no');
                        document.querySelector('button[onclick="toggleVR()"]').style.background = '#4CAF50';
                    } else {
                        console.log('WebXR VR nen√≠ podporov√°no');
                        document.querySelector('button[onclick="toggleVR()"]').style.background = '#FF9800';
                        document.querySelector('button[onclick="toggleVR()"]').textContent = 'VR (Fullscreen)';
                    }
                });
            } else {
                console.log('WebXR nen√≠ podporov√°no v tomto prohl√≠≈æeƒçi');
                document.querySelector('button[onclick="toggleVR()"]').style.background = '#f44336';
                document.querySelector('button[onclick="toggleVR()"]').textContent = 'VR (Nedostupn√©)';
            }
        }
        
        // P≈ôid√°n√≠ demo obr√°zku (base64 encoded mal√Ω testovac√≠ obr√°zek)
        function createDemoImage() {
            // Vytvo≈ô√≠me jednoduch√Ω side-by-side testovac√≠ pattern
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // Lev√© oko - modr√Ω gradient
            const gradientLeft = ctx.createLinearGradient(0, 0, 1024, 1024);
            gradientLeft.addColorStop(0, '#87CEEB');
            gradientLeft.addColorStop(1, '#4682B4');
            ctx.fillStyle = gradientLeft;
            ctx.fillRect(0, 0, 1024, 1024);
            
            // Prav√© oko - zelen√Ω gradient
            const gradientRight = ctx.createLinearGradient(1024, 0, 2048, 1024);
            gradientRight.addColorStop(0, '#90EE90');
            gradientRight.addColorStop(1, '#228B22');
            ctx.fillStyle = gradientRight;
            ctx.fillRect(1024, 0, 1024, 1024);
            
            // P≈ôid√°n√≠ textu pro identifikaci
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.fillText('LEV√â OKO', 50, 100);
            ctx.fillText('180¬∞ STEREO TEST', 50, 200);
            
            ctx.fillText('PRAV√â OKO', 1074, 100);
            ctx.fillText('180¬∞ STEREO TEST', 1074, 200);
            
            // P≈ôid√°n√≠ m≈ô√≠≈æky pro testov√°n√≠
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 2;
            for (let i = 0; i <= 10; i++) {
                // Vertik√°ln√≠ ƒç√°ry
                ctx.beginPath();
                ctx.moveTo(i * 102.4, 0);
                ctx.lineTo(i * 102.4, 1024);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(1024 + i * 102.4, 0);
                ctx.lineTo(1024 + i * 102.4, 1024);
                ctx.stroke();
                
                // Horizont√°ln√≠ ƒç√°ry
                ctx.beginPath();
                ctx.moveTo(0, i * 102.4);
                ctx.lineTo(1024, i * 102.4);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(1024, i * 102.4);
                ctx.lineTo(2048, i * 102.4);
                ctx.stroke();
            }
            
            return canvas.toDataURL('image/jpeg', 0.9);
        }
        
        // Aktualizace funkce pro vytvo≈ôen√≠ PhotoDome s demo obr√°zkem
        function createPhotoDome() {
            if (photoDome) {
                photoDome.dispose();
            }
            
            // Pou≈æit√≠ demo obr√°zku pokud nen√≠ jin√Ω k dispozici
            const imageUrl = createDemoImage();
            
            photoDome = new BABYLON.PhotoDome(
                'photoDome',
                imageUrl,
                {
                    resolution: 64,
                    size: 1000,
                    useDirectMapping: false,
                    faceForward: false,
                    halfDomeMode: true // D≈Øle≈æit√© pro 180¬∞ obsah
                },
                scene
            );
            
            // Nastaven√≠ pro stereoskopick√Ω obsah
            if (stereoMode) {
                setupStereoMode();
            }
        }
        
        // Pokroƒçil√© ovl√°d√°n√≠ kamery pro lep≈°√≠ VR z√°≈æitek
        function setupAdvancedCameraControls() {
            // Omezen√≠ rotace kamery (prevence "p≈ôeklopen√≠")
            camera.upperBetaLimit = Math.PI;
            camera.lowerBetaLimit = 0;
            
            // Rychlost pohybu
            camera.angularSensibilityX = 1000;
            camera.angularSensibilityY = 1000;
            
            // Vyhlazen√≠ pohybu
            camera.inertia = 0.9;
            
            // Nastaven√≠ FOV pro optim√°ln√≠ VR z√°≈æitek
            camera.fov = 75 * Math.PI / 180;
        }
        
        // Funkce pro export nastaven√≠
        function exportSettings() {
            const settings = {
                fov: camera.fov,
                position: camera.position,
                rotation: camera.rotation,
                stereoMode: stereoMode,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'vr-viewer-settings.json';
            link.click();
        }
        
        // Funkce pro import nastaven√≠
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            
                            if (settings.fov) camera.fov = settings.fov;
                            if (settings.position) camera.position = new BABYLON.Vector3(settings.position.x, settings.position.y, settings.position.z);
                            if (settings.rotation) camera.rotation = new BABYLON.Vector3(settings.rotation.x, settings.rotation.y, settings.rotation.z);
                            if (typeof settings.stereoMode !== 'undefined') {
                                stereoMode = settings.stereoMode;
                                if (stereoMode) {
                                    document.querySelector('#controls h3').innerHTML = 'Stereo 180¬∞ VR Viewer (STEREO MODE)';
                                }
                            }
                            
                            console.log('Nastaven√≠ √∫spƒõ≈°nƒõ naƒçteno');
                            
                        } catch (error) {
                            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:', error);
                            alert('Chyba p≈ôi naƒç√≠t√°n√≠ souboru s nastaven√≠m');
                        }
                    };
                    reader.readAsText(file);
                }

            };
            input.click();
        }
        
        // P≈ôid√°n√≠ pokroƒçil√Ωch ovl√°dac√≠ch prvk≈Ø
        function addAdvancedControls() {
            const controls = document.getElementById('controls');
            
            // Separator
            const separator = document.createElement('hr');
            separator.style.border = '1px solid #555';
            separator.style.margin = '10px 0';
            controls.appendChild(separator);
            
            // Export/Import tlaƒç√≠tka
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Export nastaven√≠';
            exportBtn.onclick = exportSettings;
            controls.appendChild(exportBtn);
            
            const importBtn = document.createElement('button');
            importBtn.textContent = 'Import nastaven√≠';
            importBtn.onclick = importSettings;
            controls.appendChild(importBtn);
            
            // Aktualizovan√° funkce pro naƒçten√≠ obr√°zku
            const loadBtn = controls.querySelector('button[onclick="loadCustomImage"]');
            if (loadBtn) {
                loadBtn.onclick = loadCustomImageEnhanced;
            }
            
            // P≈ôep√≠naƒç kvality
            const qualityLabel = document.createElement('div');
            qualityLabel.textContent = 'Kvalita renderov√°n√≠:';
            qualityLabel.style.color = 'white';
            qualityLabel.style.marginTop = '10px';
            controls.appendChild(qualityLabel);
            
            const qualitySelect = document.createElement('select');
            qualitySelect.style.margin = '5px 0';
            qualitySelect.style.padding = '5px';
            
            const qualities = [
                {value: 32, text: 'N√≠zk√° (32)'},
                {value: 64, text: 'St≈ôedn√≠ (64)'},
                {value: 128, text: 'Vysok√° (128)'},
                {value: 256, text: 'Ultra (256)'}
            ];
            
            qualities.forEach(quality => {
                const option = document.createElement('option');
                option.value = quality.value;
                option.textContent = quality.text;
                if (quality.value === 64) option.selected = true;
                qualitySelect.appendChild(option);
            });
            
            qualitySelect.onchange = function() {
                updatePhotoDomelity(parseInt(this.value));
            };
            
            controls.appendChild(qualitySelect);
        }
        
        // Funkce pro aktualizaci kvality PhotoDome
        function updatePhotoDomeQuality(resolution) {
            if (photoDome) {
                const currentTexture = photoDome.photoTexture;
                photoDome.dispose();
                
                showLoading('Aktualizace kvality...');
                
                setTimeout(() => {
                    photoDome = new BABYLON.PhotoDome(
                        'photoDome',
                        currentTexture.name,
                        {
                            resolution: resolution,
                            size: 1000,
                            useDirectMapping: false,
                            faceForward: false,
                            halfDomeMode: true
                        },
                        scene
                    );
                    
                    hideLoading();
                    console.log(`Kvalita aktualizov√°na na: ${resolution}`);
                }, 100);
            }
        }
        
        // Performance monitoring
        function setupPerformanceMonitoring() {
            const perfDiv = document.createElement('div');
            perfDiv.id = 'performance';
            perfDiv.style.position = 'absolute';
            perfDiv.style.top = '10px';
            perfDiv.style.right = '10px';
            perfDiv.style.background = 'rgba(0,0,0,0.7)';
            perfDiv.style.color = 'white';
            perfDiv.style.padding = '10px';
            perfDiv.style.borderRadius = '5px';
            perfDiv.style.fontSize = '12px';
            perfDiv.style.minWidth = '120px';
            document.body.appendChild(perfDiv);
            

            setInterval(() => {
                if (engine && scene) {
                    const fps = Math.round(engine.getFps());
                    const renderTime = scene.getEngine().getDeltaTime();
                    const triangles = scene.getActiveMeshes().length;
                    
                    perfDiv.innerHTML = `
                        <div><strong>Performance:</strong></div>
                        <div>FPS: ${fps}</div>
                        <div>Delta: ${renderTime.toFixed(1)}ms</div>
                        <div>Meshes: ${triangles}</div>
                        <div>Memory: ${(performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 'N/A')}MB</div>
                    `;
                }
            }, 1000);
        }
        
        // Aktualizovan√° inicializace
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Inicializace Stereo 180¬∞ VR Vieweru...');
            
            showLoading('Inicializace Babylon.js...');
            
            // Inicializace s timeout pro lep≈°√≠ UX
            setTimeout(() => {
                try {
                    initBabylon();
                    setupAdvancedCameraControls();
                    addMoreControls();
                    addAdvancedControls();
                    setupKeyboardControls();
                    checkVRSupport();
                    setupPerformanceMonitoring();
                    showDebugInfo();
                    
                    hideLoading();
                    
                    // Uv√≠tac√≠ zpr√°va
                    console.log('‚úÖ VR Viewer √∫spƒõ≈°nƒõ inicializov√°n!');
                    console.log('üì± Pro nejlep≈°√≠ z√°≈æitek pou≈æijte VR headset');
                    console.log('üñºÔ∏è  Demo obr√°zek byl naƒçten - m≈Ø≈æete nahr√°t vlastn√≠');
                    
                } catch (error) {
                    hideLoading();
                    console.error('‚ùå Chyba p≈ôi inicializaci:', error);
                    
                    // Zobrazen√≠ error zpr√°vy u≈æivateli
                    const errorDiv = document.createElement('div');
                    errorDiv.style.position = 'fixed';
                    errorDiv.style.top = '50%';
                    errorDiv.style.left = '50%';
                    errorDiv.style.transform = 'translate(-50%, -50%)';
                    errorDiv.style.background = 'rgba(255,0,0,0.9)';
                    errorDiv.style.color = 'white';
                    errorDiv.style.padding = '20px';
                    errorDiv.style.borderRadius = '10px';
                    errorDiv.style.zIndex = '1000';
                    errorDiv.innerHTML = `
                        <h3>Chyba p≈ôi naƒç√≠t√°n√≠</h3>
                        <p>Nepoda≈ôilo se inicializovat VR viewer.</p>
                        <p>Zkuste obnovit str√°nku nebo pou≈æ√≠t jin√Ω prohl√≠≈æeƒç.</p>
                        <button onclick="location.reload()" style="margin-top: 10px;">Obnovit str√°nku</button>
                    `;
                    document.body.appendChild(errorDiv);
                }
            }, 500);
        });
        
        // Touch ovl√°d√°n√≠ pro mobiln√≠ za≈ô√≠zen√≠
        function setupTouchControls() {
            let touchStartX = 0;
            let touchStartY = 0;
            let rotating = false;
            
            const canvas = document.getElementById('renderCanvas');
            
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    rotating = true;
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (rotating && e.touches.length === 1) {
                    const deltaX = e.touches[0].clientX - touchStartX;
                    const deltaY = e.touches[0].clientY - touchStartY;
                    
                    // Rotace kamery na z√°kladƒõ touch pohybu
                    camera.rotation.y += deltaX * 0.005;
                    camera.rotation.x += deltaY * 0.005;
                    
                    // Omezen√≠ vertik√°ln√≠ rotace
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                    
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            });
            
            canvas.addEventListener('touchend', () => {
                rotating = false;
            });
            
            // Pinch-to-zoom pro mobily
            let initialDistance = 0;
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    initialDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (initialDistance > 0) {
                        const scale = distance / initialDistance;
                        camera.fov = Math.max(30 * Math.PI / 180, Math.min(120 * Math.PI / 180, camera.fov / scale));
                    }
                    initialDistance = distance;
                }
            });
        }
        
        // P≈ôid√°n√≠ touch ovl√°d√°n√≠ do inicializace
        function initBabylonEnhanced() {
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true, {
                antialias: true,
                stencil: true,
                preserveDrawingBuffer: true
            });
            
            scene = new BABYLON.Scene(engine);
            scene.actionManager = new BABYLON.ActionManager(scene);
            
            // Vytvo≈ôen√≠ kamery s lep≈°√≠m nastaven√≠m pro VR
            camera = new BABYLON.UniversalCamera('camera', new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControls(canvas, true);
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Touch ovl√°d√°n√≠
            setupTouchControls();
            
            createPhotoDome();
            
            const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;
            
            // Optimalizace pro VR
            scene.freezeActiveMeshes();
            engine.enableOfflineSupport = false;
            
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            window.addEventListener('resize', () => {
                engine.resize();
            });
        }
        
        // Aktualizace hlavn√≠ inicializaƒçn√≠ funkce
        function initBabylon() {
            initBabylonEnhanced();
        }
        
    </script>
</body>
</html>











                    
            
                
            
        
                
            
                            
    
