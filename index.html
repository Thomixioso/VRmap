<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stereoskopický 180° VR Viewer - Babylon.js</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }
        
        #renderCanvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        button {
            margin: 5px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
        
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <div id="controls">
        <h3>Stereo 180° VR Viewer</h3>
        <button onclick="toggleVR()">Spustit VR</button>
        <button onclick="resetCamera()">Reset kamery</button>
        <button onclick="toggleStereoMode()">Přepnout stereo režim</button>
    </div>
    
    <div id="info">
        <div>Ovládání: Tažení myší = rotace</div>
        <div>Kolečko myši = zoom</div>
        <div>Pro VR: Klikněte na "Spustit VR"</div>
    </div>

    <script>
        // Globální proměnné
        let engine, scene, camera, photoDome;
        let stereoMode = false;
        
        // Inicializace Babylon.js
        function initBabylon() {
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true);
            
            // Vytvoření scény
            scene = new BABYLON.Scene(engine);
            
            // Vytvoření kamery
            camera = new BABYLON.FreeCamera('camera', new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControls(canvas, true);
            
            // Nastavení kamery pro VR
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Vytvoření PhotoDome pro 180° stereo obsah
            createPhotoDome();
            
            // Přidání základního osvětlení
            const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;
            

            // Render loop
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            // Resize handler
            window.addEventListener('resize', () => {
                engine.resize();
            });
        }
        
        // Vytvoření PhotoDome pro stereo obsah
        function createPhotoDome() {
            // Nejprve odstraníme existující dome, pokud existuje
            if (photoDome) {
                photoDome.dispose();
            }
            
            // Převedeme obrázek na data URL (simulace - v reálném použití byste měli URL k obrázku)
            const imageUrl = getImageDataUrl(); // Tato funkce bude definována níže
            
            // Vytvoření PhotoDome s nastavením pro 180° stereo
            photoDome = new BABYLON.PhotoDome(
                'photoDome',
                imageUrl,
                {
                    resolution: 64,
                    size: 1000,
                    useDirectMapping: false,
                    faceForward: false,
                    halfDomeMode: true // Pro 180° režim
                },
                scene
            );
            
            // Nastavení pro stereoskopický obsah
            if (stereoMode) {
                setupStereoMode();
            }
        }
        
        // Nastavení stereoskopického režimu
        function setupStereoMode() {
            // Babylon.js automaticky rozpozná side-by-side formát
            // když je scéna v XR/VR režimu
            console.log('Stereo režim aktivován');
        }
        
        // Funkce pro získání data URL obrázku (simulace)
        function getImageDataUrl() {
            // V reálné aplikaci byste zde měli URL k vašemu stereo obrázku
            // Pro demo účely vracíme placeholder
            return 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=';
            
            // Pro reálné použití:
            // return 'path/to/your/stereo-180-image.jpg';
        }
        
        // VR funkce
        async function toggleVR() {
            try {
                if (scene.activeCamera !== camera) {
                    scene.activeCamera = camera;
                }
                
                // Pokus o spuštění WebXR
                const xrHelper = await scene.createDefaultXRExperienceAsync({
                    floorMeshes: []
                });
                
                if (xrHelper.baseExperience) {
                    console.log('VR režim spuštěn');
                    // V VR režimu se automaticky aktivuje stereo zobrazení
                    stereoMode = true;
                } else {
                    console.log('VR není podporováno, používám fullscreen režim');
                    toggleFullscreen();
                }
                
          

            } catch (error) {
                console.log('VR není dostupné, používám fullscreen režim:', error);
                toggleFullscreen();
            }
        }
        
        // Fullscreen jako fallback pro VR
        function toggleFullscreen() {
            const canvas = document.getElementById('renderCanvas');
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    console.log('Fullscreen není podporován:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Reset kamery
        function resetCamera() {
            camera.setTarget(BABYLON.Vector3.Zero());
            camera.position = new BABYLON.Vector3(0, 0, 0);
            camera.rotation = new BABYLON.Vector3(0, 0, 0);
        }
        
        // Přepnutí stereo režimu
        function toggleStereoMode() {
            stereoMode = !stereoMode;
            
            if (stereoMode) {
                // Aktivace stereo režimu
                console.log('Stereo režim zapnut - pro plný efekt použijte VR');
                
                // Můžeme přidat vizuální indikaci
                document.querySelector('#controls h3').innerHTML = 'Stereo 180° VR Viewer (STEREO MODE)';
                
                // Pro non-VR stereo zobrazení (anaglyph nebo side-by-side)
                setupNonVRStereo();
                
            } else {
                console.log('Stereo režim vypnut');
                document.querySelector('#controls h3').innerHTML = 'Stereo 180° VR Viewer';
                
                // Reset na mono režim
                engine.disableVR();
            }
            
            createPhotoDome();
        }
        
        // Non-VR stereo setup (pro testování bez VR headsetu)
        function setupNonVRStereo() {
            // Pro testování bez VR můžeme použít anaglyph efekt
            const postProcess = new BABYLON.AnaglyphPostProcess('anaglyph', 1.0, camera);
        }
        
        // Funkce pro načtení vlastního obrázku
        function loadCustomImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Aktualizace PhotoDome s novým obrázkem
                        if (photoDome) {
                            photoDome.dispose();
                        }
                        
                        photoDome = new BABYLON.PhotoDome(
                            'photoDome',
                            e.target.result,
                            {
                                resolution: 64,
                                size: 1000,
                                useDirectMapping: false,
                                faceForward: false,
                                halfDomeMode: true
                            },
                            scene
                        );
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // Přidání dalších ovládacích prvků
        function addMoreControls() {
            const controls = document.getElementById('controls');
            const loadButton = document.createElement('button');
            loadButton.textContent = 'Načíst obrázek';
            loadButton.onclick = loadCustomImage;
            controls.appendChild(loadButton);
            
            // Přidání slideru pro FOV
            const fovLabel = document.createElement('div');
            fovLabel.textContent = 'Field of View:';
            fovLabel.style.color = 'white';
            fovLabel.style.marginTop = '10px';
            controls.appendChild(fovLabel);
            
          


            const fovSlider = document.createElement('input');
            fovSlider.type = 'range';
            fovSlider.min = '45';
            fovSlider.max = '120';
            fovSlider.value = '75';
            fovSlider.style.width = '150px';
            fovSlider.oninput = function() {
                if (camera) {
                    camera.fov = parseFloat(this.value) * Math.PI / 180;
                }
            };
            controls.appendChild(fovSlider);
        }
        
        // Klávesové zkratky
        function setupKeyboardControls() {
            document.addEventListener('keydown', (event) => {
                switch(event.key) {
                    case 'v':
                    case 'V':
                        toggleVR();
                        break;
                    case 'r':
                    case 'R':
                        resetCamera();
                        break;
                    case 's':
                    case 'S':
                        toggleStereoMode();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            });
        }
        
        // Debugging informace
        function showDebugInfo() {
            setInterval(() => {
                const info = document.getElementById('info');
                if (info && camera) {
                    info.innerHTML = `
                        <div>Ovládání: Tažení myší = rotace</div>
                        <div>Kolečko myši = zoom</div>
                        <div>Klávesy: V=VR, R=Reset, S=Stereo, F=Fullscreen</div>
                        <div>FOV: ${(camera.fov * 180 / Math.PI).toFixed(1)}°</div>
                        <div>Position: ${camera.position.x.toFixed(2)}, ${camera.position.y.toFixed(2)}, ${camera.position.z.toFixed(2)}</div>
                        <div>Stereo: ${stereoMode ? 'ON' : 'OFF'}</div>
                    `;
                }
            }, 100);
        }
        
        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            initBabylon();
            addMoreControls();
            setupKeyboardControls();
            showDebugInfo();
            
            // Informace o použití
            console.log('=== Stereo 180° VR Viewer ===');
            console.log('Ovládání:');
            console.log('- Myš: Tažení = rotace, kolečko = zoom');
            console.log('- Klávesy: V = VR, R = Reset, S = Stereo, F = Fullscreen');
            console.log('- Pro nejlepší stereo efekt použijte VR headset');
        });
        
        // Cleanup při zavření stránky
        window.addEventListener('beforeunload', () => {
            if (engine) {
                engine.dispose();
            }
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Chyba aplikace:', event.error);
        });
        
    </script>
    
    <!-- Dodatečné styly pro lepší UX -->
    <style>
        /* Přidání animací pro tlačítka */
        button {
            transition: all 0.3s ease;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Styling pro slider */
        input[type="range"] {
            margin: 5px 0;
        }
        
        /* Loading indikátor */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 200;
        }
        
        /* Responzivní design pro mobily */
        @media (max-width: 768px) {
            #controls {
                top: 5px;
                left: 5px;
                padding: 5px;
                font-size: 12px;
            }
            
            #controls h3 {
                font-size: 14px;
                margin: 0 0 5px 0;
            }
            
            button {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            #info {
                bottom: 5px;
                left: 5px;
                padding: 5px;
                font-size: 10px;
            }
        }
        
        /* Kurzor pro VR režim */
        .vr-cursor {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .vr-mode .vr-cursor {
            opacity: 1;
        }
    </style>
    
    <!-- VR kurzor -->
    <div class="vr-cursor" id="vrCursor"></div>
    
    <script>
        // Pokračování JavaScript kódu
        
        // Funkce pro zobrazení loading indikátoru
        function showLoading(message = 'Načítání...') {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loadingIndicator';
            loading.textContent = message;
            document.body.appendChild(loading);
        }
        
        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.remove();
            }
        }
        
        // Vylepšená funkce pro načítání obrázku s progress indikátorem
        function loadCustomImageEnhanced() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    showLoading('Načítání obrázku...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Dispose starého PhotoDome
                            if (photoDome) {
                                photoDome.dispose();
                            }
                            
                            // Vytvoření nového PhotoDome
                            photoDome = new BABYLON.PhotoDome(
                                'photoDome',
                                e.target.result,
                                {
                                    resolution: 64,
                                    size: 1000,
                                    useDirectMapping: false,
                                    faceForward: false,
                                    halfDomeMode: true
                                },
                                scene
                            );
                            
                            hideLoading();
                            console.log('Obrázek úspěšně načten');
                            
                        } catch (error) {
                            hideLoading();
                            console.error('Chyba při načítání obrázku:', error);
                            alert('Chyba při načítání obrázku. Zkuste jiný soubor.');
                        }
                    };
                    
                    reader.onerror = function() {
                        hideLoading();
                        alert('Chyba při čtení souboru.');
                    };
                    
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

       
        // Detekce VR podpory
        function checkVRSupport() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                    if (supported) {
                        console.log('WebXR VR je podporováno');
                        document.querySelector('button[onclick="toggleVR()"]').style.background = '#4CAF50';
                    } else {
                        console.log('WebXR VR není podporováno');
                        document.querySelector('button[onclick="toggleVR()"]').style.background = '#FF9800';
                        document.querySelector('button[onclick="toggleVR()"]').textContent = 'VR (Fullscreen)';
                    }
                });
            } else {
                console.log('WebXR není podporováno v tomto prohlížeči');
                document.querySelector('button[onclick="toggleVR()"]').style.background = '#f44336';
                document.querySelector('button[onclick="toggleVR()"]').textContent = 'VR (Nedostupné)';
            }
        }
        
        // Přidání demo obrázku (base64 encoded malý testovací obrázek)
        function createDemoImage() {
            // Vytvoříme jednoduchý side-by-side testovací pattern
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // Levé oko - modrý gradient
            const gradientLeft = ctx.createLinearGradient(0, 0, 1024, 1024);
            gradientLeft.addColorStop(0, '#87CEEB');
            gradientLeft.addColorStop(1, '#4682B4');
            ctx.fillStyle = gradientLeft;
            ctx.fillRect(0, 0, 1024, 1024);
            
            // Pravé oko - zelený gradient
            const gradientRight = ctx.createLinearGradient(1024, 0, 2048, 1024);
            gradientRight.addColorStop(0, '#90EE90');
            gradientRight.addColorStop(1, '#228B22');
            ctx.fillStyle = gradientRight;
            ctx.fillRect(1024, 0, 1024, 1024);
            
            // Přidání textu pro identifikaci
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.fillText('LEVÉ OKO', 50, 100);
            ctx.fillText('180° STEREO TEST', 50, 200);
            
            ctx.fillText('PRAVÉ OKO', 1074, 100);
            ctx.fillText('180° STEREO TEST', 1074, 200);
            
            // Přidání mřížky pro testování
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 2;
            for (let i = 0; i <= 10; i++) {
                // Vertikální čáry
                ctx.beginPath();
                ctx.moveTo(i * 102.4, 0);
                ctx.lineTo(i * 102.4, 1024);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(1024 + i * 102.4, 0);
                ctx.lineTo(1024 + i * 102.4, 1024);
                ctx.stroke();
                
                // Horizontální čáry
                ctx.beginPath();
                ctx.moveTo(0, i * 102.4);
                ctx.lineTo(1024, i * 102.4);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(1024, i * 102.4);
                ctx.lineTo(2048, i * 102.4);
                ctx.stroke();
            }
            
            return canvas.toDataURL('image/jpeg', 0.9);
        }
        
        // Aktualizace funkce pro vytvoření PhotoDome s demo obrázkem
        function createPhotoDome() {
            if (photoDome) {
                photoDome.dispose();
            }
            
            // Použití demo obrázku pokud není jiný k dispozici
            const imageUrl = createDemoImage();
            
            photoDome = new BABYLON.PhotoDome(
                'photoDome',
                imageUrl,
                {
                    resolution: 64,
                    size: 1000,
                    useDirectMapping: false,
                    faceForward: false,
                    halfDomeMode: true // Důležité pro 180° obsah
                },
                scene
            );
            
            // Nastavení pro stereoskopický obsah
            if (stereoMode) {
                setupStereoMode();
            }
        }
        
        // Pokročilé ovládání kamery pro lepší VR zážitek
        function setupAdvancedCameraControls() {
            // Omezení rotace kamery (prevence "překlopení")
            camera.upperBetaLimit = Math.PI;
            camera.lowerBetaLimit = 0;
            
            // Rychlost pohybu
            camera.angularSensibilityX = 1000;
            camera.angularSensibilityY = 1000;
            
            // Vyhlazení pohybu
            camera.inertia = 0.9;
            
            // Nastavení FOV pro optimální VR zážitek
            camera.fov = 75 * Math.PI / 180;
        }
        
        // Funkce pro export nastavení
        function exportSettings() {
            const settings = {
                fov: camera.fov,
                position: camera.position,
                rotation: camera.rotation,
                stereoMode: stereoMode,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'vr-viewer-settings.json';
            link.click();
        }
        
        // Funkce pro import nastavení
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            
                            if (settings.fov) camera.fov = settings.fov;
                            if (settings.position) camera.position = new BABYLON.Vector3(settings.position.x, settings.position.y, settings.position.z);
                            if (settings.rotation) camera.rotation = new BABYLON.Vector3(settings.rotation.x, settings.rotation.y, settings.rotation.z);
                            if (typeof settings.stereoMode !== 'undefined') {
                                stereoMode = settings.stereoMode;
                                if (stereoMode) {
                                    document.querySelector('#controls h3').innerHTML = 'Stereo 180° VR Viewer (STEREO MODE)';
                                }
                            }
                            
                            console.log('Nastavení úspěšně načteno');
                            
                        } catch (error) {
                            console.error('Chyba při načítání nastavení:', error);
                            alert('Chyba při načítání souboru s nastavením');
                        }
                    };
                    reader.readAsText(file);
                }

            };
            input.click();
        }
        
        // Přidání pokročilých ovládacích prvků
        function addAdvancedControls() {
            const controls = document.getElementById('controls');
            
            // Separator
            const separator = document.createElement('hr');
            separator.style.border = '1px solid #555';
            separator.style.margin = '10px 0';
            controls.appendChild(separator);
            
            // Export/Import tlačítka
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Export nastavení';
            exportBtn.onclick = exportSettings;
            controls.appendChild(exportBtn);
            
            const importBtn = document.createElement('button');
            importBtn.textContent = 'Import nastavení';
            importBtn.onclick = importSettings;
            controls.appendChild(importBtn);
            
            // Aktualizovaná funkce pro načtení obrázku
            const loadBtn = controls.querySelector('button[onclick="loadCustomImage"]');
            if (loadBtn) {
                loadBtn.onclick = loadCustomImageEnhanced;
            }
            
            // Přepínač kvality
            const qualityLabel = document.createElement('div');
            qualityLabel.textContent = 'Kvalita renderování:';
            qualityLabel.style.color = 'white';
            qualityLabel.style.marginTop = '10px';
            controls.appendChild(qualityLabel);
            
            const qualitySelect = document.createElement('select');
            qualitySelect.style.margin = '5px 0';
            qualitySelect.style.padding = '5px';
            
            const qualities = [
                {value: 32, text: 'Nízká (32)'},
                {value: 64, text: 'Střední (64)'},
                {value: 128, text: 'Vysoká (128)'},
                {value: 256, text: 'Ultra (256)'}
            ];
            
            qualities.forEach(quality => {
                const option = document.createElement('option');
                option.value = quality.value;
                option.textContent = quality.text;
                if (quality.value === 64) option.selected = true;
                qualitySelect.appendChild(option);
            });
            
            qualitySelect.onchange = function() {
                updatePhotoDomelity(parseInt(this.value));
            };
            
            controls.appendChild(qualitySelect);
        }
        
        // Funkce pro aktualizaci kvality PhotoDome
        function updatePhotoDomeQuality(resolution) {
            if (photoDome) {
                const currentTexture = photoDome.photoTexture;
                photoDome.dispose();
                
                showLoading('Aktualizace kvality...');
                
                setTimeout(() => {
                    photoDome = new BABYLON.PhotoDome(
                        'photoDome',
                        currentTexture.name,
                        {
                            resolution: resolution,
                            size: 1000,
                            useDirectMapping: false,
                            faceForward: false,
                            halfDomeMode: true
                        },
                        scene
                    );
                    
                    hideLoading();
                    console.log(`Kvalita aktualizována na: ${resolution}`);
                }, 100);
            }
        }
        
        // Performance monitoring
        function setupPerformanceMonitoring() {
            const perfDiv = document.createElement('div');
            perfDiv.id = 'performance';
            perfDiv.style.position = 'absolute';
            perfDiv.style.top = '10px';
            perfDiv.style.right = '10px';
            perfDiv.style.background = 'rgba(0,0,0,0.7)';
            perfDiv.style.color = 'white';
            perfDiv.style.padding = '10px';
            perfDiv.style.borderRadius = '5px';
            perfDiv.style.fontSize = '12px';
            perfDiv.style.minWidth = '120px';
            document.body.appendChild(perfDiv);
            

            setInterval(() => {
                if (engine && scene) {
                    const fps = Math.round(engine.getFps());
                    const renderTime = scene.getEngine().getDeltaTime();
                    const triangles = scene.getActiveMeshes().length;
                    
                    perfDiv.innerHTML = `
                        <div><strong>Performance:</strong></div>
                        <div>FPS: ${fps}</div>
                        <div>Delta: ${renderTime.toFixed(1)}ms</div>
                        <div>Meshes: ${triangles}</div>
                        <div>Memory: ${(performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 'N/A')}MB</div>
                    `;
                }
            }, 1000);
        }
        
        // Aktualizovaná inicializace
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Inicializace Stereo 180° VR Vieweru...');
            
            showLoading('Inicializace Babylon.js...');
            
            // Inicializace s timeout pro lepší UX
            setTimeout(() => {
                try {
                    initBabylon();
                    setupAdvancedCameraControls();
                    addMoreControls();
                    addAdvancedControls();
                    setupKeyboardControls();
                    checkVRSupport();
                    setupPerformanceMonitoring();
                    showDebugInfo();
                    
                    hideLoading();
                    
                    // Uvítací zpráva
                    console.log('✅ VR Viewer úspěšně inicializován!');
                    console.log('📱 Pro nejlepší zážitek použijte VR headset');
                    console.log('🖼️  Demo obrázek byl načten - můžete nahrát vlastní');
                    
                } catch (error) {
                    hideLoading();
                    console.error('❌ Chyba při inicializaci:', error);
                    
                    // Zobrazení error zprávy uživateli
                    const errorDiv = document.createElement('div');
                    errorDiv.style.position = 'fixed';
                    errorDiv.style.top = '50%';
                    errorDiv.style.left = '50%';
                    errorDiv.style.transform = 'translate(-50%, -50%)';
                    errorDiv.style.background = 'rgba(255,0,0,0.9)';
                    errorDiv.style.color = 'white';
                    errorDiv.style.padding = '20px';
                    errorDiv.style.borderRadius = '10px';
                    errorDiv.style.zIndex = '1000';
                    errorDiv.innerHTML = `
                        <h3>Chyba při načítání</h3>
                        <p>Nepodařilo se inicializovat VR viewer.</p>
                        <p>Zkuste obnovit stránku nebo použít jiný prohlížeč.</p>
                        <button onclick="location.reload()" style="margin-top: 10px;">Obnovit stránku</button>
                    `;
                    document.body.appendChild(errorDiv);
                }
            }, 500);
        });
        
        // Touch ovládání pro mobilní zařízení
        function setupTouchControls() {
            let touchStartX = 0;
            let touchStartY = 0;
            let rotating = false;
            
            const canvas = document.getElementById('renderCanvas');
            
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    rotating = true;
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (rotating && e.touches.length === 1) {
                    const deltaX = e.touches[0].clientX - touchStartX;
                    const deltaY = e.touches[0].clientY - touchStartY;
                    
                    // Rotace kamery na základě touch pohybu
                    camera.rotation.y += deltaX * 0.005;
                    camera.rotation.x += deltaY * 0.005;
                    
                    // Omezení vertikální rotace
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                    
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            });
            
            canvas.addEventListener('touchend', () => {
                rotating = false;
            });
            
            // Pinch-to-zoom pro mobily
            let initialDistance = 0;
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    initialDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (initialDistance > 0) {
                        const scale = distance / initialDistance;
                        camera.fov = Math.max(30 * Math.PI / 180, Math.min(120 * Math.PI / 180, camera.fov / scale));
                    }
                    initialDistance = distance;
                }
            });
        }
        
        // Přidání touch ovládání do inicializace
        function initBabylonEnhanced() {
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true, {
                antialias: true,
                stencil: true,
                preserveDrawingBuffer: true
            });
            
            scene = new BABYLON.Scene(engine);
            scene.actionManager = new BABYLON.ActionManager(scene);
            
            // Vytvoření kamery s lepším nastavením pro VR
            camera = new BABYLON.UniversalCamera('camera', new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControls(canvas, true);
            camera.setTarget(BABYLON.Vector3.Zero());
            
            // Touch ovládání
            setupTouchControls();
            
            createPhotoDome();
            
            const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;
            
            // Optimalizace pro VR
            scene.freezeActiveMeshes();
            engine.enableOfflineSupport = false;
            
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            window.addEventListener('resize', () => {
                engine.resize();
            });
        }
        
        // Aktualizace hlavní inicializační funkce
        function initBabylon() {
            initBabylonEnhanced();
        }
        
    </script>
</body>
</html>











                    
            
                
            
        
                
            
                            
    
