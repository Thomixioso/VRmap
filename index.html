<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Stereo Test - A-Frame - Meta Quest 3</title>
    
    <!-- A-Frame pro lep≈°√≠ VR podporu -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- Custom stereo komponenta -->
    <script>
        // Registrace custom stereo komponenty pro side-by-side obr√°zky
        AFRAME.registerComponent('stereo-sphere', {
            schema: {
                src: {type: 'string'},
                eye: {type: 'string', default: 'left'} // 'left' nebo 'right'
            },
            
            init: function () {
                const data = this.data;
                const el = this.el;
                
                // Vytvo≈ô sphere geometrii pro 180¬∞
                const geometry = new THREE.SphereGeometry(
                    10,    // radius
                    64,    // widthSegments 
                    32,    // heightSegments
                    0,     // phiStart - zaƒç√°tek horizont√°lnƒõ
                    Math.PI, // phiLength - 180¬∞ horizont√°lnƒõ  
                    0,     // thetaStart - zaƒç√°tek vertik√°lnƒõ
                    Math.PI  // thetaLength - 180¬∞ vertik√°lnƒõ (horn√≠ polovina)
                );
                
                // Otoƒçit geometrii dovnit≈ô
                geometry.scale(-1, 1, 1);
                
                // Upravit UV sou≈ôadnice pro stereo
                const uvs = geometry.attributes.uv.array;
                const uvCount = uvs.length / 2;
                
                for (let i = 0; i < uvCount; i++) {
                    const u = uvs[i * 2];
                    const v = uvs[i * 2 + 1];
                    
                    if (data.eye === 'left') {
                        // Lev√© oko - lev√° polovina obr√°zku (u: 0-0.5)
                        uvs[i * 2] = u * 0.5;
                    } else {
                        // Prav√© oko - prav√° polovina obr√°zku (u: 0.5-1.0)
                        uvs[i * 2] = u * 0.5 + 0.5;
                    }
                }
                
                // Aktualizovat UV sou≈ôadnice
                geometry.attributes.uv.needsUpdate = true;
                
                // Vytvo≈ôit materi√°l
                const loader = new THREE.TextureLoader();
                loader.load(data.src, (texture) => {
                    const material = new THREE.MeshBasicMaterial({
                        map: texture,
                        side: THREE.BackSide
                    });
                    
                    // Vytvo≈ôit mesh
                    const mesh = new THREE.Mesh(geometry, material);
                    
                    // Nastavit layer pro spr√°vn√© oko
                    if (data.eye === 'left') {
                        mesh.layers.set(1); // Lev√© oko
                    } else {
                        mesh.layers.set(2); // Prav√© oko
                    }
                    
                    // P≈ôidat do sc√©ny
                    el.setObject3D('mesh', mesh);
                    
                    console.log(`${data.eye} eye stereo sphere vytvo≈ôena`);
                });
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            z-index: 1000;
            font-size: 14px;
        }
        
        .controls {
            margin-top: 10px;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .debug {
            background: rgba(40, 40, 40, 0.9);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .success {
            color: #28a745;
        }
        
        .error {
            color: #dc3545;
        }
        
        .info {
            color: #17a2b8;
        }
        
        /* Skr√Ωt A-Frame UI v norm√°ln√≠m re≈æimu */
        .a-enter-vr {
            bottom: 20px !important;
            right: 20px !important;
        }
    </style>
</head>
<body>
    <div class="ui-overlay" id="uiOverlay">
        <h3>ü•Ω VR Stereo Test - A-Frame - Meta Quest 3</h3>
        <div class="info">
            <strong>Instrukce:</strong><br>
            1. Kliknƒõte "Naƒç√≠st VR sc√©nu"<br>
            2. Pou≈æijte VR tlaƒç√≠tko v prav√©m doln√≠m rohu<br>
            3. Nebo kliknƒõte "Auto VR" pro automatick√Ω start
        </div>
        
        <div class="controls">
            <button class="button" onclick="loadVRScene()">üì∑ Naƒç√≠st VR sc√©nu</button>
            <button class="button" onclick="autoEnterVR()" id="autoVrBtn">üöÄ Auto VR</button>
            <button class="button" onclick="testImagePath()">üîç Test cesty k obr√°zku</button>
            <button class="button" onclick="toggleUI()">üëÅÔ∏è Skr√Ωt/Zobrazit UI</button>
        </div>
        
        <div id="debugOutput" class="debug"></div>
    </div>

            <!-- A-Frame VR sc√©na -->
    <a-scene 
        id="vrScene" 
        embedded 
        style="height: 100vh; width: 100%;"
        vr-mode-ui="enabled: true"
        device-orientation-permission-ui="enabled: false">
        
        <!-- Z√°kladn√≠ nastaven√≠ -->
        <a-assets>
            <img id="stereoImage" src="Castles/generated/Le_Castillet_generated.jpg">
        </a-assets>
        
        <!-- VR prost≈ôed√≠ pro 180¬∞ stereo -->
        <!-- Lev√© oko - lev√° polovina obr√°zku -->
        <a-entity 
            id="leftEye"
            stereo-sphere="src: #stereoImage; eye: left">
        </a-entity>
        
        <!-- Prav√© oko - prav√° polovina obr√°zku -->
        <a-entity 
            id="rightEye"
            stereo-sphere="src: #stereoImage; eye: right">
        </a-entity>
        
        <!-- Kamera s ovl√°d√°n√≠m -->
        <a-entity 
            id="cameraRig" 
            position="0 1.6 0">
            <a-camera 
                id="camera"
                look-controls="enabled: true; touchEnabled: true"
                wasd-controls="enabled: false">
                <!-- Explicitnƒõ povolit oba layers pro stereo -->
                <a-entity camera layers="1,2"></a-entity>
            </a-camera>
        </a-entity>
        
        <!-- Z√°kladn√≠ osvƒõtlen√≠ -->
        <a-light type="ambient" color="#404040"></a-light>
    </a-scene>

    <script>
        let sceneLoaded = false;
        let uiVisible = true;
        
        // Debug funkce
        function debugLog(message, type = 'info') {
            const debugDiv = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            debugDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }
        
        function loadVRScene() {
            debugLog('Naƒç√≠t√°m VR sc√©nu...', 'info');
            
            const scene = document.querySelector('#vrScene');
            const image = document.querySelector('#stereoImage');
            
            debugLog(`Cesta k obr√°zku: ${image.src}`, 'info');
            
            // P≈ôidat posluchaƒçe ud√°lost√≠ p≈ôed naƒçten√≠m
            image.addEventListener('load', function() {
                debugLog('‚úÖ Stereo obr√°zek naƒçten √∫spƒõ≈°nƒõ!', 'success');
                debugLog(`Rozmƒõry obr√°zku: ${image.naturalWidth}x${image.naturalHeight}`, 'info');
                sceneLoaded = true;
                
                // Auto-aktivovat VR tlaƒç√≠tko
                setTimeout(() => {
                    const vrButton = document.querySelector('.a-enter-vr');
                    if (vrButton) {
                        debugLog('‚úÖ A-Frame VR tlaƒç√≠tko je dostupn√©', 'success');
                        vrButton.style.display = 'block';
                    }
                }, 1000);
            });
            
            image.addEventListener('error', function(e) {
                debugLog('‚ùå CHYBA p≈ôi naƒç√≠t√°n√≠ obr√°zku!', 'error');
                debugLog(`Chyba: ${e.type}`, 'error');
                debugLog('Zkontrolujte cestu: Castles/generated/Le_Castillet_generated.jpg', 'error');
                
                // Zkusit alternativn√≠ cestu
                debugLog('Zkou≈°√≠m alternativn√≠ cestu...', 'info');
                setTimeout(() => {
                    image.src = './Castles/generated/Le_Castillet_generated.jpg';
                }, 1000);
            });
            
            // Vynutit naƒçten√≠, pokud u≈æ je cached
            if (image.complete && image.naturalWidth > 0) {
                debugLog('‚úÖ Obr√°zek ji≈æ v cache, naƒç√≠t√°m...', 'success');
                image.dispatchEvent(new Event('load'));
            } else {
                // Vynutit reload
                const currentSrc = image.src;
                image.src = '';
                image.src = currentSrc;
                debugLog('üîÑ Vynucuji reload obr√°zku...', 'info');
            }
            
            // Sledovat A-Frame eventy
            scene.addEventListener('loaded', () => {
                debugLog('‚úÖ A-Frame sc√©na naƒçtena', 'success');
            });
            
            scene.addEventListener('enter-vr', () => {
                debugLog('ü•Ω VSTUP DO VR RE≈ΩIMU!', 'success');
                toggleUI(false); // Skr√Ωt UI ve VR
            });
            
            scene.addEventListener('exit-vr', () => {
                debugLog('üëã V√Ωstup z VR re≈æimu', 'info');
                toggleUI(true); // Zobrazit UI po VR
            });
        }
        
        async function autoEnterVR() {
            debugLog('Pokou≈°√≠m se o automatick√Ω vstup do VR...', 'info');
            
            if (!sceneLoaded) {
                debugLog('‚ùå Nejd≈ô√≠ve naƒçtƒõte VR sc√©nu!', 'error');
                return;
            }
            
            try {
                const scene = document.querySelector('#vrScene');
                
                // Zkontrolovat WebXR podporu
                if (!navigator.xr) {
                    throw new Error('WebXR nen√≠ podporov√°no');
                }
                
                // Zkontrolovat VR session support
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!supported) {
                    throw new Error('Immersive VR nen√≠ podporov√°no na tomto za≈ô√≠zen√≠');
                }
                
                debugLog('‚úÖ WebXR je podporov√°no, spou≈°t√≠m VR...', 'success');
                
                // Pokusit se o automatick√Ω vstup
                if (scene.enterVR) {
                    await scene.enterVR();
                    debugLog('üöÄ Automatick√Ω vstup do VR √∫spƒõ≈°n√Ω!', 'success');
                } else {
                    // Fallback - simulovat klik na VR tlaƒç√≠tko
                    const vrButton = document.querySelector('.a-enter-vr');
                    if (vrButton) {
                        vrButton.click();
                        debugLog('üîÑ Simuluji klik na VR tlaƒç√≠tko...', 'info');
                    } else {
                        throw new Error('VR tlaƒç√≠tko nenalezeno');
                    }
                }
                
            } catch (error) {
                debugLog(`‚ùå Auto VR selhalo: ${error.message}`, 'error');
                debugLog('üí° Zkuste kliknout na VR tlaƒç√≠tko v prav√©m doln√≠m rohu', 'info');
            }
        }
        
        function testImagePath() {
            debugLog('üîç Testuji cesty k obr√°zku...', 'info');
            
            const testPaths = [
                'Castles/generated/Le_Castillet_generated.jpg',
                './Castles/generated/Le_Castillet_generated.jpg',
                '../Castles/generated/Le_Castillet_generated.jpg',
                'data/Castles/generated/Le_Castillet_generated.jpg'
            ];
            
            testPaths.forEach((path, index) => {
                const testImg = new Image();
                testImg.onload = () => {
                    debugLog(`‚úÖ FUNGUJE: ${path} (${testImg.width}x${testImg.height})`, 'success');
                    
                    // Pokud je to prvn√≠ funkƒçn√≠ cesta, pou≈æij ji
                    if (!sceneLoaded) {
                        debugLog(`üîÑ Pou≈æ√≠v√°m cestu: ${path}`, 'info');
                        document.querySelector('#stereoImage').src = path;
                        setTimeout(() => loadVRScene(), 500);
                    }
                };
                testImg.onerror = () => {
                    debugLog(`‚ùå NEFUNGUJE: ${path}`, 'error');
                };
                testImg.src = path;
            });
        }
        
        function toggleUI(force = null) {
            const overlay = document.getElementById('uiOverlay');
            if (force !== null) {
                uiVisible = force;
            } else {
                uiVisible = !uiVisible;
            }
            
            overlay.style.display = uiVisible ? 'block' : 'none';
            debugLog(`UI ${uiVisible ? 'zobrazeno' : 'skryto'}`, 'info');
        }
        
        // Inicializace p≈ôi naƒçten√≠
        window.addEventListener('load', () => {
            debugLog('üöÄ Str√°nka naƒçtena', 'success');
            debugLog(`User Agent: ${navigator.userAgent}`, 'info');
            debugLog(`A-Frame verze: ${AFRAME.version}`, 'info');
            
            // Zkontrolovat WebXR
            if (navigator.xr) {
                debugLog('‚úÖ WebXR je dostupn√Ω', 'success');
                navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                    if (supported) {
                        debugLog('‚úÖ Immersive VR je podporov√°no!', 'success');
                        debugLog('üí° Kliknƒõte "Naƒç√≠st VR sc√©nu" ‚Üí pak VR tlaƒç√≠tko vpravo dole', 'info');
            debugLog('üîç Stereo: Lev√© oko = lev√° polovina obr√°zku, Prav√© oko = prav√° polovina', 'info');
                    } else {
                        debugLog('‚ùå Immersive VR nen√≠ podporov√°no', 'error');
                    }
                });
            } else {
                debugLog('‚ùå WebXR nen√≠ dostupn√Ω', 'error');
            }
            
            // Auto-naƒçten√≠ sc√©ny po 2 sekund√°ch
            setTimeout(() => {
                debugLog('üîÑ Auto-naƒç√≠t√°m VR sc√©nu...', 'info');
                loadVRScene();
            }, 2000);
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            debugLog(`GLOB√ÅLN√ç CHYBA: ${event.message}`, 'error');
        });
        
        // Kl√°vesov√© zkratky
        document.addEventListener('keydown', (event) => {
            if (event.key === 'v' || event.key === 'V') {
                autoEnterVR();
            }
            if (event.key === 'u' || event.key === 'U') {
                toggleUI();
            }
        });
    </script>
</body>
</html>
