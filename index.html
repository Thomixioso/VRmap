<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Stereo Test - A-Frame Stereo - Meta Quest 3</title>
    
    <!-- A-Frame 1.7.0 (stejn√° verze jako v p≈ô√≠kladu) -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    
    <!-- Custom stereo komponenta inspirovan√° p≈ô√≠kladem -->
    <script>
        // Registrace stereo komponenty pro jednotliv√° oka
        AFRAME.registerComponent('stereo', {
            schema: {
                eye: {type: 'string', default: 'left'} // 'left' nebo 'right'
            },
            
            init: function () {
                const data = this.data;
                const el = this.el;
                
                // Nastavit layer podle oka
                if (data.eye === 'left') {
                    el.object3D.layers.set(1); // Layer pro lev√© oko
                } else if (data.eye === 'right') {
                    el.object3D.layers.set(2); // Layer pro prav√© oko
                }
                
                console.log(`Stereo ${data.eye} eye layer nastaven`);
            }
        });
        
        // Registrace stereocam komponenty pro kameru
        AFRAME.registerComponent('stereocam', {
            schema: {
                eye: {type: 'string', default: 'left'}
            },
            
            init: function () {
                const el = this.el;
                const camera = el.getObject3D('camera');
                
                if (camera) {
                    // Povolit renderov√°n√≠ obou layers
                    camera.layers.enable(1); // Lev√© oko
                    camera.layers.enable(2); // Prav√© oko
                    console.log('Stereocam - oba layers povoleny');
                }
            }
        });
        
        // Komponenta pro rozdƒõlen√≠ side-by-side obr√°zku
        AFRAME.registerComponent('stereo-material', {
            schema: {
                eye: {type: 'string', default: 'left'},
                src: {type: 'string'}
            },
            
            init: function () {
                const data = this.data;
                const el = this.el;
                
                // Poƒçkat na naƒçten√≠ materi√°lu
                el.addEventListener('materialtextureloaded', () => {
                    const material = el.getObject3D('mesh').material;
                    const texture = material.map;
                    
                    if (texture) {
                        // Upravit UV offset a repeat pro stereo
                        if (data.eye === 'left') {
                            // Lev√° polovina obr√°zku (0 - 0.5)
                            texture.offset.x = 0;
                            texture.repeat.x = 0.5;
                        } else {
                            // Prav√° polovina obr√°zku (0.5 - 1.0)  
                            texture.offset.x = 0.5;
                            texture.repeat.x = 0.5;
                        }
                        
                        texture.needsUpdate = true;
                        console.log(`${data.eye} eye UV mapping nastaven`);
                    }
                });
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            z-index: 1000;
            font-size: 14px;
        }
        
        .controls {
            margin-top: 10px;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button:hover {
            background: #0056b3;
        }
        
        .debug {
            background: rgba(40, 40, 40, 0.9);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="ui-overlay" id="uiOverlay">
        <h3>ü•Ω VR Stereo Test - A-Frame Stereo Komponenty</h3>
        <div class="info">
            <strong>Inspirov√°no A-Frame stereo p≈ô√≠kladem:</strong><br>
            Pou≈æ√≠v√° dvojit√© &lt;a-sky&gt; pro lev√© a prav√© oko s layer syst√©mem
        </div>
        
        <div class="controls">
            <button class="button" onclick="loadVRScene()">üì∑ Naƒç√≠st VR sc√©nu</button>
            <button class="button" onclick="autoEnterVR()" id="autoVrBtn">üöÄ Auto VR</button>
            <button class="button" onclick="testImagePath()">üîç Test cesty k obr√°zku</button>
            <button class="button" onclick="toggleUI()">üëÅÔ∏è Skr√Ωt/Zobrazit UI</button>
        </div>
        
        <div id="debugOutput" class="debug"></div>
    </div>

    <!-- A-Frame VR sc√©na s stereo komponentami -->
    <a-scene 
        id="vrScene" 
        antialias="true"
        embedded 
        style="height: 100vh; width: 100%;"
        vr-mode-ui="enabled: true">
        
        <!-- Assets -->
        <a-assets>
            <img id="stereoImage" src="Castles/generated/Le_Castillet_generated.jpg">
        </a-assets>
        
        <!-- Kamera s stereo podporou -->
        <a-entity 
            camera 
            look-controls 
            position="0 1.6 0" 
            stereocam="eye:left;">
        </a-entity>
        
        <!-- Sky sphere pro lev√© oko -->
        <a-sky 
            id="sky1" 
            src="#stereoImage" 
            stereo="eye:left"
            stereo-material="eye:left"
            geometry="primitive: sphere; radius: 10; thetaStart: 0; thetaLength: 180"
            material="side: back">
        </a-sky>
        
        <!-- Sky sphere pro prav√© oko -->
        <a-sky 
            id="sky2" 
            src="#stereoImage" 
            stereo="eye:right"
            stereo-material="eye:right" 
            geometry="primitive: sphere; radius: 10; thetaStart: 0; thetaLength: 180"
            material="side: back">
        </a-sky>
        
        <!-- Z√°kladn√≠ osvƒõtlen√≠ -->
        <a-light type="ambient" color="#404040"></a-light>
    </a-scene>

    <script>
        let sceneLoaded = false;
        let uiVisible = true;
        
        // Debug funkce
        function debugLog(message, type = 'info') {
            const debugDiv = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            debugDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }
        
        function loadVRScene() {
            debugLog('Naƒç√≠t√°m VR sc√©nu s dual-sky stereo...', 'info');
            
            const scene = document.querySelector('#vrScene');
            const image = document.querySelector('#stereoImage');
            
            debugLog(`Cesta k obr√°zku: ${image.src}`, 'info');
            
            // P≈ôidat posluchaƒçe ud√°lost√≠
            image.addEventListener('load', function() {
                debugLog('‚úÖ Stereo obr√°zek naƒçten √∫spƒõ≈°nƒõ!', 'success');
                debugLog(`Rozmƒõry obr√°zku: ${image.naturalWidth}x${image.naturalHeight}`, 'info');
                debugLog('üì± Side-by-side obr√°zek bude rozdƒõlen na lev√©/prav√© oko', 'info');
                sceneLoaded = true;
                
                // Auto-aktivovat VR tlaƒç√≠tko
                setTimeout(() => {
                    const vrButton = document.querySelector('.a-enter-vr');
                    if (vrButton) {
                        debugLog('‚úÖ A-Frame VR tlaƒç√≠tko je dostupn√©', 'success');
                        debugLog('ü•Ω Kliknƒõte na VR tlaƒç√≠tko pro stereo efekt!', 'info');
                    }
                }, 1000);
            });
            
            image.addEventListener('error', function(e) {
                debugLog('‚ùå CHYBA p≈ôi naƒç√≠t√°n√≠ obr√°zku!', 'error');
                debugLog(`Chyba: ${e.type}`, 'error');
                debugLog('Zkontrolujte cestu: Castles/generated/Le_Castillet_generated.jpg', 'error');
                
                // Zkusit alternativn√≠ cestu
                debugLog('Zkou≈°√≠m alternativn√≠ cestu...', 'info');
                setTimeout(() => {
                    image.src = './Castles/generated/Le_Castillet_generated.jpg';
                }, 1000);
            });
            
            // Vynutit naƒçten√≠, pokud u≈æ je cached
            if (image.complete && image.naturalWidth > 0) {
                debugLog('‚úÖ Obr√°zek ji≈æ v cache, naƒç√≠t√°m...', 'success');
                image.dispatchEvent(new Event('load'));
            } else {
                // Vynutit reload
                const currentSrc = image.src;
                image.src = '';
                image.src = currentSrc;
                debugLog('üîÑ Vynucuji reload obr√°zku...', 'info');
            }
            
            // Sledovat A-Frame eventy
            scene.addEventListener('loaded', () => {
                debugLog('‚úÖ A-Frame sc√©na naƒçtena', 'success');
            });
            
            scene.addEventListener('enter-vr', () => {
                debugLog('ü•Ω VSTUP DO VR RE≈ΩIMU - STEREO AKTIVN√ç!', 'success');
                toggleUI(false); // Skr√Ωt UI ve VR
            });
            
            scene.addEventListener('exit-vr', () => {
                debugLog('üëã V√Ωstup z VR re≈æimu', 'info');
                toggleUI(true); // Zobrazit UI po VR
            });
        }
        
        async function autoEnterVR() {
            debugLog('Pokou≈°√≠m se o automatick√Ω vstup do VR...', 'info');
            
            if (!sceneLoaded) {
                debugLog('‚ùå Nejd≈ô√≠ve naƒçtƒõte VR sc√©nu!', 'error');
                return;
            }
            
            try {
                const scene = document.querySelector('#vrScene');
                
                // Zkontrolovat WebXR podporu
                if (!navigator.xr) {
                    throw new Error('WebXR nen√≠ podporov√°no');
                }
                
                // Zkontrolovat VR session support
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!supported) {
                    throw new Error('Immersive VR nen√≠ podporov√°no na tomto za≈ô√≠zen√≠');
                }
                
                debugLog('‚úÖ WebXR je podporov√°no, spou≈°t√≠m VR...', 'success');
                
                // Pokusit se o automatick√Ω vstup
                if (scene.enterVR) {
                    await scene.enterVR();
                    debugLog('üöÄ Automatick√Ω vstup do VR √∫spƒõ≈°n√Ω!', 'success');
                } else {
                    // Fallback - simulovat klik na VR tlaƒç√≠tko
                    const vrButton = document.querySelector('.a-enter-vr');
                    if (vrButton) {
                        vrButton.click();
                        debugLog('üîÑ Simuluji klik na VR tlaƒç√≠tko...', 'info');
                    } else {
                        throw new Error('VR tlaƒç√≠tko nenalezeno');
                    }
                }
                
            } catch (error) {
                debugLog(`‚ùå Auto VR selhalo: ${error.message}`, 'error');
                debugLog('üí° Zkuste kliknout na VR tlaƒç√≠tko v prav√©m doln√≠m rohu', 'info');
            }
        }
        
        function testImagePath() {
            debugLog('üîç Testuji cesty k obr√°zku...', 'info');
            
            const testPaths = [
                'Castles/generated/Le_Castillet_generated.jpg',
                './Castles/generated/Le_Castillet_generated.jpg',
                '../Castles/generated/Le_Castillet_generated.jpg',
                'data/Castles/generated/Le_Castillet_generated.jpg'
            ];
            
            testPaths.forEach((path, index) => {
                const testImg = new Image();
                testImg.onload = () => {
                    debugLog(`‚úÖ FUNGUJE: ${path} (${testImg.width}x${testImg.height})`, 'success');
                    
                    // Pokud je to prvn√≠ funkƒçn√≠ cesta, pou≈æij ji
                    if (!sceneLoaded) {
                        debugLog(`üîÑ Pou≈æ√≠v√°m cestu: ${path}`, 'info');
                        document.querySelector('#stereoImage').src = path;
                        setTimeout(() => loadVRScene(), 500);
                    }
                };
                testImg.onerror = () => {
                    debugLog(`‚ùå NEFUNGUJE: ${path}`, 'error');
                };
                testImg.src = path;
            });
        }
        
        function toggleUI(force = null) {
            const overlay = document.getElementById('uiOverlay');
            if (force !== null) {
                uiVisible = force;
            } else {
                uiVisible = !uiVisible;
            }
            
            overlay.style.display = uiVisible ? 'block' : 'none';
            debugLog(`UI ${uiVisible ? 'zobrazeno' : 'skryto'}`, 'info');
        }
        
        // Inicializace p≈ôi naƒçten√≠
        window.addEventListener('load', () => {
            debugLog('üöÄ Str√°nka naƒçtena', 'success');
            debugLog(`A-Frame verze: ${AFRAME.version}`, 'info');
            debugLog('üîß Pou≈æ√≠v√°m dual-sky stereo p≈ô√≠stup z A-Frame p≈ô√≠kladu', 'info');
            
            // Zkontrolovat WebXR
            if (navigator.xr) {
                debugLog('‚úÖ WebXR je dostupn√Ω', 'success');
                navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                    if (supported) {
                        debugLog('‚úÖ Immersive VR je podporov√°no!', 'success');
                        debugLog('üí° Kliknƒõte "Naƒç√≠st VR sc√©nu" ‚Üí pak VR tlaƒç√≠tko vpravo dole', 'info');
                    } else {
                        debugLog('‚ùå Immersive VR nen√≠ podporov√°no', 'error');
                    }
                });
            } else {
                debugLog('‚ùå WebXR nen√≠ dostupn√Ω', 'error');
            }
            
            // Auto-naƒçten√≠ sc√©ny po 2 sekund√°ch
            setTimeout(() => {
                debugLog('üîÑ Auto-naƒç√≠t√°m VR sc√©nu...', 'info');
                loadVRScene();
            }, 2000);
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            debugLog(`GLOB√ÅLN√ç CHYBA: ${event.message}`, 'error');
        });
        
        // Kl√°vesov√© zkratky
        document.addEventListener('keydown', (event) => {
            if (event.key === 'v' || event.key === 'V') {
                autoEnterVR();
            }
            if (event.key === 'u' || event.key === 'U') {
                toggleUI();
            }
        });
    </script>
</body>
</html>
